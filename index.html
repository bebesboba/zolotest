<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZZZoloRUN - –£–±–µ–≥–∏ –æ—Ç –ò–≤–∞–Ω–∞ –ó–æ–ª–æ!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0015 0%, #1a0030 50%, #0a0015 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        /* loadingScreen.hidden –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è */

        #loadingScreen h1 {
            font-size: 64px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: loadingGradient 2s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes loadingGradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        #loadingBar {
            width: 300px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ff0066;
        }

        #loadingBarFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff0066, #ff6b6b, #feca57);
            transition: width 0.3s;
        }

        #loadingText {
            color: #888;
            margin-top: 20px;
            font-size: 16px;
        }

        body {
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0f;
        }

        body.in-menu, body.in-gameover, body.in-dev {
            cursor: default !important;
        }

        body.in-game {
            cursor: none !important;
        }

        #gameCanvas {
            display: block;
            background: #1a1a2e;
        }

        #menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #0a0015 0%, #1a0030 30%, #2a0050 60%, #0a0015 100%);
            background-size: 400% 400%;
            animation: menuBgMove 15s ease infinite;
            z-index: 1000;
            overflow: hidden;
        }

        @keyframes menuBgMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #menu::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(255, 0, 100, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0, 150, 255, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 50% 50%, rgba(150, 0, 255, 0.1) 0%, transparent 60%);
            animation: menuGlow 8s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes menuGlow {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        #menuParticles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .menu-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #fff 0%, rgba(255,100,200,0.8) 50%, transparent 100%);
            border-radius: 50%;
            animation: floatParticle 20s linear infinite;
            opacity: 0;
        }

        @keyframes floatParticle {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        #menu.hidden {
            display: none;
        }

        #menu h1 {
            font-size: 82px;
            font-weight: bold;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #ff6b6b);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGradient 4s linear infinite, titleFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 30px rgba(255, 107, 107, 0.8)) drop-shadow(0 0 60px rgba(254, 202, 87, 0.5));
            margin-bottom: 10px;
            position: relative;
            z-index: 10;
        }

        @keyframes titleGradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.02); }
        }

        #menu h2 {
            color: #ccc;
            margin-bottom: 30px;
            font-weight: normal;
            font-size: 22px;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
            animation: subtitlePulse 2s ease-in-out infinite;
            position: relative;
            z-index: 10;
        }

        @keyframes subtitlePulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .menu-zolo-preview {
            position: absolute;
            right: 10%;
            top: 50%;
            transform: translateY(-50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid #ff0066;
            box-shadow: 0 0 50px rgba(255, 0, 102, 0.6), 0 0 100px rgba(255, 0, 102, 0.3);
            animation: zoloPreviewFloat 4s ease-in-out infinite, zoloPreviewGlow 2s ease-in-out infinite;
        }

        @keyframes zoloPreviewFloat {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-60%) translateX(10px); }
        }

        @keyframes zoloPreviewGlow {
            0%, 100% { box-shadow: 0 0 50px rgba(255, 0, 102, 0.6), 0 0 100px rgba(255, 0, 102, 0.3); }
            50% { box-shadow: 0 0 80px rgba(255, 0, 102, 0.8), 0 0 150px rgba(255, 0, 102, 0.5); }
        }

        .menu-zolo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .menu-section {
            margin: 15px 0;
            text-align: center;
        }

        .menu-section h3 {
            color: #888;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .control-btns {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: 2px solid #444;
            background: rgba(255,255,255,0.05);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .control-btn.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .diff-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            max-width: 600px;
        }

        .diff-btn {
            padding: 15px 35px;
            font-size: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
        }

        .diff-btn[data-diff="easy"] {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .diff-btn[data-diff="medium"] {
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
            color: #333;
        }

        .diff-btn[data-diff="hard"] {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
        }

        .diff-btn[data-diff="nightmare"] {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .diff-btn[data-diff="impossible"] {
            background: linear-gradient(135deg, #2d3436, #636e72);
            color: #ff0066;
            border: 2px solid #ff0066;
            animation: impossibleGlow 1s ease-in-out infinite;
        }

        @keyframes impossibleGlow {
            0%, 100% { box-shadow: 0 0 10px #ff0066; }
            50% { box-shadow: 0 0 30px #ff0066, 0 0 50px #ff0066; }
        }

        .diff-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #soundBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s;
        }

        #soundBtn:hover {
            background: rgba(255,255,255,0.2);
        }

        #gameUI {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        #gameUI.visible {
            display: block !important;
        }

        #timer {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 28px;
            color: white;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        #score {
            position: absolute;
            top: 60px;
            left: 20px;
            font-size: 22px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        #combo {
            position: absolute;
            top: 100px;
            left: 20px;
            font-size: 20px;
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        #effects {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .effect-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            animation: effectPulse 0.5s ease-in-out infinite;
        }

        @keyframes effectPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #hotbar {
            position: fixed !important;
            bottom: 30px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            display: flex !important;
            gap: 15px;
            padding: 18px 30px;
            background: rgba(0, 0, 0, 0.95) !important;
            border-radius: 25px;
            border: 3px solid rgba(0, 212, 255, 0.6) !important;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 40px rgba(0, 212, 255, 0.4) !important;
            backdrop-filter: blur(15px);
            pointer-events: auto;
            z-index: 500 !important;
        }

        .hotbar-slot {
            width: 70px;
            height: 70px;
            border-radius: 18px;
            border: 3px solid #555;
            background: linear-gradient(180deg, rgba(70,70,100,0.95) 0%, rgba(35,35,60,0.95) 100%);
            color: white;
            font-size: 32px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .hotbar-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 100%);
            border-radius: 12px 12px 0 0;
            pointer-events: none;
        }

        .hotbar-slot:hover:not(.on-cooldown) {
            transform: translateY(-5px) scale(1.05);
            border-color: #00d4ff;
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .hotbar-slot.on-cooldown {
            filter: grayscale(50%);
            cursor: not-allowed;
        }

        .hotbar-slot.on-cooldown::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--cd-progress, 100%);
            background: rgba(0, 0, 0, 0.7);
            transition: height 0.1s linear;
        }

        .hotbar-slot .cd-text {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: bold;
            color: #ff6b6b;
            text-shadow: 0 0 8px #000, 0 0 3px #000;
            z-index: 5;
        }

        .hotbar-slot .key-hint {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .hotbar-slot .skill-icon {
            font-size: 30px;
            z-index: 2;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6));
        }

        .hotbar-slot .skill-name {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #888;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .hotbar-slot:hover .skill-name {
            opacity: 1;
        }

        .hotbar-slot[data-skill="dash"] { border-color: #f39c12; }
        .hotbar-slot[data-skill="dash"]:hover { box-shadow: 0 5px 20px rgba(243, 156, 18, 0.4); }
        
        .hotbar-slot[data-skill="smoke"] { border-color: #95a5a6; }
        .hotbar-slot[data-skill="smoke"]:hover { box-shadow: 0 5px 20px rgba(149, 165, 166, 0.4); }
        
        .hotbar-slot[data-skill="teleport"] { border-color: #9b59b6; }
        .hotbar-slot[data-skill="teleport"]:hover { box-shadow: 0 5px 20px rgba(155, 89, 182, 0.4); }
        
        .hotbar-slot[data-skill="timestop"] { border-color: #8e44ad; }
        .hotbar-slot[data-skill="timestop"]:hover { box-shadow: 0 5px 20px rgba(142, 68, 173, 0.4); }

        #skills {
            display: none;
        }

        .skill-btn {
            display: none;
        }

        #aiMode {
            position: absolute;
            bottom: 100px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            color: white;
            font-size: 14px;
        }

        #quests {
            position: absolute;
            top: 140px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .quest-item {
            padding: 8px 15px;
            background: rgba(0,0,0,0.6);
            border-radius: 8px;
            color: #aaa;
            font-size: 13px;
            border-left: 3px solid #666;
        }

        .quest-item.completed {
            color: #00ff88;
            border-left-color: #00ff88;
            text-decoration: line-through;
        }

        #gameOver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s;
        }

        #gameOver.show {
            opacity: 1;
            visibility: visible;
        }

        #gameOver h1 {
            font-size: 64px;
            color: #ff6b6b;
            margin-bottom: 20px;
        }

        #gameOver .stats {
            color: #aaa;
            font-size: 24px;
            margin-bottom: 40px;
            text-align: center;
            line-height: 1.8;
        }

        #gameOver .stats .highlight {
            color: #ffd700;
            font-weight: bold;
        }

        #gameOver .stats .new-record {
            color: #00ff88;
            animation: recordPulse 0.5s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .go-btns {
            display: flex;
            gap: 20px;
        }

        .go-btn {
            padding: 18px 45px;
            font-size: 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            pointer-events: auto;
            z-index: 10;
        }

        .go-btn.retry {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .go-btn.menu {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid #444;
        }

        .go-btn:hover {
            transform: scale(1.05);
        }

        #countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px;
            color: white;
            text-shadow: 0 0 50px rgba(255,255,255,0.8);
            z-index: 500;
            display: none;
            animation: countdownPop 0.5s ease-out;
        }

        @keyframes countdownPop {
            0% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(0.9); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        #eventOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #eventOverlay .event-text {
            font-size: 72px;
            color: white;
            text-shadow: 0 0 30px rgba(255,255,255,0.8);
            animation: eventTextPulse 0.5s ease-in-out infinite;
        }

        @keyframes eventTextPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #timeStopAura {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: inset 0 0 200px 100px rgba(138, 43, 226, 0.6);
        }

        #timeStopAura.active {
            opacity: 1;
        }

        #bossHealthBar {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 30px;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            border: 3px solid #ff6600;
            overflow: hidden;
            z-index: 300;
            display: none;
        }

        #bossHealthBar .fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            transition: width 0.3s;
        }

        #bossHealthBar .name {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 0 10px black;
        }

        #lockOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1500;
            cursor: pointer;
        }

        #lockOverlay h2 {
            color: white;
            font-size: 36px;
            margin-bottom: 20px;
        }

        #lockOverlay p {
            color: #888;
            font-size: 18px;
        }

        /* Dev Menu */
        #devMenu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-height: 80vh;
            background: rgba(20, 20, 30, 0.98);
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 25px;
            z-index: 3000;
            display: none;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.3);
        }

        #devMenu.show {
            display: block;
        }

        #devMenu h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            text-align: center;
        }

        #devMenu .dev-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        #devMenu .dev-section h3 {
            color: #888;
            margin-bottom: 12px;
            font-size: 14px;
        }

        #devMenu .dev-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dev-btn {
            padding: 10px 18px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            pointer-events: auto;
        }

        .dev-btn:hover {
            background: rgba(0, 212, 255, 0.4);
            transform: scale(1.05);
        }

        .dev-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: #ff4757;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            pointer-events: auto;
        }

        .dev-close:hover {
            background: #ff6b7a;
        }

        .dev-input {
            width: 80px;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
            margin-left: 10px;
            pointer-events: auto;
        }

        #devLog {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            color: #0f0;
        }

        /* –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å */
        #finalBossOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 250;
            transition: filter 5s;
        }

        #finalBossOverlay.grayscale {
            filter: grayscale(100%);
        }

        #finalBossLetters {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 20px;
            z-index: 50; /* –ù–ò–ñ–ï —á–µ–º canvas —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞ */
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none; /* –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ */
        }

        #finalBossLetters.show {
            opacity: 1;
        }

        .boss-letter {
            font-size: 120px;
            font-weight: bold;
            background: linear-gradient(90deg, #ff0000, #ff7700, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 800% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbowText 2s linear infinite, letterFloat 1.5s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
            filter: drop-shadow(0 0 20px rgba(255,0,102,0.8));
        }

        @keyframes rainbowText {
            0% { background-position: 0% 50%; }
            100% { background-position: 800% 50%; }
        }

        @keyframes letterFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .boss-letter:nth-child(1) { animation-delay: 0s, 0s; }
        .boss-letter:nth-child(2) { animation-delay: 0s, 0.2s; }
        .boss-letter:nth-child(3) { animation-delay: 0s, 0.4s; }
        .boss-letter:nth-child(4) { animation-delay: 0s, 0.6s; }

        #finalBossBar {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            height: 40px;
            background: rgba(0,0,0,0.9);
            border-radius: 20px;
            border: 4px solid #ff0066;
            overflow: hidden;
            z-index: 350;
            display: none;
            animation: glitchBar 0.1s infinite;
        }

        @keyframes glitchBar {
            0%, 90% { transform: translateX(-50%); }
            92% { transform: translateX(-50%) translateX(-3px); }
            94% { transform: translateX(-50%) translateX(3px); }
            96% { transform: translateX(-50%) translateX(-2px); }
            98% { transform: translateX(-50%) translateX(2px); }
        }

        #finalBossBar .fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0066, #ff0000, #ff6600, #ff0066);
            background-size: 200% 100%;
            animation: bossBarGlow 1s linear infinite;
            width: 100%;
        }

        @keyframes bossBarGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        #finalBossBar .name {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 0 10px black, 0 0 20px #ff0066;
            letter-spacing: 3px;
        }

        #blueAura {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.5s;
            box-shadow: inset 0 0 200px 80px rgba(0, 100, 255, 0.6);
        }

        #blueAura.active {
            opacity: 1;
        }

        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 10px); }
            30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); }
            50% { transform: translate(-10px, 0); }
            60% { transform: translate(10px, 0); }
            70% { transform: translate(0, -10px); }
            80% { transform: translate(0, 10px); }
            90% { transform: translate(-5px, -5px); }
        }

        .shake {
            animation: screenShake 0.3s ease-in-out;
        }

        /* bossHint —É–¥–∞–ª—ë–Ω - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ bossInstructions */

        #bossInstructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateY(100px);
            background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(30,0,50,0.95) 100%);
            padding: 40px 60px;
            border-radius: 25px;
            color: white;
            font-size: 20px;
            z-index: 400;
            text-align: center;
            border: 3px solid #ff6600;
            box-shadow: 0 0 50px rgba(255, 100, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.8s ease-out;
        }

        #bossInstructions.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) translateY(0);
        }

        #bossInstructions.hide {
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, -50%) translateY(-100px);
        }

        #bossInstructions h2 {
            font-size: 36px;
            margin-bottom: 25px;
            color: #ff6600;
            text-shadow: 0 0 20px rgba(255, 100, 0, 0.8);
        }

        #bossInstructions p {
            margin: 12px 0;
            font-size: 22px;
            color: #ddd;
        }

        /* –¢–∞–π–º–µ—Ä –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ */
        #labyrinthTimer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 0 30px rgba(255, 0, 0, 0.8), 0 0 60px rgba(255, 0, 0, 0.5);
            z-index: 350;
            display: none;
            pointer-events: none;
            animation: timerPulse 1s ease-in-out infinite;
        }

        #labyrinthTimer.visible {
            display: block;
        }

        #labyrinthTimer.critical {
            color: #ff0000;
            animation: timerCritical 0.5s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        @keyframes timerCritical {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
        }
    </style>
</head>
<body class="in-menu">
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingScreen">
        <h1>üèÉ ZZZoloRUN</h1>
        <div id="loadingBar">
            <div id="loadingBarFill"></div>
        </div>
        <div id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</div>
    </div>

    <canvas id="gameCanvas"></canvas>
    
    <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å UI -->
    <div id="finalBossOverlay"></div>
    <div id="finalBossLetters">
        <span class="boss-letter">–ó</span>
        <span class="boss-letter">–û</span>
        <span class="boss-letter">–õ</span>
        <span class="boss-letter">–û</span>
    </div>
    <div id="finalBossBar">
        <div class="fill"></div>
        <div class="name">–ò–í–ê–ù –ó–û–õ–û</div>
    </div>
    <div id="blueAura"></div>
    
    <div id="menu">
        <div id="menuParticles"></div>
        <div class="menu-zolo-preview">
            <img src="https://media1.tenor.com/m/BXFq2lTughMAAAAC/–∏–≤–∞–Ω-–∑–æ–ª–æ.gif" alt="–ò–≤–∞–Ω –ó–æ–ª–æ">
        </div>
        <h1>üèÉ ZZZoloRUN</h1>
        <h2>–£–±–µ–≥–∏ –æ—Ç –ò–≤–∞–Ω–∞ –ó–æ–ª–æ!</h2>
        
        <div class="menu-section">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="control-btns">
                <button class="control-btn active" id="ctrlCursor">üñ±Ô∏è –ö—É—Ä—Å–æ—Ä</button>
                <button class="control-btn" id="ctrlWASD">‚å®Ô∏è WASD</button>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</h3>
            <div class="diff-btns">
                <button class="diff-btn" data-diff="easy">–õ—ë–≥–∫–∏–π</button>
                <button class="diff-btn" data-diff="medium">–°—Ä–µ–¥–Ω–∏–π</button>
                <button class="diff-btn" data-diff="hard">–°–ª–æ–∂–Ω—ã–π</button>
                <button class="diff-btn" data-diff="nightmare">–ö–æ—à–º–∞—Ä</button>
                <button class="diff-btn" data-diff="impossible">–ù–µ–≤–æ–∑–º–æ–∂–Ω—ã–π</button>
            </div>
        </div>
        
        <p style="color: #888; margin-top: 30px; font-size: 14px; text-shadow: 0 0 10px rgba(255,255,255,0.2); position: relative; z-index: 10;">–ù–∞–∂–º–∏ P –¥–ª—è Dev Menu</p>
    </div>
    
    <script>
        // –°–æ–∑–¥–∞—ë–º —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è –º–µ–Ω—é
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('menuParticles');
            if (container) {
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'menu-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.width = (Math.random() * 6 + 2) + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 15) + 's';
                    container.appendChild(particle);
                }
            }
        });
    </script>
    
    <button id="soundBtn">üîä –ó–≤—É–∫: –í–ö–õ</button>
    
    <div id="gameUI">
        <div id="timer">‚è±Ô∏è 0.0s</div>
        <div id="score">üí∞ 0</div>
        <div id="combo"></div>
        <div id="effects"></div>
        <div id="quests"></div>
        <div id="aiMode">ü§ñ AI: –ü–æ–≥–æ–Ω—è</div>
        
        <div id="hotbar">
            <div class="hotbar-slot" data-skill="dash" title="–†—ã–≤–æ–∫">
                <span class="skill-icon">‚ö°</span>
                <span class="key-hint">1</span>
                <span class="skill-name">–†—ã–≤–æ–∫</span>
            </div>
            <div class="hotbar-slot" data-skill="smoke" title="–î—ã–º–æ–≤–∞—è –∑–∞–≤–µ—Å–∞">
                <span class="skill-icon">üí®</span>
                <span class="key-hint">2</span>
                <span class="skill-name">–î—ã–º</span>
            </div>
            <div class="hotbar-slot" data-skill="teleport" title="–¢–µ–ª–µ–ø–æ—Ä—Ç">
                <span class="skill-icon">üåÄ</span>
                <span class="key-hint">3</span>
                <span class="skill-name">–¢–µ–ª–µ–ø–æ—Ä—Ç</span>
            </div>
            <div class="hotbar-slot" data-skill="timestop" title="–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏">
                <span class="skill-icon">üîÆ</span>
                <span class="key-hint">4</span>
                <span class="skill-name">ZA WARUDO</span>
            </div>
        </div>
    </div>
    
    <div id="countdown"></div>
    <div id="eventOverlay"></div>
    <div id="timeStopAura"></div>
    
    <div id="bossHealthBar">
        <div class="fill"></div>
        <div class="name">–¢–û–•–ê</div>
    </div>
    
    <!-- bossHint —É–¥–∞–ª—ë–Ω - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤ bossInstructions -->
    
    <div id="bossInstructions">
        <h2>‚öîÔ∏è –ë–û–°–°-–§–ê–ô–¢: –¢–û–•–ê ‚öîÔ∏è</h2>
        <p>ü•¶ –ü–æ–¥–±–∏—Ä–∞–π –∑–¥–æ—Ä–æ–≤—É—é –µ–¥—É –Ω–∞ –∞—Ä–µ–Ω–µ</p>
        <p>üéØ –ë—Ä–æ—Å–∞–π –≤ –¢–æ—Ö—É (–ü–†–û–ë–ï–õ / –õ–ö–ú)</p>
        <p>üí® –£–≤–æ—Ä–∞—á–∏–≤–∞–π—Å—è –æ—Ç –µ–≥–æ –∞—Ç–∞–∫!</p>
        <p>üçó –ë–µ—Ä–µ–≥–∏—Å—å –∫—Ä—ã–ª—ã—à–µ–∫ KFC!</p>
    </div>
    
    <!-- –¢–∞–π–º–µ—Ä –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ -->
    <div id="labyrinthTimer">‚è±Ô∏è 40</div>
    
    <div id="lockOverlay">
        <h2>üéÆ –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</h2>
        <p>–ö—É—Ä—Å–æ—Ä –±—É–¥–µ—Ç –∑–∞—Ö–≤–∞—á–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
    </div>
    
    <div id="gameOver">
        <h1>üíÄ –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h1>
        <div class="stats">
            <div>–í—Ä–µ–º—è: <span class="highlight" id="finalTime">0.0s</span></div>
            <div>–û—á–∫–∏: <span class="highlight" id="finalScore">0</span></div>
            <div>–†–µ–∫–æ—Ä–¥: <span id="finalRecord">0</span></div>
        </div>
        <div class="go-btns">
            <button class="go-btn retry" id="retryBtn">üîÑ –ï—â—ë —Ä–∞–∑</button>
            <button class="go-btn menu" id="menuBtn">üìã –í –º–µ–Ω—é</button>
        </div>
    </div>
    
    <div id="devMenu">
        <button class="dev-close" id="devClose">‚úï</button>
        <h2>üõ†Ô∏è Dev Menu</h2>
        
        <div class="dev-section">
            <h3>–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</h3>
            <div class="dev-btns">
                <button class="dev-btn" id="devDash">‚ö° –†—ã–≤–æ–∫</button>
                <button class="dev-btn" id="devSmoke">üí® –î—ã–º</button>
                <button class="dev-btn" id="devTeleport">üåÄ –¢–µ–ª–µ–ø–æ—Ä—Ç</button>
                <button class="dev-btn" id="devTimestop">üîÆ ZA WARUDO</button>
            </div>
        </div>
        
        <div class="dev-section">
            <h3>–ò–≤–µ–Ω—Ç—ã</h3>
            <div class="dev-btns">
                <button class="dev-btn" id="devMellstroy">üé≠ Mellstroy</button>
                <button class="dev-btn" id="devZhiragedon">üçî –ñ–∏—Ä–∞–≥–µ–¥–æ–Ω</button>
                <button class="dev-btn" id="devFinalBoss">üëø –§–∏–Ω–∞–ª—å–Ω—ã–π –ë–æ—Å—Å</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="dev-btn" id="devSkipEvent">‚è≠Ô∏è –°–∫–∏–ø —Ç–µ–∫—É—â–µ–≥–æ –∏–≤–µ–Ω—Ç–∞</button>
            </div>
        </div>
        
        <div class="dev-section">
            <h3>–ë–æ–Ω—É—Å—ã</h3>
            <div class="dev-btns">
                <button class="dev-btn" id="devShield">üõ°Ô∏è +–©–∏—Ç</button>
                <button class="dev-btn" id="devSpeed">‚ö° +–°–∫–æ—Ä–æ—Å—Ç—å</button>
                <button class="dev-btn" id="devInvis">üëª +–ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å</button>
                <button class="dev-btn" id="devFreeze">‚ùÑÔ∏è +–ó–∞–º–æ—Ä–æ–∑–∫–∞</button>
                <button class="dev-btn" id="devCoins">üí∞ +100 –º–æ–Ω–µ—Ç</button>
            </div>
        </div>
        
        <div class="dev-section">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="dev-btns">
                <button class="dev-btn" id="devGodMode">üî± God Mode: OFF</button>
                <button class="dev-btn" id="devLowMode">üñ•Ô∏è Low Graphics: OFF</button>
            </div>
        </div>
        
        <div class="dev-section">
            <h3>–õ–æ–≥–∏</h3>
            <div id="devLog"></div>
        </div>
        
        <div class="dev-section" style="border: 1px solid #00ff88; background: rgba(0,255,136,0.1);">
            <h3 style="color: #00ff88;">‚úÖ –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
            <p style="color: #aaa; font-size: 12px; line-height: 1.6;">
                –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: <span style="color: #00ff88;">–í–ò–î–ù–ê</span><br>
                –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏: –†—ã–≤–æ–∫, –î—ã–º, –¢–µ–ª–µ–ø–æ—Ä—Ç, ZA WARUDO<br>
                –ö–∞—Ç—Å—Ü–µ–Ω—ã: –¢–µ–ª–µ–ø–æ—Ä—Ç (—Ä—É–∫–∏), –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–≤–æ–ª–Ω—ã)<br>
                –ò–≤–µ–Ω—Ç—ã: Mellstroy, –ñ–∏—Ä–∞–≥–µ–¥–æ–Ω (–¢–æ—Ö–∞ –±–æ—Å—Å)<br>
                –ë–æ–Ω—É—Å—ã: 8 —Ç–∏–ø–æ–≤<br>
                AI: 8+ —Ä–µ–∂–∏–º–æ–≤ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            </p>
        </div>
        
        <div class="dev-section" style="border: 1px solid #ff6b6b; background: rgba(255,107,107,0.1);">
            <h3 style="color: #ff6b6b;">üéÆ –ê—Ä–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∏</h3>
            <div class="dev-btns">
                <button class="dev-btn" id="devTestArena">üèüÔ∏è –û—Ç–∫—Ä—ã—Ç—å –∞—Ä–µ–Ω—É</button>
                <button class="dev-btn" id="devTestGif">üé¨ –¢–µ—Å—Ç GIF-—Å–∫–∏–Ω</button>
                <button class="dev-btn" id="devSpawnFood">ü•¶ –°–ø–∞–≤–Ω –µ–¥—ã</button>
                <button class="dev-btn" id="devSpawnWings">üçó –°–ø–∞–≤–Ω KFC</button>
            </div>
        </div>
        
        <div class="dev-section" style="border: 1px solid #ff00ff; background: rgba(255,0,255,0.1);">
            <h3 style="color: #ff00ff;">üëø –§–∏–Ω–∞–ª—å–Ω—ã–π –ë–æ—Å—Å - –î–µ–±–∞–≥</h3>
            <div class="dev-btns">
                <button class="dev-btn" id="devSkipCutscene">‚è≠Ô∏è –°–∫–∏–ø –∫–∞—Ç—Å—Ü–µ–Ω—ã</button>
                <button class="dev-btn" id="devBossStage1">üìç –°—Ç–∞–¥–∏—è 1</button>
                <button class="dev-btn" id="devBossStage2">üî• –°—Ç–∞–¥–∏—è 2</button>
                <button class="dev-btn" id="devBossHP50">‚ù§Ô∏è HP = 50%</button>
                <button class="dev-btn" id="devBossHP25">üíî HP = 25%</button>
            </div>
            <div style="margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 5px;">
                <label style="color: #aaa; font-size: 12px;">–ê—Ç–∞–∫–∏ —Å—Ç–∞–¥–∏–∏ 1:</label>
                <div class="dev-btns">
                    <button class="dev-btn" id="devBossAttack1">üöÄ –†–∞–∫–µ—Ç—ã</button>
                    <button class="dev-btn" id="devBossAttack2">üë¥ –ë–∞—Ç—è</button>
                    <button class="dev-btn" id="devBossAttack3">üîä –î–∏–Ω–∞–º–∏–∫–∏</button>
                </div>
            </div>
            <div style="margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 5px;">
                <label style="color: #aaa; font-size: 12px;">–ê—Ç–∞–∫–∏ —Å—Ç–∞–¥–∏–∏ 2:</label>
                <div class="dev-btns">
                    <button class="dev-btn" id="devBossAttack4">üî• –°—Ñ–µ—Ä—ã</button>
                    <button class="dev-btn" id="devBossAttackCar">üöó –ú–∞—à–∏–Ω–∞</button>
                    <button class="dev-btn" id="devBossAttackLabyrinth">üß± –õ–∞–±–∏—Ä–∏–Ω—Ç</button>
                    <button class="dev-btn" id="devBossAttackFirePlatform">üêç –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞+–ó–º–µ–∏</button>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label style="color: #aaa; font-size: 12px;">GIF –°–∫–∏–Ω –ò–≤–∞–Ω–∞ (150%):</label>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button class="dev-btn" id="devGifOn">GIF: –í–ö–õ</button>
                    <button class="dev-btn" id="devGifOff">GIF: –í–´–ö–õ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –¢–µ—Å—Ç–æ–≤–∞—è –∞—Ä–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∏ -->
    <div id="testArena" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 4000;">
        <canvas id="testCanvas" style="display: block;"></canvas>
        <div style="position: absolute; top: 20px; left: 20px; color: white; font-size: 14px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px;">
            <h3 style="color: #ff6b6b; margin-bottom: 10px;">üß™ –ê—Ä–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∏</h3>
            <p>‚Ä¢ GIF-—Å–∫–∏–Ω –ò–≤–∞–Ω–∞ (150% —Å–∫–æ—Ä–æ—Å—Ç—å)</p>
            <p>‚Ä¢ –ò–≤–∞–Ω –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∫ –∏–≥—Ä–æ–∫—É</p>
            <p>‚Ä¢ ESC - –≤—ã—Ö–æ–¥</p>
        </div>
        <button id="closeTestArena" style="position: absolute; top: 20px; right: 20px; padding: 15px 30px; background: #ff4757; border: none; color: white; border-radius: 10px; cursor: pointer; font-size: 16px;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        // ==================== –ó–í–£–ö–ò ====================
        const SOUNDS = {
            coin: 'https://www.myinstants.com/media/sounds/coin.mp3',
            powerup: 'https://www.myinstants.com/media/sounds/anime-wow-sound-effect.mp3',
            hit: 'https://www.myinstants.com/media/sounds/oof.mp3',
            gameOver: 'https://www.myinstants.com/media/sounds/sad-trombone.mp3',
            dash: 'https://www.myinstants.com/media/sounds/faaah.mp3',
            smoke: 'https://www.myinstants.com/media/sounds/puffhaaa.mp3',
            swoosh: 'https://www.myinstants.com/media/sounds/swoosh-sound-effects.mp3',
            pop: 'https://www.myinstants.com/media/sounds/3-finger-poppin-bootyhole.mp3',
            zaWarudo: 'https://www.myinstants.com/media/sounds/zawarudoooow_itLb4ne.mp3',
            countdown: 'https://www.myinstants.com/media/sounds/beep.mp3',
            countdownGo: 'https://www.myinstants.com/media/sounds/mlg-airhorn.mp3',
            eventStart: 'https://www.myinstants.com/media/sounds/dun_dun_dun.mp3',
            mellstroySvist: 'https://www.myinstants.com/media/sounds/mellstroy-svist.mp3',
            gokuAngry: 'https://www.myinstants.com/media/sounds/goku-angry.mp3',
            mellstroyImbecile: 'https://www.myinstants.com/media/sounds/mellstroy-an-imbecile.mp3',
            tvoiuMat: 'https://www.myinstants.com/media/sounds/tvoiu-mat.mp3',
            chaosMusic: 'https://www.myinstants.com/media/sounds/da-da-net-net.mp3',
            bigMac: 'https://www.myinstants.com/media/sounds/big-mac_5yXlsjf.mp3',
            metalPipe: 'https://www.myinstants.com/media/sounds/metal-pipe-falling-sound-effect.mp3',
            glassBreak: 'https://www.myinstants.com/media/sounds/glass-breaking-sound-effect_wLZSIYn.mp3',
            nukeBomb: 'https://www.myinstants.com/media/sounds/nuke-bomb.mp3',
            tranceMusic: 'https://www.myinstants.com/media/sounds/trance-music-for-racing-game_1.mp3',
            scream: 'https://www.myinstants.com/media/sounds/wilhelm-scream.mp3',
            // –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å
            zoloZapret: 'https://www.myinstants.com/media/sounds/ivanzolo-zapret.mp3',
            lobotomia: 'https://www.myinstants.com/media/sounds/ia-delaiu-lobotomiiu.mp3',
            undertaleHit: 'https://www.myinstants.com/media/sounds/undertale-heavy-hit.mp3',
            undertaleChaos: 'https://www.myinstants.com/media/sounds/undertale-chaos-saber_ep7pRzu.mp3',
            doomMusic: 'https://www.myinstants.com/media/sounds/doom-eternal-full.mp3',
            missileLock: 'https://www.myinstants.com/media/sounds/gta-online-missile-lock-sound.mp3',
            burp: 'https://www.myinstants.com/media/sounds/burp-meme.mp3',
            tohaPunch: 'https://www.myinstants.com/media/sounds/metal-pipe-falling-sound-effect.mp3',
            // –ö–∞–∫–∞—à–∫–∞ –¥–ª—è –±—Ä–æ—Å–∫–∞ –≤ –±–æ—Å—Å–∞
            poopSplat: 'https://www.myinstants.com/media/sounds/lancer-splat.mp3',
            // –ó–≤—É–∫–∏ —Å—Ç–∞–¥–∏–∏ 2 —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
            fireFlame: 'https://www.myinstants.com/media/sounds/fire-flame.mp3',
            doomWings: 'https://www.myinstants.com/media/sounds/can-i-get-a-hoya-doom-music.mp3',
            // –ê—Ç–∞–∫–∞ "–î–∏–Ω–∞–º–∏–∫–∏"
            whooshSfx: 'https://www.myinstants.com/media/sounds/whoosh-sfx.mp3',
            crashSpin: 'https://www.myinstants.com/media/sounds/crash-spin.mp3',
            baobabMusic: 'https://www.myinstants.com/media/sounds/baobab.mp3',
            // –ú—É–∑—ã–∫–∞ –¥–ª—è —Å—Ç–∞–¥–∏–π —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
            stage1Music: 'https://www.myinstants.com/media/sounds/unknown-background-music.mp3',
            stage2Music: 'https://www.myinstants.com/media/sounds/doom-eternal-full.mp3',
        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: stage1Music –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø–µ—Ä–≤–æ–π —Å—Ç–∞–¥–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
            stage3Music: 'https://www.myinstants.com/media/sounds/dubstep__-_one_two-o-mp3cut.mp3',
            // –ê—Ç–∞–∫–∞ –æ–≥–Ω–µ–Ω–Ω—ã—Ö –∫—Ä—É–≥–æ–≤
            gasterBlaster: 'https://www.myinstants.com/media/sounds/gaster_blaster_sound_effect_1.mp3',
            
            // –ê—Ç–∞–∫–∞ –ú–∞—à–∏–Ω–∞
            carEngine: 'https://www.myinstants.com/media/sounds/car-engine.mp3',
            carMusic: 'https://www.myinstants.com/media/sounds/driving-in-my-car-asgore_RhVxJjP.mp3',
            carWarning: 'https://www.myinstants.com/media/sounds/enemy-encounter-undertale.mp3',
            
            // –ê—Ç–∞–∫–∞ –õ–∞–±–∏—Ä–∏–Ω—Ç
            evilLaugh: 'https://www.myinstants.com/media/sounds/muhehehehe.mp3',
            buildingPutaway: 'https://www.myinstants.com/media/sounds/building-putaway.mp3',
            legoConstruction: 'https://www.myinstants.com/media/sounds/lego-construction.mp3',
            hammerHd: 'https://www.myinstants.com/media/sounds/hammer-hd.mp3',
            godBell: 'https://www.myinstants.com/media/sounds/god-bell.mp3',
            
            // –ê—Ç–∞–∫–∞ –û–≥–Ω–µ–Ω–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
            platformAlert: 'https://www.myinstants.com/media/sounds/siren.mp3',
            firePlatformRise: 'https://www.myinstants.com/media/sounds/fire-flame.mp3',
            snakeHiss: 'https://www.myinstants.com/media/sounds/snake-hiss.mp3',
            snakeJump: 'https://www.myinstants.com/media/sounds/whoosh-sfx.mp3',
            fireHit: 'https://www.myinstants.com/media/sounds/fire-hit.mp3'
        };
        
        // –ë–∞—Ç—è –ò–≤–∞–Ω–∞
        const batyaImg = new Image();
        batyaImg.src = 'https://avatars.mds.yandex.net/i?id=7025f39621737a3b3f9058ea262cf18d61c20fa9-2411671-images-thumbs&n=13';
        
        // –°–∏—Å—Ç–µ–º–∞ –±–∞—Ç–∏
        let batyas = [];
        let batyaLasers = [];
        
        // –°–∏—Å—Ç–µ–º–∞ –¥–∏–Ω–∞–º–∏–∫–æ–≤
        let speakers = [];
        let musicNotes = [];
        
        // –°–∏—Å—Ç–µ–º–∞ –∫–∞–∫–∞—à–µ–∫ –¥–ª—è –±—Ä–æ—Å–∫–∞ –≤ –±–æ—Å—Å–∞
        let poops = []; // –ö–∞–∫–∞—à–∫–∏ –Ω–∞ –∞—Ä–µ–Ω–µ
        let thrownPoops = []; // –ë—Ä–æ—à–µ–Ω–Ω—ã–µ –∫–∞–∫–∞—à–∫–∏
        let speakerAttack = {
            active: false,
            phase: 0, // 0 - –¥–æ—Å—Ç–∞—ë—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω, 1 - –∫—Ä—É—Ç–∏—Ç, 2 - –ø–æ—ë—Ç, 3 - –¥–∏–Ω–∞–º–∏–∫–∏ –ø–∞–¥–∞—é—Ç, 4 - —Å—Ç—Ä–µ–ª—å–±–∞ –Ω–æ—Ç–∞–º–∏
            timer: 0,
            spinCount: 0,
            speakersSpawned: false,
            musicPlaying: false
        };
        let batyaAttack = {
            active: false,
            phase: 0, // 0 - –∫—É–ª–∞–∫, 1 - —Å–ø–∞–≤–Ω –±–∞—Ç–∏, 2 - –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏–µ, 3 - —Å—Ç—Ä–µ–ª—å–±–∞
            timer: 0,
            punchCount: 0,
            shotsTotal: 0,
            shotsFired: 0,
            doubleSpawn: false
        };
        
        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
        const evilZoloImg = new Image();
        evilZoloImg.crossOrigin = 'anonymous';
        evilZoloImg.src = 'https://avatars.mds.yandex.net/i?id=24021c0116cf1deb05c1ea09547226aee0a850b9-8486579-images-thumbs&n=13';
        
        const evilZoloGif = new Image();
        evilZoloGif.crossOrigin = 'anonymous';
        evilZoloGif.src = 'https://media1.tenor.com/m/1fLQcTk6aX4AAAAC/–∏–≤–∞–Ω-–∑–æ–ª–æ-–∏–≤–∞–Ω-–∑–æ–ª–æ-—Ç–∞–Ω–µ—Ü.gif';
        
        // –°–∫–∏–Ω –ò–≤–∞–Ω–∞ –ó–æ–ª–æ –∫–æ–≥–¥–∞ –æ–Ω –≥–æ–≤–æ—Ä–∏—Ç (—Ä–µ—á—å)
        const zoloSpeakingImg = new Image();
        zoloSpeakingImg.crossOrigin = 'anonymous';
        zoloSpeakingImg.src = 'https://avatars.mds.yandex.net/i?id=d9c94127750488ba174691010e75f1170182b4c5-5655706-images-thumbs&n=13';
        
        // –°–∫–∏–Ω –ò–≤–∞–Ω–∞ –¥–ª—è —Å—Ç–∞–¥–∏–∏ 2 (–ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –∫—Ä—ã–ª—å—è–º–∏)
        const zoloStage2ImgOriginal = new Image();
        zoloStage2ImgOriginal.crossOrigin = 'anonymous';
        zoloStage2ImgOriginal.src = 'https://avatars.mds.yandex.net/i?id=b3a78c6b900b0b4a2678475259f73cf8_l-4987773-images-thumbs&n=13';
        
        // –û–±—Ä–µ–∑–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —Å–∫–∏–Ω–∞
        let zoloStage2Img = new Image();
        zoloStage2ImgOriginal.onload = function() {
            cropImageToSquare(zoloStage2ImgOriginal, (img) => { zoloStage2Img = img; });
        };

        // –ú–∞—à–∏–Ω–∞ –¥–ª—è –∞—Ç–∞–∫–∏
        const carImg = new Image();
        carImg.crossOrigin = 'anonymous';
        carImg.src = 'https://i.ytimg.com/vi/0k5Pkgfli60/hqdefault.jpg?v=68ae6c8d';
        
        const audioCache = {};
        let soundEnabled = true;
        let currentMusic = null;
        
        function preloadSounds() {
            Object.keys(SOUNDS).forEach(key => {
                const audio = new Audio();
                audio.src = SOUNDS[key];
                audio.preload = 'auto';
                audioCache[key] = audio;
            });
        }
        
        function playSound(name, volume = 0.5) {
            if (!soundEnabled) return;
            try {
                const audio = new Audio(SOUNDS[name]);
                audio.volume = Math.min(1, Math.max(0, volume));
                audio.play().catch(() => {});
                return audio;
            } catch(e) {}
        }
        
        function playMusic(name, volume = 0.3, loop = true) {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic = null;
            }
            if (!soundEnabled) return;
            try {
                currentMusic = new Audio(SOUNDS[name]);
                currentMusic.volume = volume;
                currentMusic.loop = loop;
                currentMusic.play().catch(() => {});
                return currentMusic;
            } catch(e) {}
        }
        
        function stopMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic = null;
            }
        }
        
        preloadSounds();
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –†–ï–°–£–†–°–û–í (10 —Å–µ–∫—É–Ω–¥) ====================
        function loadAllResources() {
            const loadingBar = document.getElementById('loadingBarFill');
            const loadingText = document.getElementById('loadingText');
            const loadingScreen = document.getElementById('loadingScreen');
            
            // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤ —Ñ–æ–Ω–µ (–Ω–µ –∂–¥—ë–º)
            try {
                [zoloImgOriginal, zoloEmoteImgOriginal, mellstroyImg, tohaImg, zoloGifImg, evilZoloImg, evilZoloGif].forEach(img => {
                    if (img && img.src) img.src = img.src;
                });
                Object.values(SOUNDS).forEach(url => { new Audio(url); });
            } catch(e) {}
            
            // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                loadingBar.style.width = progress + '%';
                
                if (progress <= 30) loadingText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...';
                else if (progress <= 60) loadingText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤...';
                else if (progress <= 90) loadingText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–≥—Ä—ã...';
                else loadingText.textContent = '–ì–æ—Ç–æ–≤–æ!';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    // –ß–µ—Ä–µ–∑ 0.5 —Å–µ–∫ —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
                    setTimeout(() => {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                            showMenu();
                        }, 500);
                    }, 300);
                }
            }, 1000); // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadAllResources();
        
        // ==================== CANVAS ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ==================== –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ====================
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞
        function cropImageToSquare(img, callback) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            img.onload = () => {
                const size = Math.min(img.width, img.height);
                const offsetX = (img.width - size) / 2;
                const offsetY = (img.height - size) / 2;
                
                canvas.width = size;
                canvas.height = size;
                
                ctx.drawImage(img, offsetX, offsetY, size, size, 0, 0, size, size);
                
                const croppedImg = new Image();
                croppedImg.src = canvas.toDataURL();
                callback(croppedImg);
            };
            
            if (img.complete) {
                const size = Math.min(img.width, img.height);
                const offsetX = (img.width - size) / 2;
                const offsetY = (img.height - size) / 2;
                
                canvas.width = size;
                canvas.height = size;
                
                ctx.drawImage(img, offsetX, offsetY, size, size, 0, 0, size, size);
                
                const croppedImg = new Image();
                croppedImg.src = canvas.toDataURL();
                callback(croppedImg);
            }
        }
        
        let zoloImg = new Image();
        zoloImg.crossOrigin = 'anonymous';
        const zoloImgOriginal = new Image();
        zoloImgOriginal.crossOrigin = 'anonymous';
        zoloImgOriginal.src = 'https://sun1-27.userapi.com/eSw4J4PQgC5hOeT29AqkMs16zzNw581nrR-xKA/DXb1bDg7Atw.jpg';
        cropImageToSquare(zoloImgOriginal, (img) => { zoloImg = img; });
        
        let zoloEmoteImg = new Image();
        zoloEmoteImg.crossOrigin = 'anonymous';
        const zoloEmoteImgOriginal = new Image();
        zoloEmoteImgOriginal.crossOrigin = 'anonymous';
        zoloEmoteImgOriginal.src = 'https://i.ytimg.com/vi/t7SmVNeOAuA/maxresdefault.jpg';
        cropImageToSquare(zoloEmoteImgOriginal, (img) => { zoloEmoteImg = img; });
        
        const mellstroyImg = new Image();
        mellstroyImg.crossOrigin = 'anonymous';
        mellstroyImg.src = 'https://yt3.googleusercontent.com/4_bGObPhKIXRoPQCj26WfaYg5q6DXkvOGQuGit8EGgJh7EBF-VpmZ_ZhEKaPeJxeO4I6fIsV=s900-c-k-c0x00ffffff-no-rj';
        
        const tohaImg = new Image();
        tohaImg.crossOrigin = 'anonymous';
        tohaImg.src = 'https://i.ytimg.com/vi/SFBLUoJXBaA/hqdefault.jpg';
        
        // GIF-—Å–∫–∏–Ω –ò–≤–∞–Ω–∞ –ó–æ–ª–æ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        let useGifSkin = false;
        const zoloGifImg = new Image();
        zoloGifImg.crossOrigin = 'anonymous';
        zoloGifImg.src = 'https://media1.tenor.com/m/BXFq2lTughMAAAAC/–∏–≤–∞–Ω-–∑–æ–ª–æ.gif';
        
        // HTML —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ GIF (canvas –Ω–µ –∞–Ω–∏–º–∏—Ä—É–µ—Ç GIF)
        let zoloGifElement = null;
        function createGifElement() {
            if (zoloGifElement) return;
            zoloGifElement = document.createElement('img');
            zoloGifElement.src = 'https://media1.tenor.com/m/BXFq2lTughMAAAAC/–∏–≤–∞–Ω-–∑–æ–ª–æ.gif';
            zoloGifElement.style.cssText = 'position:fixed;width:80px;height:80px;border-radius:50%;object-fit:cover;pointer-events:none;z-index:999;display:none;border:3px solid #ff0066;box-shadow:0 0 20px #ff0066;';
            document.body.appendChild(zoloGifElement);
        }
        createGifElement();
        
        // ==================== –ö–û–ù–°–¢–ê–ù–¢–´ ====================
        const MAP_BOUNDS = {
            minX: 50,
            minY: 50,
            maxX: () => canvas.width - 50,
            maxY: () => canvas.height - 50
        };
        
        const DIFFICULTIES = {
            easy: { 
                speed: 3.5, // –£–≤–µ–ª–∏—á–µ–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
                aiChance: 0.2, 
                name: '–õ—ë–≥–∫–∏–π',
                rushChance: 0.08,
                interceptPower: 0.35,
                reactionDelay: 0.35,
                speedScale: 1.1,
                sinAmplitude: 20, // –ê–º–ø–ª–∏—Ç—É–¥–∞ —Å–∏–Ω—É—Å–æ–∏–¥—ã
                zigzagIntensity: 0.3, // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∑–∏–≥–∑–∞–≥–∞
                baitChance: 0.05, // –®–∞–Ω—Å –æ–±–º–∞–Ω–∫–∏
                tohaHpMultiplier: 0.5, // HP –¢–æ—Ö–∏ = 50% (–ª–µ–≥—á–µ –ø–æ–±–µ–¥–∏—Ç—å)
                mellstroySpeed: 8 // –°–∫–æ—Ä–æ—Å—Ç—å Mellstroy
            },
            medium: { 
                speed: 5.0, // –£–≤–µ–ª–∏—á–µ–Ω–∞
                aiChance: 0.5, 
                name: '–°—Ä–µ–¥–Ω–∏–π',
                rushChance: 0.18,
                interceptPower: 0.6,
                reactionDelay: 0.2,
                speedScale: 1.25,
                sinAmplitude: 35,
                zigzagIntensity: 0.5,
                baitChance: 0.12,
                tohaHpMultiplier: 0.75, // HP –¢–æ—Ö–∏ = 75%
                mellstroySpeed: 12
            },
            hard: { 
                speed: 6.5, // –£–≤–µ–ª–∏—á–µ–Ω–∞
                aiChance: 0.7, 
                name: '–°–ª–æ–∂–Ω—ã–π',
                rushChance: 0.28,
                interceptPower: 0.8,
                reactionDelay: 0.12,
                speedScale: 1.4,
                sinAmplitude: 50,
                zigzagIntensity: 0.7,
                baitChance: 0.2,
                tohaHpMultiplier: 1.0, // HP –¢–æ—Ö–∏ = 100%
                mellstroySpeed: 15
            },
            nightmare: { 
                speed: 8.0, // –£–≤–µ–ª–∏—á–µ–Ω–∞
                aiChance: 0.88, 
                name: '–ö–æ—à–º–∞—Ä',
                rushChance: 0.38,
                interceptPower: 0.95,
                reactionDelay: 0.06,
                speedScale: 1.6,
                sinAmplitude: 70,
                zigzagIntensity: 0.85,
                baitChance: 0.3,
                tohaHpMultiplier: 1.25, // HP –¢–æ—Ö–∏ = 125%
                mellstroySpeed: 20
            },
            impossible: { 
                speed: 10.0, // –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã–π - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º!
                aiChance: 0.98, 
                name: '–ù–µ–≤–æ–∑–º–æ–∂–Ω—ã–π',
                rushChance: 0.5,
                interceptPower: 1.0,
                reactionDelay: 0.02,
                speedScale: 2.0,
                sinAmplitude: 90,
                zigzagIntensity: 1.0,
                baitChance: 0.4,
                tohaHpMultiplier: 1.5, // HP –¢–æ—Ö–∏ = 150%
                mellstroySpeed: 25
            }
        };
        
        const SKILL_COOLDOWNS = {
            dash: 12,
            smoke: 25,
            teleport: 35,
            timestop: 60
        };
        
        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ====================
        let gameState = 'menu';
        let difficulty = 'medium';
        let controlType = 'cursor';
        let timer = 0;
        let score = 0;
        let combo = 0;
        let record = parseInt(localStorage.getItem('zzzolorun_record') || '0');
        let godMode = false;
        let lowGraphics = false;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —ç–º–æ–¥–∑–∏ –∏–ª–∏ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π —Ñ–∏–≥—É—Ä—ã –≤ low mode
        function renderIcon(ctx, emoji, x, y, size, color = null) {
            if (lowGraphics) {
                // –í low mode —Ä–∏—Å—É–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∏–≥—É—Ä—ã –≤–º–µ—Å—Ç–æ —ç–º–æ–¥–∑–∏
                const shapes = {
                    // –ò–≥—Ä–æ–∫ –∏ –≤—Ä–∞–≥–∏
                    'üòé': () => { ctx.beginPath(); ctx.arc(0, 0, size/2, 0, Math.PI * 2); ctx.fillStyle = color || '#00d4ff'; ctx.fill(); },
                    'üò±': () => { ctx.beginPath(); ctx.arc(0, 0, size/2, 0, Math.PI * 2); ctx.fillStyle = color || '#ff0066'; ctx.fill(); },
                    
                    // –ë–æ–Ω—É—Å—ã
                    'üêå': () => { ctx.fillStyle = color || '#888'; ctx.fillRect(-size/3, -size/3, size/1.5, size/1.5); },
                    'üõ°Ô∏è': () => { ctx.beginPath(); ctx.moveTo(0, -size/2); ctx.lineTo(size/3, 0); ctx.lineTo(0, size/2); ctx.lineTo(-size/3, 0); ctx.closePath(); ctx.fillStyle = color || '#4a90e2'; ctx.fill(); },
                    'üî¨': () => { ctx.fillStyle = color || '#9b59b6'; ctx.fillRect(-size/4, -size/4, size/2, size/2); },
                    '‚ö°': () => { ctx.beginPath(); ctx.moveTo(0, -size/2); ctx.lineTo(size/4, 0); ctx.lineTo(-size/4, 0); ctx.lineTo(0, size/2); ctx.closePath(); ctx.fillStyle = color || '#ffd700'; ctx.fill(); },
                    'üëª': () => { ctx.globalAlpha = 0.5; ctx.beginPath(); ctx.arc(0, 0, size/2, 0, Math.PI * 2); ctx.fillStyle = color || '#e0e0e0'; ctx.fill(); ctx.globalAlpha = 1; },
                    '‚ùÑÔ∏è': () => { ctx.strokeStyle = color || '#87ceeb'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0, -size/2); ctx.lineTo(0, size/2); ctx.moveTo(-size/2, 0); ctx.lineTo(size/2, 0); ctx.stroke(); },
                    'üß≤': () => { ctx.fillStyle = color || '#e74c3c'; ctx.fillRect(-size/3, -size/2, size/1.5, size); },
                    '‚ú®': () => { for(let i = 0; i < 4; i++) { ctx.save(); ctx.rotate(i * Math.PI/2); ctx.fillStyle = color || '#ffd700'; ctx.fillRect(-size/8, -size/2, size/4, size); ctx.restore(); } },
                    
                    // –ú–æ–Ω–µ—Ç—ã
                    'üí∞': () => { ctx.beginPath(); ctx.arc(0, 0, size/3, 0, Math.PI * 2); ctx.fillStyle = color || '#ffd700'; ctx.fill(); ctx.strokeStyle = '#ff8c00'; ctx.lineWidth = 2; ctx.stroke(); },
                    
                    // –ï–¥–∞
                    'ü•¶': () => { ctx.fillStyle = color || '#2ecc71'; ctx.fillRect(-size/3, -size/3, size/1.5, size/1.5); },
                    'ü•ï': () => { ctx.fillStyle = color || '#e67e22'; ctx.fillRect(-size/4, -size/2, size/2, size); },
                    'üçé': () => { ctx.beginPath(); ctx.arc(0, 0, size/2, 0, Math.PI * 2); ctx.fillStyle = color || '#e74c3c'; ctx.fill(); },
                    'ü•ó': () => { ctx.fillStyle = color || '#27ae60'; ctx.fillRect(-size/2, -size/3, size, size/1.5); },
                    'ü•í': () => { ctx.fillStyle = color || '#16a085'; ctx.fillRect(-size/4, -size/2, size/2, size); },
                    'üçá': () => { ctx.beginPath(); ctx.arc(0, 0, size/2, 0, Math.PI * 2); ctx.fillStyle = color || '#9b59b6'; ctx.fill(); },
                    'üçó': () => { ctx.fillStyle = color || '#d35400'; ctx.fillRect(-size/3, -size/3, size/1.5, size/1.5); },
                    'üçî': () => { ctx.fillStyle = color || '#e67e22'; ctx.fillRect(-size/2, -size/3, size, size/1.5); },
                    
                    // –ö–∞–∫–∞—à–∫–∞
                    'üí©': () => { ctx.fillStyle = color || '#8B4513'; ctx.fillRect(-size/3, -size/3, size/1.5, size/1.5); },
                    
                    // –ú–æ–ª–æ—Ç–æ–∫
                    'üî®': () => { ctx.fillStyle = color || '#7f8c8d'; ctx.fillRect(-size/4, -size/2, size/2, size); },
                    
                    // –ú–∏–∫—Ä–æ—Ñ–æ–Ω
                    'üé§': () => { ctx.fillStyle = color || '#00ffff'; ctx.fillRect(-size/4, -size/2, size/2, size); ctx.beginPath(); ctx.arc(0, -size/3, size/5, 0, Math.PI * 2); ctx.fill(); },
                    
                    // –ß–∞—Å—ã (–±–æ–Ω—É—Å –≤—Ä–µ–º–µ–Ω–∏ –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ)
                    '‚è∞': () => { ctx.beginPath(); ctx.arc(0, 0, size/2, 0, Math.PI * 2); ctx.strokeStyle = color || '#ffd700'; ctx.lineWidth = 3; ctx.stroke(); },
                    
                    // –í—ã—Ö–æ–¥
                    'üö™': () => { ctx.fillStyle = color || '#00ff00'; ctx.fillRect(-size/3, -size/2, size/1.5, size); },
                    
                    // –ù–æ—Ç—ã
                    '‚ô™': () => { ctx.fillStyle = color || '#e74c3c'; ctx.fillRect(-size/6, -size/2, size/3, size); },
                    '‚ô´': () => { ctx.fillStyle = color || '#e74c3c'; ctx.fillRect(-size/6, -size/2, size/3, size); },
                    '‚ô¨': () => { ctx.fillStyle = color || '#e74c3c'; ctx.fillRect(-size/6, -size/2, size/3, size); },
                    
                    // –†—É–∫–∏ –∏ –ø—Ä–æ—á–µ–µ
                    'ü§ö': () => { ctx.fillStyle = color || '#ffc0cb'; ctx.fillRect(-size/2, -size/3, size, size/1.5); },
                    '‚úã': () => { ctx.fillStyle = color || '#ffc0cb'; ctx.fillRect(-size/2, -size/3, size, size/1.5); },
                    'üëä': () => { ctx.fillStyle = color || '#ffc0cb'; ctx.fillRect(-size/3, -size/3, size/1.5, size/1.5); },
                    
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫—Ä—É–≥
                    'default': () => { ctx.beginPath(); ctx.arc(0, 0, size/2, 0, Math.PI * 2); ctx.fillStyle = color || '#ffffff'; ctx.fill(); }
                };
                
                ctx.save();
                ctx.translate(x, y);
                (shapes[emoji] || shapes['default'])();
                ctx.restore();
            } else {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - —Ä–∏—Å—É–µ–º —ç–º–æ–¥–∑–∏
                ctx.save();
                ctx.font = `${size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(emoji, x, y);
                ctx.restore();
            }
        }
        
        let mouseX = canvas.width / 2;
        let mouseY = canvas.height / 2;
        let keys = {};
        
        let pointerLocked = false;
        let pendingGameStart = false;
        let gamePaused = false;
        
        // –ò–≥—Ä–æ–∫
        let player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            targetX: canvas.width / 2,
            targetY: canvas.height / 2,
            radius: 20,
            speed: 10,
            velocityX: 0,
            velocityY: 0,
            shield: 0,
            effects: {},
            canMove: true
        };
        
        // –í—Ä–∞–≥
        let enemy = {
            x: 100,
            y: 100,
            radius: 30,
            speed: 3,
            baseSpeed: 3,
            aiMode: 'chase',
            aiTimer: 0,
            targetX: 0,
            targetY: 0,
            confused: false,
            confusedTimer: 0,
            useEmote: false,
            smoothX: 100,
            smoothY: 100,
            // –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –¥–∏–Ω–∞–º–∏—á–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            sinPhase: 0, // –§–∞–∑–∞ —Å–∏–Ω—É—Å–æ–∏–¥—ã
            zigzagPhase: 0, // –§–∞–∑–∞ –∑–∏–≥–∑–∞–≥–∞
            baitTimer: 0, // –¢–∞–π–º–µ—Ä –æ–±–º–∞–Ω–∫–∏
            baitDirection: null, // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–º–∞–Ω–∫–∏
            waitingForShield: false, // –ñ–¥—ë—Ç –∫–æ–≥–¥–∞ —â–∏—Ç –ø—Ä–æ–ø–∞–¥—ë—Ç
            panicMode: false, // –†–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏ (–∏–≥—Ä–æ–∫ —Å–æ —â–∏—Ç–æ–º)
            lastPlayerPos: { x: 0, y: 0 }, // –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–∞
            playerVelocity: { x: 0, y: 0 } // –°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä–æ–∫–∞
        };
        
        // –ö—É–ª–¥–∞—É–Ω—ã —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
        let skillCooldowns = {
            dash: 0,
            smoke: 0,
            teleport: 0,
            timestop: 0
        };
        
        // –ß–∞—Å—Ç–∏—Ü—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã
        let particles = [];
        let bgParticles = [];
        let powerups = [];
        let coins = [];
        let smokeParticles = [];
        let dashGhosts = [];
        let fallingRocks = [];
        
        // –ö–∞—Ç—Å—Ü–µ–Ω–∞
        let cutscene = {
            active: false,
            type: null,
            phase: 0,
            timer: 0,
            data: {}
        };
        
        // –ö–∞–º–µ—Ä–∞
        let camera = {
            x: 0,
            y: 0,
            zoom: 1,
            targetX: 0,
            targetY: 0,
            targetZoom: 1,
            shake: 0
        };
        
        // –ò–≤–µ–Ω—Ç—ã
        let eventSystem = {
            active: false,
            type: null,
            phase: 0,
            timer: 0,
            cooldown: 30,
            weights: { mellstroy: 1, zhiragedon: 1 },
            completedEvents: { mellstroy: 0, zhiragedon: 0 }, // –°—á—ë—Ç—á–∏–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –∏–≤–µ–Ω—Ç–æ–≤
            finalBossTriggered: false // –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å —É–∂–µ –Ω–∞—á–∞–ª—Å—è?
        };
        
        // –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å - –ó–ª–æ–π –ò–≤–∞–Ω –ó–æ–ª–æ
        let finalBoss = {
            active: false,
            phase: 0, // 0-–∫–∞—Ç—Å—Ü–µ–Ω–∞, 1-–±–æ–π —Å—Ç–∞–¥–∏—è 1, 2-–±–æ–π —Å—Ç–∞–¥–∏—è 2, 3-–±–æ–π —Å—Ç–∞–¥–∏—è 3
            timer: 0,
            x: 0,
            y: 0,
            radius: 50,
            health: 100,
            maxHealth: 100,
            isEvil: false, // –ü–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è –Ω–∞ –∑–ª–æ–π —Å–∫–∏–Ω?
            speaking: false, // –ì–æ–≤–æ—Ä–∏—Ç –ª–∏ —Å–µ–π—á–∞—Å?
            speakScale: 1, // –ú–∞—Å—à—Ç–∞–± –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ä–µ—á–∏
            grayscale: 0, // 0-1 –¥–ª—è —á—ë—Ä–Ω–æ-–±–µ–ª–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
            flashWhite: 0, // 0-1 –¥–ª—è –±–µ–ª–æ–π –≤—Å–ø—ã—à–∫–∏
            lettersShown: 0, // –°–∫–æ–ª—å–∫–æ –±—É–∫–≤ –ø–æ–∫–∞–∑–∞–Ω–æ (0-4)
            bossBarShown: false
        };
        
        // Mellstroy
        let mellstroys = [];
        
        // –¢–æ—Ö–∞ (–±–æ—Å—Å)
        let toha = {
            active: false,
            x: 0,
            y: 0,
            radius: 80,
            maxRadius: 80,
            minRadius: 5, // –°—Ö–ª–æ–ø—ã–≤–∞–µ—Ç—Å—è –¥–æ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞!
            health: 100,
            attackType: null,
            attackTimer: 0,
            velocityX: 0,
            velocityY: 0,
            falling: false,
            fallY: 0,
            rotation: 0,
            chargeDir: null,
            rollDir: null,
            defeated: false
        };
        
        // –ó–¥–æ—Ä–æ–≤–∞—è –µ–¥–∞ –¥–ª—è –±—Ä–æ—Å–∫–∞
        let healthyFood = [];
        let playerFood = null; // –ï–¥–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–µ—Å—ë—Ç –∏–≥—Ä–æ–∫
        let thrownFood = []; // –ë—Ä–æ—à–µ–Ω–Ω–∞—è –µ–¥–∞
        let kfcWings = []; // –ö—Ä—ã–ª—ã—à–∫–∏ KFC –æ—Ç –¢–æ—Ö–∏
        let bigMac = null; // –õ–µ—Ç—è—â–∏–π –±–∏–≥ –º–∞–∫
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function initBgParticles() {
            bgParticles = [];
            // Low mode: –º–∏–Ω–∏–º—É–º —á–∞—Å—Ç–∏—Ü –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const count = lowGraphics ? 10 : 80;
            for (let i = 0; i < count; i++) {
                bgParticles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: lowGraphics ? 2 : Math.random() * 3 + 1,
                    speed: lowGraphics ? 0.2 : Math.random() * 0.5 + 0.1,
                    color: lowGraphics ? '#ffffff' : `hsl(${Math.random() * 360}, 70%, 60%)`,
                    angle: Math.random() * Math.PI * 2
                });
            }
        }
        
        initBgParticles();
        
        // ==================== –ö–£–†–°–û–† –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
        document.addEventListener('mousemove', (e) => {
            if (gameState === 'menu' || gameState === 'gameover') {
                return;
            }
            
            if (pointerLocked && gameState === 'playing' && !cutscene.active) {
                player.targetX += e.movementX * 1.2;
                player.targetY += e.movementY * 1.2;
                
                player.targetX = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.targetX));
                player.targetY = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.targetY));
                
                mouseX = player.targetX;
                mouseY = player.targetY;
            }
        });
        
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            // –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
            if (gameState === 'playing' && !cutscene.active && !eventSystem.active) {
                if (e.key === '1') useSkill('dash');
                if (e.key === '2') useSkill('smoke');
                if (e.key === '3') useSkill('teleport');
                if (e.key === '4') useSkill('timestop');
            }
            
            // –ë—Ä–æ—Å–æ–∫ –µ–¥—ã –≤ –¢–æ—Ö—É (–ø—Ä–æ–±–µ–ª –∏–ª–∏ E)
            if (gameState === 'playing' && eventSystem.active && eventSystem.type === 'zhiragedon') {
                if (e.key === ' ' || e.key.toLowerCase() === 'e' || e.key === '—É') {
                    throwFoodAtToha();
                }
            }
            
            // –ë—Ä–æ—Å–æ–∫ –∫–∞–∫–∞—à–∫–∏ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞ (–ø—Ä–æ–±–µ–ª –∏–ª–∏ E) - –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø–∞—É–∑—É
            if (gameState === 'playing' && eventSystem.active && eventSystem.type === 'finalBoss') {
                if (e.key === ' ' || e.key.toLowerCase() === 'e' || e.key === '—É') {
                    throwPoopAtBoss();
                }
            }
            
            // Dev menu
            if (e.key.toLowerCase() === 'p' || e.key === '–∑') {
                toggleDevMenu();
            }
            
            // –†–∞–∑–ª–æ—á–∏—Ç—å –∫—É—Ä—Å–æ—Ä
            if (e.key.toLowerCase() === 'l' && gameState === 'playing') {
                document.exitPointerLock();
            }
        });
        
        // –ö–ª–∏–∫ –¥–ª—è –±—Ä–æ—Å–∫–∞ –µ–¥—ã –∏–ª–∏ –∫–∞–∫–∞—à–∫–∏
        document.addEventListener('click', () => {
            if (gameState === 'playing' && eventSystem.active && eventSystem.type === 'zhiragedon' && eventSystem.phase === 4) {
                throwFoodAtToha();
            }
            // –ë—Ä–æ—Å–æ–∫ –∫–∞–∫–∞—à–∫–∏ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞ - –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø–∞—É–∑—É
            if (gameState === 'playing' && eventSystem.active && eventSystem.type === 'finalBoss') {
                throwPoopAtBoss();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });
        
        // Pointer Lock
        document.addEventListener('pointerlockchange', () => {
            pointerLocked = document.pointerLockElement === canvas;
            
            if (pointerLocked && pendingGameStart) {
                pendingGameStart = false;
                document.getElementById('lockOverlay').style.display = 'none';
                actuallyStartGame();
            } else if (!pointerLocked && (gameState === 'playing' || gameState === 'countdown') && !gamePaused) {
                // –ü–∞—É–∑–∞ –ø—Ä–∏ —Ä–∞–∑–ª–æ—á–∫–µ –∫—É—Ä—Å–æ—Ä–∞ (–∏ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã –∏ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞)
                gamePaused = true;
                document.getElementById('lockOverlay').style.display = 'flex';
                document.getElementById('lockOverlay').querySelector('h2').textContent = '‚è∏Ô∏è –ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ';
                document.getElementById('lockOverlay').querySelector('p').textContent = '–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            } else if (pointerLocked && gamePaused && (gameState === 'playing' || gameState === 'countdown')) {
                gamePaused = false;
                document.getElementById('lockOverlay').style.display = 'none';
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ —á—Ç–æ–±—ã –ø–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ —É–ª–µ—Ç–∞–ª
                player.targetX = player.x;
                player.targetY = player.y;
                mouseX = player.x;
                mouseY = player.y;
            }
        });
        
        document.getElementById('lockOverlay').addEventListener('click', () => {
            if (gameState === 'playing' || gameState === 'countdown' || pendingGameStart) {
                canvas.requestPointerLock();
            }
        });
        
        // ==================== –ú–ï–ù–Æ –ò UI ====================
        function showMenu() {
            gameState = 'menu';
            document.body.className = 'in-menu';
            document.getElementById('menu').classList.remove('hidden');
            document.getElementById('gameUI').classList.remove('visible');
            document.getElementById('gameOver').classList.remove('show');
            document.getElementById('lockOverlay').style.display = 'none';
            stopMusic();
            pendingGameStart = false;
            gamePaused = false;
            // –°–∫—Ä—ã–≤–∞–µ–º GIF —ç–ª–µ–º–µ–Ω—Ç
            if (zoloGifElement) zoloGifElement.style.display = 'none';
        }
        
        function startGame(diff) {
            difficulty = diff;
            pendingGameStart = true;
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('lockOverlay').style.display = 'flex';
            document.getElementById('lockOverlay').querySelector('h2').textContent = 'üéÆ –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å';
            document.getElementById('lockOverlay').querySelector('p').textContent = '–ö—É—Ä—Å–æ—Ä –±—É–¥–µ—Ç –∑–∞—Ö–≤–∞—á–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è';
        }
        
        function actuallyStartGame() {
            gameState = 'countdown';
            document.body.className = 'in-game';
            document.getElementById('gameUI').classList.add('visible');
            
            // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –∞—Ä–µ–Ω—ã
            timer = 0;
            score = 0;
            combo = 0;
            particles = [];
            powerups = [];
            coins = [];
            smokeParticles = [];
            dashGhosts = [];
            fallingRocks = [];
            mellstroys = [];
            healthyFood = [];
            thrownFood = [];
            kfcWings = [];
            playerFood = null;
            bigMac = null;
            
            // –°–∫—Ä—ã–≤–∞–µ–º UI —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ç –ø—Ä–æ—à–ª–æ–π –∏–≥—Ä—ã
            document.getElementById('bossHealthBar').style.display = 'none';
            // bossHint —É–¥–∞–ª—ë–Ω
            document.getElementById('bossInstructions').classList.remove('show');
            document.getElementById('bossInstructions').classList.add('hide');
            document.getElementById('timeStopAura').classList.remove('active');
            
            const diff = DIFFICULTIES[difficulty];
            
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.targetX = player.x;
            player.targetY = player.y;
            player.velocityX = 0;
            player.velocityY = 0;
            player.shield = 0;
            player.effects = {};
            player.canMove = true;
            
            enemy.x = 100;
            enemy.y = 100;
            enemy.smoothX = 100;
            enemy.smoothY = 100;
            enemy.speed = diff.speed;
            enemy.baseSpeed = diff.speed;
            enemy.aiMode = 'chase';
            enemy.confused = false;
            enemy.useEmote = false;
            
            Object.keys(skillCooldowns).forEach(k => skillCooldowns[k] = 0);
            
            cutscene.active = false;
            eventSystem.active = false;
            eventSystem.cooldown = 30;
            eventSystem.weights = { mellstroy: 1, zhiragedon: 1 };
            eventSystem.completedEvents = { mellstroy: 0, zhiragedon: 0 };
            eventSystem.finalBossTriggered = false;
            
            // –°–±—Ä–æ—Å —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
            finalBoss.active = false;
            finalBoss.phase = 0;
            finalBoss.isEvil = false;
            finalBoss.speaking = false;
            finalBoss.flashWhite = 0;
            finalBoss.grayscale = 0;
            finalBoss.lettersShown = 0;
            finalBoss.bossBarShown = false;
            finalBoss.fightStarted = false;
            finalBoss.currentAttack = null;
            finalBoss.handsVisible = false;
            finalBoss.censoredMissiles = [];
            finalBoss.attackPaused = false;
            finalBoss.stageTransition = false;
            finalBoss.stage = 1;
            finalBoss.stage2AttackCount = 0;
            finalBoss.carAttackUsed = false;
            finalBoss.firePlatformAttackUsed = false;
            
            fireShards = [];
            
            // –°–±—Ä–æ—Å –º–∞—à–∏–Ω—ã
            carAttack.active = false;
            stopCarSounds();

            // –°–±—Ä–æ—Å –∫–∞–∫–∞—à–µ–∫
            poops = [];
            thrownPoops = [];
            playerPoop = null;
            
            // –°–±—Ä–æ—Å –±–∞—Ç–µ–π –∏ –ª–∞–∑–µ—Ä–æ–≤
            batyas = [];
            batyaLasers = [];
            document.getElementById('finalBossOverlay').style.filter = 'none';
            document.getElementById('finalBossLetters').classList.remove('show');
            document.getElementById('finalBossBar').style.display = 'none';
            document.getElementById('blueAura').classList.remove('active');
            document.querySelectorAll('.boss-letter').forEach(l => {
                l.style.opacity = '0';
                l.style.transform = 'scale(0)';
            });
            
            toha.active = false;
            
            camera.x = 0;
            camera.y = 0;
            camera.zoom = 1;
            camera.targetZoom = 1;
            
            startCountdown();
        }
        
        function startCountdown() {
            let count = 3;
            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';
            
            function tick() {
                if (count > 0) {
                    countdownEl.textContent = count;
                    countdownEl.style.animation = 'none';
                    countdownEl.offsetHeight;
                    countdownEl.style.animation = 'countdownPop 0.5s ease-out';
                    playSound('countdown', 0.5);
                    count--;
                    setTimeout(tick, 1000);
                } else {
                    countdownEl.textContent = '–ë–ï–ì–ò!';
                    countdownEl.style.color = '#00ff88';
                    playSound('countdownGo', 0.6);
                    setTimeout(() => {
                        countdownEl.style.display = 'none';
                        countdownEl.style.color = 'white';
                        gameState = 'playing';
                    }, 500);
                }
            }
            tick();
        }
        
        function gameOver() {
            if (godMode) return;
            
            gameState = 'gameover';
            document.body.className = 'in-gameover';
            
            document.exitPointerLock();
            
            // –°–∫—Ä—ã–≤–∞–µ–º GIF —ç–ª–µ–º–µ–Ω—Ç
            if (zoloGifElement) zoloGifElement.style.display = 'none';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –í–°–ï –∑–≤—É–∫–∏ —Ä–∞–∫–µ—Ç
            if (finalBoss.censoredMissiles) {
                finalBoss.censoredMissiles.forEach(missile => {
                    stopMissileSound(missile);
                });
                finalBoss.censoredMissiles = [];
            }
            
            // –û—á–∏—â–∞–µ–º –±–∞—Ç–µ–π –∏ –ª–∞–∑–µ—Ä—ã
            batyas = [];
            batyaLasers = [];
            
            // –û—á–∏—â–∞–µ–º –¥–∏–Ω–∞–º–∏–∫–∏ –∏ –Ω–æ—Ç—ã
            speakers = [];
            musicNotes = [];
            speakerAttack.active = false;
            speakerAttack.musicPlaying = false;
            
            // –û—á–∏—â–∞–µ–º –æ–≥–Ω–µ–Ω–Ω—ã–µ –∫—Ä—É–≥–∏
            fireCircles = [];
            fireShards = [];
            fireCircleAttack.active = false;

            // –û—á–∏—â–∞–µ–º –º–∞—à–∏–Ω—É
            carAttack.active = false;
            stopCarSounds();
            
            // –û—á–∏—â–∞–µ–º –∫–∞–∫–∞—à–∫–∏
            poops = [];
            thrownPoops = [];
            playerPoop = null;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
            finalBoss.active = false;
            finalBoss.currentAttack = null;
            finalBoss.handsVisible = false;
            
            playSound('gameOver', 0.5);
            stopMusic();
            
            const isNewRecord = timer > record;
            if (isNewRecord) {
                record = Math.floor(timer);
                localStorage.setItem('zzzolorun_record', record.toString());
            }
            
            document.getElementById('finalTime').textContent = timer.toFixed(1) + 's';
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalRecord').textContent = record + 's';
            
            if (isNewRecord) {
                document.getElementById('finalRecord').classList.add('new-record');
                document.getElementById('finalRecord').textContent = record + 's üéâ –ù–û–í–´–ô –†–ï–ö–û–†–î!';
            } else {
                document.getElementById('finalRecord').classList.remove('new-record');
            }
            
            document.getElementById('gameOver').classList.add('show');
            document.getElementById('lockOverlay').style.display = 'none';
        }
        
        // ==================== –°–ü–û–°–û–ë–ù–û–°–¢–ò ====================
        function useSkill(skill) {
            if (skillCooldowns[skill] > 0) return;
            if (cutscene.active) return;
            
            skillCooldowns[skill] = SKILL_COOLDOWNS[skill];
            
            switch(skill) {
                case 'dash':
                    useDash();
                    break;
                case 'smoke':
                    useSmoke();
                    break;
                case 'teleport':
                    useTeleport();
                    break;
                case 'timestop':
                    useTimestop();
                    break;
            }
            
            devLog(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${skill}`);
        }
        
        function useDash() {
            playSound('dash', 0.6);
            
            const dx = player.targetX - player.x;
            const dy = player.targetY - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if (dist > 0) {
                const dirX = dx / dist;
                const dirY = dy / dist;
                
                // –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–∑—Ä–∞–∫–æ–≤
                for (let i = 0; i < 8; i++) {
                    dashGhosts.push({
                        x: player.x + dirX * i * 20,
                        y: player.y + dirY * i * 20,
                        alpha: 1 - i * 0.1,
                        timer: 0.5
                    });
                }
                
                player.x += dirX * 200;
                player.y += dirY * 200;
                player.x = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.x));
                player.y = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.y));
                player.targetX = player.x;
                player.targetY = player.y;
            }
        }
        
        function useSmoke() {
            playSound('smoke', 0.6);
            
            // –°–æ–∑–¥–∞—ë–º –æ–±–ª–∞–∫–æ –¥—ã–º–∞
            for (let i = 0; i < 20; i++) {
                smokeParticles.push({
                    x: player.x + (Math.random() - 0.5) * 50,
                    y: player.y + (Math.random() - 0.5) * 50,
                    radius: Math.random() * 30 + 20,
                    alpha: 0.8,
                    timer: 3
                });
            }
            
            enemy.confused = true;
            enemy.confusedTimer = 5;
            enemy.aiMode = 'confused';
        }
        
        function useTeleport() {
            cutscene.active = true;
            cutscene.type = 'teleport';
            cutscene.phase = 0;
            cutscene.timer = 0;
            cutscene.data = {
                hand1Sound: false,
                hand2Sound: false
            };
            player.canMove = false;
            
            // –ù–∞—Ö–æ–¥–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ
            let newX, newY;
            let attempts = 0;
            do {
                newX = MAP_BOUNDS.minX + 100 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 200);
                newY = MAP_BOUNDS.minY + 100 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 200);
                const distToEnemy = Math.sqrt((newX - enemy.x)**2 + (newY - enemy.y)**2);
                attempts++;
                if (distToEnemy > 300 || attempts > 50) break;
            } while(true);
            
            cutscene.data.targetX = newX;
            cutscene.data.targetY = newY;
        }
        
        function useTimestop() {
            cutscene.active = true;
            cutscene.type = 'timestop';
            cutscene.phase = 0;
            cutscene.timer = 0;
            player.canMove = false;
            
            camera.targetZoom = 2.5;
            camera.targetX = player.x - canvas.width/2;
            camera.targetY = player.y - canvas.height/2;
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–¢–°–¶–ï–ù ====================
        function updateCutscene(dt) {
            cutscene.timer += dt;
            
            if (cutscene.type === 'teleport') {
                updateTeleportCutscene(dt);
            } else if (cutscene.type === 'timestop') {
                updateTimestopCutscene(dt);
            }
        }
        
        function updateTeleportCutscene(dt) {
            const t = cutscene.timer;
            
            if (cutscene.phase === 0) {
                // –ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                camera.targetZoom = 2.5;
                camera.targetX = player.x - canvas.width/2;
                camera.targetY = player.y - canvas.height/2;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä—É–∫
                if (!cutscene.data.handAngle) {
                    cutscene.data.handAngle = 0;
                    cutscene.data.handScale = 0;
                    cutscene.data.handSpread = 0;
                    cutscene.data.energyParticles = [];
                }
                
                if (t > 0.6) {
                    cutscene.phase = 1;
                    cutscene.timer = 0;
                }
            } else if (cutscene.phase === 1) {
                // –ü–æ—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏
                cutscene.data.handScale = Math.min(1, cutscene.data.handScale + dt * 3);
                
                if (t > 0.4 && !cutscene.data.hand1) {
                    if (!cutscene.data.hand1Sound) {
                        playSound('swoosh', 0.5);
                        cutscene.data.hand1Sound = true;
                    }
                    cutscene.data.hand1 = true;
                    cutscene.data.hand1Scale = 0;
                }
                
                if (cutscene.data.hand1) {
                    cutscene.data.hand1Scale = Math.min(1, (cutscene.data.hand1Scale || 0) + dt * 4);
                }
                
                if (t > 0.8 && !cutscene.data.hand2) {
                    if (!cutscene.data.hand2Sound) {
                        playSound('swoosh', 0.5);
                        cutscene.data.hand2Sound = true;
                    }
                    cutscene.data.hand2 = true;
                    cutscene.data.hand2Scale = 0;
                }
                
                if (cutscene.data.hand2) {
                    cutscene.data.hand2Scale = Math.min(1, (cutscene.data.hand2Scale || 0) + dt * 4);
                }
                
                if (t > 1.2) {
                    cutscene.phase = 2;
                    cutscene.timer = 0;
                }
            } else if (cutscene.phase === 2) {
                // –†–∞—Å–ø–∞–ª—å—Ü–æ–≤–∫–∞ - —Ä—É–∫–∏ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è –∏ —ç–Ω–µ—Ä–≥–∏—è –º–µ–∂–¥—É –Ω–∏–º–∏
                cutscene.data.handSpread = Math.min(80, cutscene.data.handSpread + dt * 150);
                cutscene.data.handAngle += dt * 2;
                
                // –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏—Ü—ã –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏
                if (Math.random() < 0.5) {
                    const offsetX = (Math.random() - 0.5) * cutscene.data.handSpread * 2;
                    cutscene.data.energyParticles.push({
                        x: offsetX,
                        y: (Math.random() - 0.5) * 40,
                        size: Math.random() * 4 + 2,
                        life: 0.5,
                        color: `hsl(${270 + Math.random() * 40}, 80%, 60%)`
                    });
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏—Ü—ã
                cutscene.data.energyParticles = cutscene.data.energyParticles.filter(p => {
                    p.life -= dt;
                    p.y += (Math.random() - 0.5) * 5;
                    return p.life > 0;
                });
                
                if (t > 0.8) {
                    cutscene.phase = 3;
                    cutscene.timer = 0;
                    
                    // –í–∑—Ä—ã–≤ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç
                    for (let i = 0; i < 30; i++) {
                        const angle = (i / 30) * Math.PI * 2;
                        particles.push({
                            x: player.x,
                            y: player.y,
                            vx: Math.cos(angle) * 12,
                            vy: Math.sin(angle) * 12,
                            radius: Math.random() * 6 + 3,
                            color: '#9b59b6',
                            alpha: 1,
                            life: 1
                        });
                    }
                    
                    // –¢–µ–ª–µ–ø–æ—Ä—Ç
                    player.x = cutscene.data.targetX;
                    player.y = cutscene.data.targetY;
                    player.targetX = player.x;
                    player.targetY = player.y;
                    mouseX = player.x;
                    mouseY = player.y;
                }
            } else if (cutscene.phase === 3) {
                // –ö–∞–º–µ—Ä–∞ –ª–µ—Ç–∏—Ç –∫ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
                camera.targetX = player.x - canvas.width/2;
                camera.targetY = player.y - canvas.height/2;
                
                if (t > 0.4) {
                    playSound('pop', 0.5);
                    cutscene.phase = 4;
                    cutscene.timer = 0;
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç –ø—É–∑—ã—Ä—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏
                    cutscene.data.bubbleRadius = 0;
                    cutscene.data.bubbleAlpha = 1;
                    
                    // –ß–∞—Å—Ç–∏—Ü—ã –ø–æ—è–≤–ª–µ–Ω–∏—è
                    for (let i = 0; i < 40; i++) {
                        const angle = (i / 40) * Math.PI * 2;
                        const speed = 5 + Math.random() * 8;
                        particles.push({
                            x: player.x,
                            y: player.y,
                            vx: Math.cos(angle) * speed,
                            vy: Math.sin(angle) * speed,
                            radius: Math.random() * 5 + 2,
                            color: `hsl(${200 + Math.random() * 40}, 80%, 60%)`,
                            alpha: 1,
                            life: 0.8
                        });
                    }
                }
            } else if (cutscene.phase === 4) {
                // –≠—Ñ—Ñ–µ–∫—Ç –ø—É–∑—ã—Ä—è –∏ –æ—Ç–¥–∞–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                cutscene.data.bubbleRadius += dt * 200;
                cutscene.data.bubbleAlpha = Math.max(0, cutscene.data.bubbleAlpha - dt * 2);
                
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                if (t > 0.6) {
                    cutscene.active = false;
                    player.canMove = true;
                }
            }
        }
        
        function updateTimestopCutscene(dt) {
            const t = cutscene.timer;
            
            if (cutscene.phase === 0) {
                // –ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
                if (t > 1.5) {
                    playSound('zaWarudo', 0.7);
                    cutscene.phase = 1;
                    cutscene.timer = 0;
                    cutscene.data.waves = [];
                    
                    // –°–æ–∑–¥–∞—ë–º –≤–æ–ª–Ω—ã
                    for (let i = 0; i < 5; i++) {
                        cutscene.data.waves.push({
                            radius: 0,
                            maxRadius: 500 + i * 100,
                            delay: i * 0.15
                        });
                    }
                }
            } else if (cutscene.phase === 1) {
                // ZA WARUDO —ç—Ñ—Ñ–µ–∫—Ç
                document.getElementById('timeStopAura').classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ–ª–Ω—ã
                if (cutscene.data.waves) {
                    cutscene.data.waves.forEach(wave => {
                        if (t > wave.delay) {
                            wave.radius += 15;
                        }
                    });
                }
                
                if (t > 2.5) {
                    cutscene.phase = 2;
                    cutscene.timer = 0;
                }
            } else if (cutscene.phase === 2) {
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∑–∞–º–æ—Ä–æ–∑–∫—É
                player.effects.freeze = 10;
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                if (t > 1) {
                    cutscene.active = false;
                    player.canMove = true;
                }
            }
        }
        
        // ==================== –ò–í–ï–ù–¢–´ ====================
        function updateEvents(dt) {
            if (eventSystem.active) return;
            
            eventSystem.cooldown -= dt;
            if (eventSystem.cooldown > 0) return;
            
            // –®–∞–Ω—Å –∏–≤–µ–Ω—Ç–∞ —Ä–∞—Å—Ç—ë—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
            const chance = Math.min(0.02 + timer * 0.0005, 0.1);
            if (Math.random() < chance * dt) {
                startRandomEvent();
            }
        }
        
        function startRandomEvent() {
            // –í—ã–±–∏—Ä–∞–µ–º –∏–≤–µ–Ω—Ç –ø–æ –≤–µ—Å–∞–º
            const totalWeight = eventSystem.weights.mellstroy + eventSystem.weights.zhiragedon;
            const roll = Math.random() * totalWeight;
            
            if (roll < eventSystem.weights.mellstroy) {
                startEvent('mellstroy');
            } else {
                startEvent('zhiragedon');
            }
        }
        
        function startEvent(type) {
            eventSystem.active = true;
            eventSystem.type = type;
            eventSystem.phase = 0;
            eventSystem.timer = 0;
            player.canMove = false;
            
            playSound('eventStart', 0.7);
            devLog(`–ù–∞—á–∞–ª—Å—è –∏–≤–µ–Ω—Ç: ${type}`);
            
            if (type === 'mellstroy') {
                enemy.useEmote = true;
                mellstroys = [];
            } else if (type === 'zhiragedon') {
                enemy.useEmote = true;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¢–æ—Ö—É –ø–æ–ª–Ω–æ—Å—Ç—å—é
                toha.active = false;
                toha.falling = false;
                toha.radius = 80; // –§–ò–ö–°: –°–±—Ä–æ—Å —Ä–∞–∑–º–µ—Ä–∞!
                toha.rotation = 0;
                toha.attackType = null;
                toha.attackTimer = 0;
                toha.attackHistory = [];
                toha.currentAttackTime = 0;
            }
        }
        
        function updateMellstroyEvent(dt) {
            eventSystem.timer += dt;
            const t = eventSystem.timer;
            
            // –§–∞–∑–∞ 0: DUN DUN DUN + –ó–æ–ª–æ –∏–¥—ë—Ç –≤ —Ü–µ–Ω—Ç—Ä
            if (eventSystem.phase === 0) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                enemy.x += (centerX - enemy.x) * 0.05;
                enemy.y += (centerY - enemy.y) * 0.05;
                
                camera.targetZoom = 1.5;
                camera.targetX = enemy.x - canvas.width/2;
                camera.targetY = enemy.y - canvas.height/2;
                
                if (t > 4) {
                    eventSystem.phase = 1;
                    eventSystem.timer = 0;
                    playSound('mellstroySvist', 0.6);
                }
            }
            // –§–∞–∑–∞ 1: –≠–º–æ—Ü–∏—è (—Å–≤–∏—Å—Ç)
            else if (eventSystem.phase === 1) {
                if (t > 6) {
                    eventSystem.phase = 2;
                    eventSystem.timer = 0;
                    playSound('gokuAngry', 0.6);
                }
            }
            // –§–∞–∑–∞ 2: –ö–∞–º–µ—Ä–∞ –Ω–∞ –∏–≥—Ä–æ–∫–∞
            else if (eventSystem.phase === 2) {
                camera.targetX = player.x - canvas.width/2;
                camera.targetY = player.y - canvas.height/2;
                
                if (t > 3) {
                    eventSystem.phase = 3;
                    eventSystem.timer = 0;
                    playSound('mellstroyImbecile', 0.6);
                    
                    // –°–æ–∑–¥–∞—ë–º Mellstroy
                    for (let i = 0; i < 3; i++) {
                        const side = i;
                        let x, y, vx, vy;
                        if (side === 0) { x = -50; y = canvas.height/2; vx = 5; vy = 0; }
                        else if (side === 1) { x = canvas.width + 50; y = canvas.height/2; vx = -5; vy = 0; }
                        else { x = canvas.width/2; y = -50; vx = 0; vy = 5; }
                        
                        mellstroys.push({ x, y, vx, vy, radius: 40, entering: true });
                    }
                }
            }
            // –§–∞–∑–∞ 3: Mellstroy –ø–æ—è–≤–ª—è—é—Ç—Å—è
            else if (eventSystem.phase === 3) {
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                mellstroys.forEach(m => {
                    if (m.entering) {
                        m.x += m.vx;
                        m.y += m.vy;
                        
                        if (m.x > 100 && m.x < canvas.width - 100 && 
                            m.y > 100 && m.y < canvas.height - 100) {
                            m.entering = false;
                        }
                    }
                });
                
                if (t > 3) {
                    eventSystem.phase = 4;
                    eventSystem.timer = 0;
                    playSound('tvoiuMat', 0.7);
                }
            }
            // –§–∞–∑–∞ 4: –¢–í–û–Æ –ú–ê–¢–¨
            else if (eventSystem.phase === 4) {
                if (t > 2) {
                    eventSystem.phase = 5;
                    eventSystem.timer = 0;
                    player.canMove = true;
                    playMusic('chaosMusic', 0.4);
                    
                    // Mellstroy –Ω–∞—á–∏–Ω–∞—é—Ç —Ö–∞–æ—Ç–∏—á–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è
                    mellstroys.forEach(m => {
                        const angle = Math.random() * Math.PI * 2;
                        m.vx = Math.cos(angle) * 12;
                        m.vy = Math.sin(angle) * 12;
                    });
                }
            }
            // –§–∞–∑–∞ 5: –•–ê–û–° (15 —Å–µ–∫—É–Ω–¥)
            else if (eventSystem.phase === 5) {
                updatePlayerMovement(dt);
                
                // –°–∫–æ—Ä–æ—Å—Ç—å Mellstroy –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                const diff = DIFFICULTIES[difficulty];
                const baseSpeed = diff.mellstroySpeed;
                let speed = baseSpeed;
                if (t > 3) speed = baseSpeed * 1.5;
                if (t > 7) speed = baseSpeed * 2;
                
                mellstroys.forEach(m => {
                    m.x += m.vx * dt * 60;
                    m.y += m.vy * dt * 60;
                    
                    // –û—Ç—Å–∫–æ–∫ –æ—Ç —Å—Ç–µ–Ω
                    if (m.x < MAP_BOUNDS.minX + m.radius) { m.x = MAP_BOUNDS.minX + m.radius; m.vx = Math.abs(m.vx); }
                    if (m.x > MAP_BOUNDS.maxX() - m.radius) { m.x = MAP_BOUNDS.maxX() - m.radius; m.vx = -Math.abs(m.vx); }
                    if (m.y < MAP_BOUNDS.minY + m.radius) { m.y = MAP_BOUNDS.minY + m.radius; m.vy = Math.abs(m.vy); }
                    if (m.y > MAP_BOUNDS.maxY() - m.radius) { m.y = MAP_BOUNDS.maxY() - m.radius; m.vy = -Math.abs(m.vy); }
                    
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
                    const len = Math.sqrt(m.vx*m.vx + m.vy*m.vy);
                    if (len > 0) {
                        m.vx = (m.vx / len) * speed;
                        m.vy = (m.vy / len) * speed;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
                    const dx = m.x - player.x;
                    const dy = m.y - player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < m.radius + player.radius) {
                        if (player.shield > 0) {
                            player.shield--;
                            playSound('hit', 0.5);
                            
                            // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞ –æ—Ç Mellstroy
                            const pushDist = 100;
                            const pushX = (player.x - m.x) / dist * pushDist;
                            const pushY = (player.y - m.y) / dist * pushDist;
                            player.x += pushX;
                            player.y += pushY;
                            player.x = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.x));
                            player.y = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.y));
                            player.targetX = player.x;
                            player.targetY = player.y;
                            
                            // –ß–∞—Å—Ç–∏—Ü—ã –æ—Ç —É–¥–∞—Ä–∞ —â–∏—Ç–∞
                            for (let p = 0; p < 15; p++) {
                                particles.push({
                                    x: player.x,
                                    y: player.y,
                                    vx: (Math.random() - 0.5) * 15,
                                    vy: (Math.random() - 0.5) * 15,
                                    radius: Math.random() * 5 + 2,
                                    color: '#ffd700',
                                    alpha: 1,
                                    life: 0.6
                                });
                            }
                        } else if (!godMode) {
                            gameOver();
                            return;
                        }
                    }
                });
                
                // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –º–µ–∂–¥—É Mellstroy
                for (let i = 0; i < mellstroys.length; i++) {
                    for (let j = i + 1; j < mellstroys.length; j++) {
                        const m1 = mellstroys[i];
                        const m2 = mellstroys[j];
                        const dx = m2.x - m1.x;
                        const dy = m2.y - m1.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        
                        if (dist < m1.radius + m2.radius) {
                            const nx = dx / dist;
                            const ny = dy / dist;
                            
                            const temp = { vx: m1.vx, vy: m1.vy };
                            m1.vx = m2.vx;
                            m1.vy = m2.vy;
                            m2.vx = temp.vx;
                            m2.vy = temp.vy;
                        }
                    }
                }
                
                if (t > 15) {
                    eventSystem.phase = 6;
                    eventSystem.timer = 0;
                    stopMusic();
                }
            }
            // –§–∞–∑–∞ 6: Mellstroy —É–ª–µ—Ç–∞—é—Ç
            else if (eventSystem.phase === 6) {
                mellstroys.forEach(m => {
                    m.y -= 15;
                });
                
                if (t > 2) {
                    endEvent();
                }
            }
        }
        
        function updateZhiragedonEvent(dt) {
            eventSystem.timer += dt;
            const t = eventSystem.timer;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–¥–∞—é—â–∏–µ –∫–∞–º–Ω–∏
            fallingRocks = fallingRocks.filter(rock => {
                rock.y += rock.vy;
                rock.vy += 0.5;
                rock.rotation += rock.rotSpeed;
                return rock.y < canvas.height + 50;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±—Ä–æ—à–µ–Ω–Ω—É—é –µ–¥—É
            updateThrownFood(dt);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—ã–ª—ã—à–∫–∏ KFC
            updateKfcWings(dt);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∏–≥ –º–∞–∫ - –ª–µ—Ç–∏—Ç –∏–∑ —Ä—É–∫ –ò–≤–∞–Ω–∞ –∫ —Ü–µ–Ω—Ç—Ä—É
            if (bigMac && bigMac.flying) {
                bigMac.x += bigMac.vx;
                bigMac.y += bigMac.vy;
                bigMac.rotation += 0.2;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞
                const dx = bigMac.targetX - bigMac.x;
                const dy = bigMac.targetY - bigMac.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 30) {
                    bigMac.x = bigMac.targetX;
                    bigMac.y = bigMac.targetY;
                    
                    // –ë–∏–≥ –º–∞–∫ –ø—Ä–∏–∑–µ–º–ª–∏–ª—Å—è - –∂–¥—ë–º –ø–µ—Ä–µ–¥ –ø–∞–¥–µ–Ω–∏–µ–º –¢–æ—Ö–∏
                    bigMac.flying = false;
                    bigMac.landed = true;
                    bigMac.waitTimer = 0; // –¢–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è
                    
                    // –ó–≤—É–∫ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏—è
                    playSound('hit', 0.4);
                    
                    // –ß–∞—Å—Ç–∏—Ü—ã –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏—è
                    for (let i = 0; i < 15; i++) {
                        particles.push({
                            x: bigMac.x,
                            y: bigMac.y,
                            vx: (Math.random() - 0.5) * 10,
                            vy: (Math.random() - 0.5) * 10,
                            radius: Math.random() * 5 + 2,
                            color: '#ff6600',
                            alpha: 1,
                            life: 0.6
                        });
                    }
                }
            }
            
            // –ë–∏–≥ –º–∞–∫ –ª–µ–∂–∏—Ç –Ω–∞ –∑–µ–º–ª–µ - –∂–¥—ë–º 1.5 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –ø–∞–¥–µ–Ω–∏–µ–º –¢–æ—Ö–∏
            if (bigMac && bigMac.landed && !bigMac.tohaSpawned) {
                bigMac.waitTimer += dt;
                
                // –ë–∏–≥ –º–∞–∫ –ø—É–ª—å—Å–∏—Ä—É–µ—Ç –ø–æ–∫–∞ –∂–¥—ë—Ç
                bigMac.pulse = (bigMac.pulse || 0) + dt * 5;
                
                if (bigMac.waitTimer > 1.5) {
                    bigMac.tohaSpawned = true;
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞–¥–µ–Ω–∏–µ –¢–æ—Ö–∏
                    eventSystem.phase = 2;
                    eventSystem.timer = 0;
                    
                    toha.x = canvas.width / 2;
                    toha.y = -100;
                    toha.radius = 80;
                    toha.maxRadius = 80;
                    toha.falling = true;
                    toha.fallY = canvas.height / 2;
                    toha.defeated = false;
                }
            }
            
            // –§–∞–∑–∞ 0: –ó–æ–ª–æ –ø–ª–∞–≤–Ω–æ –æ—Ç—Ö–æ–¥–∏—Ç –≤ –±–æ–∫
            if (eventSystem.phase === 0) {
                // –°–Ω–∞—á–∞–ª–∞ –∏–¥—ë—Ç –∫ —Ü–µ–Ω—Ç—Ä—É, –ø–æ—Ç–æ–º –æ—Ç—Ö–æ–¥–∏—Ç –≤–ª–µ–≤–æ
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                if (t < 1.5) {
                    // –ò–¥—ë—Ç –∫ —Ü–µ–Ω—Ç—Ä—É
                    enemy.x += (centerX - enemy.x) * 0.05;
                    enemy.y += (centerY - enemy.y) * 0.05;
                } else if (t < 3) {
                    // –ü–ª–∞–≤–Ω–æ –æ—Ç—Ö–æ–¥–∏—Ç –≤–ª–µ–≤–æ
                    const sideX = canvas.width / 4;
                    enemy.x += (sideX - enemy.x) * 0.03;
                }
                
                // –ó–æ–ª–æ –¥–µ—Ä–∂–∏—Ç –±–∏–≥ –º–∞–∫ –≤ —Ä—É–∫–∞—Ö (–≤–∏–∑—É–∞–ª—å–Ω–æ)
                enemy.holdingBigMac = true;
                
                camera.targetZoom = 1.3;
                camera.targetX = (enemy.x + centerX) / 2 - canvas.width/2;
                camera.targetY = (enemy.y + centerY) / 2 - canvas.height/2;
                
                if (t > 3) {
                    eventSystem.phase = 1;
                    eventSystem.timer = 0;
                    playSound('bigMac', 0.7);
                    
                    // –ó–æ–ª–æ –∫–∏–¥–∞–µ—Ç –±–∏–≥ –º–∞–∫ –ò–ó –†–£–ö –∫ —Ü–µ–Ω—Ç—Ä—É!
                    enemy.holdingBigMac = false;
                    
                    // –ë–∏–≥ –º–∞–∫ –ª–µ—Ç–∏—Ç –ò–ó —Ä—É–∫ –ò–≤–∞–Ω–∞ –∫ —Ü–µ–Ω—Ç—Ä—É
                    const targetX = canvas.width / 2;
                    const targetY = canvas.height / 2;
                    const dx = targetX - enemy.x;
                    const dy = targetY - enemy.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    bigMac = {
                        x: enemy.x + 50, // –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–∑ —Ä—É–∫ –ò–≤–∞–Ω–∞!
                        y: enemy.y - 25,
                        targetX: targetX,
                        targetY: targetY,
                        vx: (dx / dist) * 12, // –õ–µ—Ç–∏—Ç –∫ —Ü–µ–Ω—Ç—Ä—É
                        vy: (dy / dist) * 12,
                        rotation: 0,
                        scale: 1,
                        falling: false, // –ù–µ –ø–∞–¥–∞–µ—Ç, –∞ –õ–ï–¢–ò–¢
                        flying: true, // –õ–µ—Ç–∏—Ç –∫ —Ü–µ–Ω—Ç—Ä—É
                        landed: false
                    };
                }
            }
            // –§–∞–∑–∞ 1: –ë–∏–≥ –º–∞–∫ –ø–∞–¥–∞–µ—Ç, –ò–≤–∞–Ω —Å—Ç–æ–∏—Ç –∏ —Å–º–æ—Ç—Ä–∏—Ç
            else if (eventSystem.phase === 1) {
                // –ö–∞–º–µ—Ä–∞ —Å–ª–µ–¥–∏—Ç –∑–∞ –±–∏–≥ –º–∞–∫–æ–º –ø–æ–∫–∞ –æ–Ω –ø–∞–¥–∞–µ—Ç
                if (bigMac) {
                    camera.targetX = (bigMac.x + enemy.x) / 2 - canvas.width/2;
                    camera.targetY = bigMac.y - canvas.height/2;
                    camera.targetZoom = 1.2;
                }
            }
            // –§–∞–∑–∞ 2: –¢–æ—Ö–∞ –ø–∞–¥–∞–µ—Ç, –ò–≤–∞–Ω–∞ —É–Ω–æ—Å–∏—Ç —É–¥–∞—Ä–Ω–æ–π –≤–æ–ª–Ω–æ–π
            else if (eventSystem.phase === 2) {
                camera.targetZoom = 1.2;
                camera.targetX = toha.x - canvas.width/2;
                camera.targetY = toha.y - canvas.height/2;
                
                // –£–±–∏—Ä–∞–µ–º –±–∏–≥ –º–∞–∫ —Å –∞—Ä–µ–Ω—ã (–¢–æ—Ö–∞ –µ–≥–æ —Å—ä–µ–ª –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏)
                if (bigMac && bigMac.landed) {
                    bigMac = null;
                }
                
                if (toha.falling) {
                    toha.y += 25;
                    toha.rotation += 0.1;
                    
                    if (toha.y >= toha.fallY) {
                        toha.y = toha.fallY;
                        toha.falling = false;
                        toha.rotation = 0;
                        toha.active = true;
                        playSound('metalPipe', 0.8);
                        setTimeout(() => playSound('glassBreak', 0.6), 200);
                        shakeScreen();
                        
                        // –°–ø–∞–≤–Ω–∏–º –∫–∞–º–Ω–∏
                        spawnFallingRocks(15);
                        
                        // –£–î–ê–†–ù–ê–Ø –í–û–õ–ù–ê –£–ù–û–°–ò–¢ –ò–í–ê–ù–ê!
                        if (!enemy.blownAway) {
                            enemy.blownAway = true;
                            playSound('scream', 0.6);
                            
                            // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –¢–æ—Ö–∏ –∫ –ò–≤–∞–Ω—É
                            const edx = enemy.x - toha.x;
                            const edy = enemy.y - toha.y;
                            const edist = Math.sqrt(edx*edx + edy*edy);
                            
                            // –ò–≤–∞–Ω —É–ª–µ—Ç–∞–µ—Ç –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç –¢–æ—Ö–∏
                            enemy.blowVX = edist > 0 ? (edx / edist) * 30 : -30;
                            enemy.blowVY = edist > 0 ? (edy / edist) * 30 - 10 : -15; // –í–≤–µ—Ä—Ö —Ç–æ–∂–µ
                            enemy.flyRotation = 0;
                        }
                        
                        // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                        const dx = player.x - toha.x;
                        const dy = player.y - toha.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        const safeDistance = 350;
                        
                        if (dist < safeDistance) {
                            const pushX = dist > 0 ? (dx / dist) : 1;
                            const pushY = dist > 0 ? (dy / dist) : 0;
                            player.x = toha.x + pushX * safeDistance;
                            player.y = toha.y + pushY * safeDistance;
                            player.x = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.x));
                            player.y = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.y));
                            player.targetX = player.x;
                            player.targetY = player.y;
                            mouseX = player.x;
                            mouseY = player.y;
                        }
                        
                        // –ß–∞—Å—Ç–∏—Ü—ã —É–¥–∞—Ä–∞ - –≤–æ–ª–Ω–∞
                        for (let i = 0; i < 50; i++) {
                            const angle = (i / 50) * Math.PI * 2;
                            particles.push({
                                x: toha.x,
                                y: toha.y,
                                vx: Math.cos(angle) * (10 + Math.random() * 10),
                                vy: Math.sin(angle) * (10 + Math.random() * 10),
                                radius: Math.random() * 10 + 5,
                                color: '#ff6600',
                                alpha: 1,
                                life: 1.5
                            });
                        }
                        
                        // –£–¥–∞—Ä–Ω–∞—è –≤–æ–ª–Ω–∞
                        particles.push({
                            x: toha.x,
                            y: toha.y,
                            radius: 0,
                            maxRadius: 500,
                            type: 'shockwave',
                            alpha: 1,
                            life: 2
                        });
                    }
                } else {
                    // –ò–≤–∞–Ω —É–ª–µ—Ç–∞–µ—Ç –æ—Ç —É–¥–∞—Ä–Ω–æ–π –≤–æ–ª–Ω—ã
                    if (enemy.blownAway) {
                        enemy.x += enemy.blowVX;
                        enemy.y += enemy.blowVY;
                        enemy.blowVY += 0.5; // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
                        enemy.flyRotation = (enemy.flyRotation || 0) + 0.3;
                    }
                    
                    if (t > 3) {
                        eventSystem.phase = 3;
                        eventSystem.timer = 0;
                    }
                }
            }
            // –§–∞–∑–∞ 3: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ—Å—Å–∞
            else if (eventSystem.phase === 3) {
                // –¢–æ—Ö–∞ —É–∂–µ –Ω–∞ –∞—Ä–µ–Ω–µ - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –µ–≥–æ
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                if (t > 2) {
                    eventSystem.phase = 4;
                    eventSystem.timer = 0;
                    
                    // HP –¢–æ—Ö–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                    const diff = DIFFICULTIES[difficulty];
                    const baseRadius = 80;
                    const minRadius = 5;
                    // –ß–µ–º –≤—ã—à–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å - —Ç–µ–º –±–æ–ª—å—à–µ HP (–±–æ–ª—å—à–µ —Ä–∞–¥–∏—É—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–±–∏—Ç—å)
                    toha.maxRadius = Math.round(baseRadius * diff.tohaHpMultiplier);
                    toha.radius = toha.maxRadius;
                    toha.minRadius = minRadius;
                    
                    toha.active = true;
                    toha.falling = false;
                    toha.health = 100;
                    toha.attackType = null;
                    toha.currentAttackTime = 0;
                    toha.defeated = false;
                    toha.waitingForInstructions = true; // –¢–æ—Ö–∞ –∂–¥—ë—Ç –ø–æ–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –∏—Å—á–µ–∑–Ω—É—Ç
                    toha.attackTimer = 999; // –ù–µ –∞—Ç–∞–∫—É–µ—Ç –ø–æ–∫–∞ –∂–¥—ë—Ç
                    player.canMove = true;
                    playerFood = null;
                    healthyFood = [];
                    thrownFood = [];
                    kfcWings = [];
                    playMusic('tranceMusic', 0.4);
                    
                    document.getElementById('bossHealthBar').style.display = 'block';
                    document.querySelector('#bossHealthBar .name').textContent = '–¢–û–•–ê - –ö–∏–¥–∞–π –±—Ä–æ–∫–∫–æ–ª–∏! ü•¶';
                    // –£–±—Ä–∞–Ω–∞ –∑–µ–ª—ë–Ω–∞—è –ø–ª–∞—à–∫–∞ bossHint
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ - –ø–ª–∞–≤–Ω–æ –ø–æ—è–≤–ª—è—é—Ç—Å—è
                    const instructions = document.getElementById('bossInstructions');
                    instructions.classList.remove('hide');
                    instructions.classList.add('show');
                    
                    // –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –ø–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∏ –Ω–∞—á–∏–Ω–∞–µ–º –±–æ–π
                    setTimeout(() => {
                        instructions.classList.remove('show');
                        instructions.classList.add('hide');
                        
                        // –¢–µ–ø–µ—Ä—å –¢–æ—Ö–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç –∞—Ç–∞–∫–æ–≤–∞—Ç—å!
                        toha.waitingForInstructions = false;
                        toha.attackTimer = 0.5; // –ù–∞—á–∏–Ω–∞–µ–º –∞—Ç–∞–∫–∏
                    }, 5000);
                    
                    // –°–ø–∞–≤–Ω–∏–º –Ω–∞—á–∞–ª—å–Ω—É—é –µ–¥—É - –≤—Å–µ–≥–æ 2 —à—Ç—É–∫–∏
                    spawnHealthyFood();
                    spawnHealthyFood();
                    toha.lastFoodSpawn = 0;
                }
            }
            // –§–∞–∑–∞ 4: –ë–æ—Å—Å-—Ñ–∞–π—Ç
            else if (eventSystem.phase === 4) {
                updatePlayerMovement(dt);
                updateTohaBoss(dt);
                updateHealthyFood(dt);
                
                // HP –±–∞—Ä = —Ä–∞–∑–º–µ—Ä –¢–æ—Ö–∏
                toha.health = ((toha.radius - toha.minRadius) / (toha.maxRadius - toha.minRadius)) * 100;
                document.querySelector('#bossHealthBar .fill').style.width = toha.health + '%';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É - –¢–æ—Ö–∞ —Å–ª–∏—à–∫–æ–º –ø–æ—Ö—É–¥–µ–ª
                if (toha.radius <= toha.minRadius) {
                    toha.defeated = true;
                    toha.collapsePhase = 0;
                    toha.collapseTimer = 0;
                    eventSystem.phase = 5;
                    eventSystem.timer = 0;
                    stopMusic();
                    playSound('glassBreak', 0.7);
                    shakeScreen();
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è - –º–Ω–æ–≥–æ —á–∞—Å—Ç–∏—Ü
                    for (let i = 0; i < 80; i++) {
                        const angle = (i / 80) * Math.PI * 2;
                        const speed = 5 + Math.random() * 15;
                        particles.push({
                            x: toha.x,
                            y: toha.y,
                            vx: Math.cos(angle) * speed,
                            vy: Math.sin(angle) * speed,
                            radius: Math.random() * 10 + 3,
                            color: `hsl(${30 + Math.random() * 30}, 80%, 50%)`,
                            alpha: 1,
                            life: 2
                        });
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ
                    document.querySelector('#bossHealthBar .name').textContent = 'üéâ –¢–û–•–ê –ü–û–•–£–î–ï–õ! üéâ';
                }
                
                // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º bossInstructions
            }
            // –§–∞–∑–∞ 5: –¢–æ—Ö–∞ —Å—Ö–ª–æ–ø—ã–≤–∞–µ—Ç—Å—è –∏ –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è!
            else if (eventSystem.phase === 5) {
                if (!toha.collapsePhase) toha.collapsePhase = 0;
                if (!toha.collapseTimer) toha.collapseTimer = 0;
                toha.collapseTimer += dt;
                
                if (toha.collapsePhase === 0) {
                    // –°—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ - –¢–æ—Ö–∞ —Ç—Ä—è—Å—ë—Ç—Å—è –∏ —Å–∂–∏–º–∞–µ—Ç—Å—è
                    toha.x += (Math.random() - 0.5) * 20;
                    toha.y += (Math.random() - 0.5) * 20;
                    toha.radius = Math.max(1, toha.radius * 0.9);
                    toha.rotation += 0.5;
                    
                    // –ß–∞—Å—Ç–∏—Ü—ã —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è
                    if (Math.random() < 0.5) {
                        const angle = Math.random() * Math.PI * 2;
                        particles.push({
                            x: toha.x + Math.cos(angle) * 50,
                            y: toha.y + Math.sin(angle) * 50,
                            vx: -Math.cos(angle) * 5,
                            vy: -Math.sin(angle) * 5,
                            radius: Math.random() * 8 + 2,
                            color: '#ff6600',
                            alpha: 1,
                            life: 0.5
                        });
                    }
                    
                    if (toha.collapseTimer > 1.5) {
                        toha.collapsePhase = 1;
                        toha.collapseTimer = 0;
                        
                        // –§–∏–Ω–∞–ª—å–Ω—ã–π –≤–∑—Ä—ã–≤ —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è
                        playSound('metalPipe', 0.7);
                        shakeScreen();
                        
                        for (let i = 0; i < 100; i++) {
                            const angle = (i / 100) * Math.PI * 2;
                            const speed = 8 + Math.random() * 20;
                            particles.push({
                                x: toha.x,
                                y: toha.y,
                                vx: Math.cos(angle) * speed,
                                vy: Math.sin(angle) * speed,
                                radius: Math.random() * 12 + 3,
                                color: `hsl(${20 + Math.random() * 40}, 90%, 50%)`,
                                alpha: 1,
                                life: 2.5
                            });
                        }
                    }
                } else if (toha.collapsePhase === 1) {
                    // –¢–æ—Ö–∞ –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –ø–æ–ª
                    toha.y += 20;
                    toha.rotation += 0.3;
                    
                    if (toha.collapseTimer > 1.5) {
                        document.getElementById('bossHealthBar').style.display = 'none';
                        endEvent();
                    }
                }
            }
        }
        
        function updateTohaBoss(dt) {
            if (!toha.active) return;
            
            // –¢–æ—Ö–∞ –∂–¥—ë—Ç –ø–æ–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –∏—Å—á–µ–∑–Ω—É—Ç
            if (toha.waitingForInstructions) return;
            
            toha.attackTimer -= dt;
            
            // –°—á–µ—Ç—á–∏–∫ –∞—Ç–∞–∫ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            if (!toha.attackHistory) toha.attackHistory = [];
            
            // –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∞—Ç–∞–∫ - –í–´–°–û–ö–ê–Ø
            
            if (toha.attackTimer <= 0 && !toha.attackType) {
                // –í—ã–±–∏—Ä–∞–µ–º –∞—Ç–∞–∫—É - –≤—Å–µ –∞—Ç–∞–∫–∏ —Å —Ä–∞–≤–Ω—ã–º —à–∞–Ω—Å–æ–º, –Ω–æ –∏–∑–±–µ–≥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–æ–≤
                let attacks = ['roll', 'charge', 'quake', 'blackhole', 'kfc'];
                
                // –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏
                if (toha.attackHistory.length >= 2) {
                    const recent = toha.attackHistory.slice(-2);
                    attacks = attacks.filter(a => !recent.includes(a));
                    if (attacks.length === 0) attacks = ['roll', 'charge', 'quake', 'blackhole', 'kfc'];
                }
                
                toha.attackType = attacks[Math.floor(Math.random() * attacks.length)];
                toha.attackHistory.push(toha.attackType);
                if (toha.attackHistory.length > 5) toha.attackHistory.shift();
                toha.currentAttackTime = 0;
                toha.attackTimer = 0;
                
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ KFC - —Å—Ä–∞–∑—É –∫–∏–¥–∞–µ–º
                if (toha.attackType === 'kfc') {
                    tohaThrowKfc();
                }
                
                if (toha.attackType === 'roll') {
                    // –¶–µ–ª–∏–º—Å—è –≤ —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç–µ–Ω—É
                    const walls = ['left', 'right', 'top', 'bottom'];
                    const wall = walls[Math.floor(Math.random() * walls.length)];
                    let targetX, targetY;
                    if (wall === 'left') { targetX = MAP_BOUNDS.minX; targetY = toha.y; }
                    else if (wall === 'right') { targetX = MAP_BOUNDS.maxX(); targetY = toha.y; }
                    else if (wall === 'top') { targetX = toha.x; targetY = MAP_BOUNDS.minY; }
                    else { targetX = toha.x; targetY = MAP_BOUNDS.maxY(); }
                    
                    const dx = targetX - toha.x;
                    const dy = targetY - toha.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    toha.rollDir = { x: dx/dist, y: dy/dist };
                    toha.velocityX = toha.rollDir.x * 20;
                    toha.velocityY = toha.rollDir.y * 20;
                } else if (toha.attackType === 'charge') {
                    // –ó–∞—Ä—è–∂–∞–µ–º—Å—è –Ω–∞ –∏–≥—Ä–æ–∫–∞, –Ω–æ –ø—Ä–æ–ª–µ—Ç–∞–µ–º –¥–æ —Å—Ç–µ–Ω—ã
                    const dx = player.x - toha.x;
                    const dy = player.y - toha.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    toha.chargeDir = { x: dx/dist, y: dy/dist };
                    toha.chargeTimer = 1;
                }
            }
            
            // –°—á–µ—Ç—á–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∞—Ç–∞–∫–∏
            if (!toha.currentAttackTime) toha.currentAttackTime = 0;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ç–∞–∫
            if (toha.attackType === 'roll') {
                toha.currentAttackTime += dt;
                toha.x += toha.velocityX;
                toha.y += toha.velocityY;
                toha.rotation += 0.3;
                
                let hitWall = false;
                if (toha.x < MAP_BOUNDS.minX + toha.radius) { toha.x = MAP_BOUNDS.minX + toha.radius; hitWall = true; toha.velocityX = Math.abs(toha.velocityX); }
                if (toha.x > MAP_BOUNDS.maxX() - toha.radius) { toha.x = MAP_BOUNDS.maxX() - toha.radius; hitWall = true; toha.velocityX = -Math.abs(toha.velocityX); }
                if (toha.y < MAP_BOUNDS.minY + toha.radius) { toha.y = MAP_BOUNDS.minY + toha.radius; hitWall = true; toha.velocityY = Math.abs(toha.velocityY); }
                if (toha.y > MAP_BOUNDS.maxY() - toha.radius) { toha.y = MAP_BOUNDS.maxY() - toha.radius; hitWall = true; toha.velocityY = -Math.abs(toha.velocityY); }
                
                if (hitWall) {
                    playSound('nukeBomb', 0.5);
                    shakeScreen();
                    spawnFallingRocks(8);
                    
                    // –°–æ–∑–¥–∞—ë–º —á–∞—Å—Ç–∏—Ü—ã
                    for (let i = 0; i < 20; i++) {
                        particles.push({
                            x: toha.x,
                            y: toha.y,
                            vx: (Math.random() - 0.5) * 15,
                            vy: (Math.random() - 0.5) * 15,
                            radius: Math.random() * 6 + 3,
                            color: '#ff6600',
                            alpha: 1,
                            life: 0.8
                        });
                    }
                    
                    // –°–ª–µ–¥—É—é—â–∞—è —Ü–µ–ª—å - —Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç–µ–Ω–∞
                    const walls = ['left', 'right', 'top', 'bottom'];
                    const wall = walls[Math.floor(Math.random() * walls.length)];
                    let targetX, targetY;
                    if (wall === 'left') { targetX = MAP_BOUNDS.minX; targetY = Math.random() * canvas.height; }
                    else if (wall === 'right') { targetX = MAP_BOUNDS.maxX(); targetY = Math.random() * canvas.height; }
                    else if (wall === 'top') { targetX = Math.random() * canvas.width; targetY = MAP_BOUNDS.minY; }
                    else { targetX = Math.random() * canvas.width; targetY = MAP_BOUNDS.maxY(); }
                    
                    const dx = targetX - toha.x;
                    const dy = targetY - toha.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    toha.velocityX = (dx/dist) * 20;
                    toha.velocityY = (dy/dist) * 20;
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∞—Ç–∞–∫–∏ - 4 —Å–µ–∫—É–Ω–¥—ã
                if (toha.currentAttackTime > 4) {
                    toha.attackType = null;
                    toha.attackTimer = 0.5; // –ë—ã—Å—Ç—Ä–µ–µ –Ω–æ–≤–∞—è –∞—Ç–∞–∫–∞!
                    toha.currentAttackTime = 0;
                }
            } else if (toha.attackType === 'charge') {
                if (toha.chargeTimer > 0) {
                    toha.chargeTimer -= dt;
                } else {
                    // –õ–µ—Ç–∏–º –¥–æ —Å—Ç–µ–Ω—ã
                    toha.x += toha.chargeDir.x * 35;
                    toha.y += toha.chargeDir.y * 35;
                    
                    let hitWall = false;
                    if (toha.x < MAP_BOUNDS.minX + toha.radius) { toha.x = MAP_BOUNDS.minX + toha.radius; hitWall = true; }
                    if (toha.x > MAP_BOUNDS.maxX() - toha.radius) { toha.x = MAP_BOUNDS.maxX() - toha.radius; hitWall = true; }
                    if (toha.y < MAP_BOUNDS.minY + toha.radius) { toha.y = MAP_BOUNDS.minY + toha.radius; hitWall = true; }
                    if (toha.y > MAP_BOUNDS.maxY() - toha.radius) { toha.y = MAP_BOUNDS.maxY() - toha.radius; hitWall = true; }
                    
                    if (hitWall) {
                        playSound('nukeBomb', 0.6);
                        shakeScreen();
                        spawnFallingRocks(10);
                        
                        for (let i = 0; i < 25; i++) {
                            particles.push({
                                x: toha.x,
                                y: toha.y,
                                vx: (Math.random() - 0.5) * 20,
                                vy: (Math.random() - 0.5) * 20,
                                radius: Math.random() * 8 + 4,
                                color: '#ff0000',
                                alpha: 1,
                                life: 1
                            });
                        }
                        
                        toha.attackType = null;
                        toha.attackTimer = 0.3; // –ü–æ—á—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –Ω–æ–≤–∞—è –∞—Ç–∞–∫–∞!
                    }
                }
            } else if (toha.attackType === 'quake') {
                // –ó–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ - –≤–æ–ª–Ω—ã
                toha.currentAttackTime += dt;
                toha.attackTimer += dt;
                
                if (toha.attackTimer > 0.6) {
                    toha.attackTimer = 0;
                    shakeScreen();
                    
                    particles.push({
                        x: toha.x,
                        y: toha.y,
                        radius: 0,
                        maxRadius: 350,
                        type: 'shockwave',
                        alpha: 1,
                        life: 1.5
                    });
                    
                    // –ö–∞–º–Ω–∏ –ø—Ä–∏ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–∏
                    spawnFallingRocks(3);
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∞—Ç–∞–∫–∏ - 2 —Å–µ–∫—É–Ω–¥—ã
                if (toha.currentAttackTime > 2) {
                    toha.attackType = null;
                    toha.attackTimer = 0.4; // –ë—ã—Å—Ç—Ä–µ–µ!
                    toha.currentAttackTime = 0;
                }
            } else if (toha.attackType === 'blackhole') {
                // –ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞ - –û–ß–ï–ù–¨ —Å–∏–ª—å–Ω–æ–µ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ!
                const dx = toha.x - player.x;
                const dy = toha.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > 0) {
                    // –ü—Ä–∏—Ç—è–∂–µ–Ω–∏–µ —Å–∏–ª—å–Ω–µ–µ —á–µ–º –±–ª–∏–∂–µ –∏–≥—Ä–æ–∫
                    const distFactor = Math.max(0.5, 1 - dist / 600);
                    const force = 10 * distFactor; // –£–≤–µ–ª–∏—á–µ–Ω–æ –≤ 2 —Ä–∞–∑–∞!
                    player.x += (dx / dist) * force;
                    player.y += (dy / dist) * force;
                    // –ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ–º –∏ —Ü–µ–ª—å —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
                    player.targetX += (dx / dist) * force * 0.7;
                    player.targetY += (dy / dist) * force * 0.7;
                    mouseX += (dx / dist) * force * 0.5;
                    mouseY += (dy / dist) * force * 0.5;
                }
                
                // –ß–∞—Å—Ç–∏—Ü—ã –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è - –±–æ–ª—å—à–µ —á–∞—Å—Ç–∏—Ü
                if (Math.random() < 0.5) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = 150 + Math.random() * 150;
                    particles.push({
                        x: toha.x + Math.cos(angle) * r,
                        y: toha.y + Math.sin(angle) * r,
                        vx: -Math.cos(angle) * 8,
                        vy: -Math.sin(angle) * 8,
                        radius: 4 + Math.random() * 3,
                        color: `hsl(${270 + Math.random() * 30}, 70%, 50%)`,
                        alpha: 1,
                        life: 0.8
                    });
                }
                
                // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –≤–æ—Ä–æ–Ω–∫–∏
                toha.rotation += 0.15;
                
                toha.attackTimer += dt;
                toha.currentAttackTime += dt;
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∞—Ç–∞–∫–∏ - 2.5 —Å–µ–∫—É–Ω–¥—ã
                if (toha.currentAttackTime > 2.5) {
                    toha.attackType = null;
                    toha.attackTimer = 0.3; // –ë—ã—Å—Ç—Ä–µ–µ!
                    toha.currentAttackTime = 0;
                }
            } else if (toha.attackType === 'kfc') {
                // –ö–∏–¥–∞–µ–º –∫—Ä—ã–ª—ã—à–∫–∏ KFC
                toha.currentAttackTime += dt;
                
                // –ö–∏–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ª–Ω
                if (toha.currentAttackTime > 0.5 && !toha.kfcWave2) {
                    toha.kfcWave2 = true;
                    tohaThrowKfc();
                }
                if (toha.currentAttackTime > 1.0 && !toha.kfcWave3) {
                    toha.kfcWave3 = true;
                    tohaThrowKfc();
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∞—Ç–∞–∫–∏
                if (toha.currentAttackTime > 1.5) {
                    toha.attackType = null;
                    toha.attackTimer = 0.8;
                    toha.currentAttackTime = 0;
                    toha.kfcWave2 = false;
                    toha.kfcWave3 = false;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
            const dx = toha.x - player.x;
            const dy = toha.y - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if (dist < toha.radius + player.radius) {
                if (player.shield > 0) {
                    player.shield--;
                    playSound('hit', 0.5);
                    
                    // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞
                    const pushX = -dx / dist * 150;
                    const pushY = -dy / dist * 150;
                    player.x += pushX;
                    player.y += pushY;
                    player.x = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.x));
                    player.y = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.y));
                    player.targetX = player.x;
                    player.targetY = player.y;
                } else {
                    gameOver();
                }
            }
        }
        
        function spawnFallingRocks(count) {
            for (let i = 0; i < count; i++) {
                fallingRocks.push({
                    x: Math.random() * canvas.width,
                    y: -50 - Math.random() * 100,
                    radius: 15 + Math.random() * 25,
                    vy: 2 + Math.random() * 3,
                    rotation: Math.random() * Math.PI * 2,
                    rotSpeed: (Math.random() - 0.5) * 0.2,
                    color: `hsl(30, ${20 + Math.random() * 20}%, ${30 + Math.random() * 20}%)`
                });
            }
        }
        
        // –°–ø–∞–≤–Ω –∑–¥–æ—Ä–æ–≤–æ–π –µ–¥—ã
        function spawnHealthyFood() {
            if (healthyFood.length >= 8) return;
            
            const foods = [
                { icon: 'ü•¶', name: 'broccoli', damage: 3 },
                { icon: 'ü•ï', name: 'carrot', damage: 2 },
                { icon: 'üçé', name: 'apple', damage: 2 },
                { icon: 'ü•ó', name: 'salad', damage: 4 },
                { icon: 'ü•í', name: 'cucumber', damage: 1 },
                { icon: 'üçá', name: 'grapes', damage: 2 }
            ];
            
            const food = foods[Math.floor(Math.random() * foods.length)];
            
            healthyFood.push({
                x: MAP_BOUNDS.minX + 80 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 160),
                y: MAP_BOUNDS.minY + 80 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 160),
                icon: food.icon,
                name: food.name,
                damage: food.damage,
                rotation: 0,
                pulse: Math.random() * Math.PI * 2
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤–æ–π –µ–¥—ã
        function updateHealthyFood(dt) {
            // –°–ø–∞–≤–Ω–∏–º –Ω–æ–≤—É—é –µ–¥—É –ø–æ 1 —à—Ç—É–∫–µ —Ä–∞–∑ –≤ 2-3 —Å–µ–∫—É–Ω–¥—ã
            if (!toha.lastFoodSpawn) toha.lastFoodSpawn = 0;
            toha.lastFoodSpawn += dt;
            
            if (toha.lastFoodSpawn > 2 + Math.random() * 1 && healthyFood.length < 4) {
                spawnHealthyFood();
                toha.lastFoodSpawn = 0;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–±–æ—Ä –µ–¥—ã –∏–≥—Ä–æ–∫–æ–º
            healthyFood = healthyFood.filter(food => {
                const dx = food.x - player.x;
                const dy = food.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < player.radius + 25 && !playerFood) {
                    // –ü–æ–¥–±–∏—Ä–∞–µ–º –µ–¥—É
                    playerFood = {
                        icon: food.icon,
                        name: food.name,
                        damage: food.damage
                    };
                    playSound('powerup', 0.3);
                    return false;
                }
                
                food.pulse += dt * 3;
                food.rotation += dt;
                return true;
            });
        }
        
        // –ë—Ä–æ—Å–æ–∫ –µ–¥—ã –≤ –¢–æ—Ö—É (–ø–æ –∫–ª–∏–∫—É –∏–ª–∏ –ø—Ä–æ–±–µ–ª—É)
        function throwFoodAtToha() {
            if (!playerFood || !toha.active) return;
            
            const dx = toha.x - player.x;
            const dy = toha.y - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            thrownFood.push({
                x: player.x,
                y: player.y,
                vx: (dx / dist) * 20,
                vy: (dy / dist) * 20,
                icon: playerFood.icon,
                damage: playerFood.damage,
                rotation: 0
            });
            
            playSound('swoosh', 0.4);
            playerFood = null;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–æ—à–µ–Ω–Ω–æ–π –µ–¥—ã
        function updateThrownFood(dt) {
            thrownFood = thrownFood.filter(food => {
                food.x += food.vx;
                food.y += food.vy;
                food.rotation += 0.3;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –¢–æ—Ö—É
                if (toha.active) {
                    const dx = food.x - toha.x;
                    const dy = food.y - toha.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < toha.radius + 15) {
                        // –ü–æ–ø–∞–¥–∞–Ω–∏–µ! –¢–æ—Ö–∞ —Ö—É–¥–µ–µ—Ç!
                        toha.radius = Math.max(toha.minRadius, toha.radius - food.damage);
                        playSound('hit', 0.5);
                        shakeScreen();
                        
                        // –ß–∞—Å—Ç–∏—Ü—ã –ø–æ–ø–∞–¥–∞–Ω–∏—è
                        for (let i = 0; i < 15; i++) {
                            particles.push({
                                x: food.x,
                                y: food.y,
                                vx: (Math.random() - 0.5) * 10,
                                vy: (Math.random() - 0.5) * 10,
                                radius: Math.random() * 5 + 2,
                                color: '#00ff00',
                                alpha: 1,
                                life: 0.6
                            });
                        }
                        
                        devLog(`–ü–æ–ø–∞–¥–∞–Ω–∏–µ! –¢–æ—Ö–∞: ${toha.radius.toFixed(0)}/${toha.maxRadius}`);
                        return false;
                    }
                }
                
                // –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ –≤—ã—à–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
                return food.x > 0 && food.x < canvas.width && food.y > 0 && food.y < canvas.height;
            });
        }
        
        // –ê—Ç–∞–∫–∞ –¢–æ—Ö–∏ - –∫–∏–¥–∞–µ—Ç –∫—Ä—ã–ª—ã—à–∫–∏ KFC
        function tohaThrowKfc() {
            const angles = [0, Math.PI/4, Math.PI/2, Math.PI*3/4, Math.PI, -Math.PI*3/4, -Math.PI/2, -Math.PI/4];
            const count = 3 + Math.floor(Math.random() * 3);
            
            for (let i = 0; i < count; i++) {
                const angle = angles[Math.floor(Math.random() * angles.length)] + (Math.random() - 0.5) * 0.5;
                const speed = 8 + Math.random() * 4;
                
                kfcWings.push({
                    x: toha.x,
                    y: toha.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    rotation: Math.random() * Math.PI * 2
                });
            }
            
            playSound('dash', 0.4);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä—ã–ª—ã—à–µ–∫ KFC
        function updateKfcWings(dt) {
            kfcWings = kfcWings.filter(wing => {
                wing.x += wing.vx;
                wing.y += wing.vy;
                wing.rotation += 0.15;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –∏–≥—Ä–æ–∫–∞
                const dx = wing.x - player.x;
                const dy = wing.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < player.radius + 15) {
                    if (player.shield > 0) {
                        player.shield--;
                        playSound('hit', 0.5);
                    } else if (!godMode) {
                        gameOver();
                    }
                    return false;
                }
                
                // –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ –≤—ã—à–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
                return wing.x > -50 && wing.x < canvas.width + 50 && wing.y > -50 && wing.y < canvas.height + 50;
            });
        }
        
        function endEvent() {
            eventSystem.active = false;
            eventSystem.cooldown = 30;
            player.canMove = true;
            enemy.useEmote = false;
            enemy.holdingBigMac = false;
            enemy.screamPlayed = false;
            enemy.flyRotation = 0;
            enemy.blownAway = false;
            enemy.blowVX = 0;
            enemy.blowVY = 0;
            toha.active = false;
            toha.falling = false;
            mellstroys = [];
            healthyFood = [];
            thrownFood = [];
            kfcWings = [];
            playerFood = null;
            bigMac = null;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ò–≤–∞–Ω–∞ –Ω–∞ –∞—Ä–µ–Ω—É (–µ—Å–ª–∏ –æ–Ω —É–ª–µ—Ç–µ–ª)
            if (enemy.x < MAP_BOUNDS.minX || enemy.x > MAP_BOUNDS.maxX() ||
                enemy.y < MAP_BOUNDS.minY || enemy.y > MAP_BOUNDS.maxY()) {
                // –°—Ç–∞–≤–∏–º –¥–∞–ª–µ–∫–æ –æ—Ç –∏–≥—Ä–æ–∫–∞
                let newX, newY;
                do {
                    newX = MAP_BOUNDS.minX + 100 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 200);
                    newY = MAP_BOUNDS.minY + 100 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 200);
                } while (Math.sqrt((newX - player.x)**2 + (newY - player.y)**2) < 300);
                
                enemy.x = newX;
                enemy.y = newY;
                enemy.smoothX = newX;
                enemy.smoothY = newY;
            }
            
            document.getElementById('bossInstructions').classList.remove('show');
            document.getElementById('bossInstructions').classList.add('hide');
            
            // –£–º–µ–Ω—å—à–∞–µ–º –≤–µ—Å —Ç–µ–∫—É—â–µ–≥–æ –∏–≤–µ–Ω—Ç–∞
            eventSystem.weights[eventSystem.type] *= 0.3;
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Å –¥—Ä—É–≥–æ–≥–æ
            Object.keys(eventSystem.weights).forEach(key => {
                if (key !== eventSystem.type) {
                    eventSystem.weights[key] = Math.min(2, eventSystem.weights[key] * 1.5);
                }
            });
            
            devLog(`–ò–≤–µ–Ω—Ç ${eventSystem.type} –∑–∞–≤–µ—Ä—à—ë–Ω`);
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –∏–≤–µ–Ω—Ç–æ–≤
            if (eventSystem.type === 'mellstroy') {
                eventSystem.completedEvents.mellstroy++;
            } else if (eventSystem.type === 'zhiragedon') {
                eventSystem.completedEvents.zhiragedon++;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞ (–ø—Ä–æ—à–ª–∏ –æ–±–∞ –∏–≤–µ–Ω—Ç–∞ —Ö–æ—Ç—è –±—ã –ø–æ 1 —Ä–∞–∑—É)
            if (!eventSystem.finalBossTriggered && 
                eventSystem.completedEvents.mellstroy >= 1 && 
                eventSystem.completedEvents.zhiragedon >= 1) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (gameState === 'playing' && !eventSystem.active) {
                        startFinalBoss();
                    }
                }, 10000);
            }
        }
        
        // ==================== –§–ò–ù–ê–õ–¨–ù–´–ô –ë–û–°–° ====================
        function startFinalBoss() {
            if (eventSystem.finalBossTriggered) return;
            eventSystem.finalBossTriggered = true;
            eventSystem.active = true;
            eventSystem.type = 'finalBoss';
            eventSystem.phase = 0;
            eventSystem.timer = 0;
            
            player.canMove = false;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
            finalBoss.active = true;
            finalBoss.phase = 0;
            finalBoss.timer = 0;
            finalBoss.x = enemy.x;
            finalBoss.y = enemy.y;
            finalBoss.radius = 50;
            finalBoss.health = 150;
            finalBoss.maxHealth = 150;
            finalBoss.isEvil = false;
            finalBoss.speaking = false;
            finalBoss.speakScale = 1;
            finalBoss.grayscale = 0;
            finalBoss.flashWhite = 0;
            finalBoss.lettersShown = 0;
            finalBoss.bossBarShown = false;
            finalBoss.speechStarted = false;
            finalBoss.lobotomiaPlayed = false;
            finalBoss.attacks = [];
            finalBoss.censoredMissiles = [];
            finalBoss.attackTimer = 0;
            finalBoss.attackPaused = false; // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∞—Ç–∞–∫–∞–º–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞ –∫–∞–∫–∞—à–∫–∏
            finalBoss.pauseTimer = 0;
            finalBoss.stage = 1; // –°—Ç–∞–¥–∏—è –±–æ—Å—Å–∞ (1, 2, 3)
            finalBoss.stageTransition = false; // –ü–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —Å—Ç–∞–¥–∏—è–º–∏
            finalBoss.currentAttack = null;
            finalBoss.handsVisible = false;
            finalBoss.handsTimer = 0;
            finalBoss.missileCount = 0;
            
            devLog('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –§–ò–ù–ê–õ–¨–ù–´–ô –ë–û–°–°!');
        }
        
        function updateFinalBossEvent(dt) {
            eventSystem.timer += dt;
            finalBoss.timer += dt;
            const t = eventSystem.timer;
            
            // –§–∞–∑–∞ 0: –ò–≤–∞–Ω –º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–ª–∑—ë—Ç –≤ —Ü–µ–Ω—Ç—Ä
            if (eventSystem.phase === 0) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // –ú–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–ª–∑—ë—Ç
                finalBoss.x += (centerX - finalBoss.x) * 0.02;
                finalBoss.y += (centerY - finalBoss.y) * 0.02;
                
                // –ö–∞–º–µ—Ä–∞ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è
                camera.targetZoom = 2.0;
                camera.targetX = finalBoss.x - canvas.width/2;
                camera.targetY = finalBoss.y - canvas.height/2;
                
                // –ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥ —Ü–µ–Ω—Ç—Ä–∞ - –Ω–∞—á–∏–Ω–∞–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å
                const distToCenter = Math.sqrt((finalBoss.x - centerX)**2 + (finalBoss.y - centerY)**2);
                if (distToCenter < 30 && !finalBoss.speechStarted) {
                    finalBoss.speechStarted = true;
                    eventSystem.phase = 1;
                    eventSystem.timer = 0;
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ—á—å (20 —Å–µ–∫—É–Ω–¥)
                    playSound('zoloZapret', 0.8);
                    finalBoss.speaking = true;
                }
            }
            // –§–∞–∑–∞ 1: –ò–≤–∞–Ω –≥–æ–≤–æ—Ä–∏—Ç (20 —Å–µ–∫—É–Ω–¥)
            else if (eventSystem.phase === 1) {
                // –ê–Ω–∏–º–∞—Ü–∏—è —Ä–µ—á–∏ - —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –∫–∞–∫ –≤ –º—É–ª—å—Ç–∏–∫–∞—Ö
                if (finalBoss.speaking) {
                    finalBoss.speakScale = 1 + Math.sin(t * 8) * 0.08 + Math.sin(t * 12) * 0.05;
                }
                
                // –≠–∫—Ä–∞–Ω –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á—ë—Ä–Ω–æ-–±–µ–ª—ã–º
                finalBoss.grayscale = Math.min(1, t / 18);
                document.getElementById('finalBossOverlay').style.filter = `grayscale(${finalBoss.grayscale * 100}%)`;
                
                // –ö–∞–º–µ—Ä–∞ –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ –ò–≤–∞–Ω–µ
                camera.targetX = finalBoss.x - canvas.width/2;
                camera.targetY = finalBoss.y - canvas.height/2;
                
                // –ü–æ—Å–ª–µ 20 —Å–µ–∫—É–Ω–¥ - –ª–æ–±–æ—Ç–æ–º–∏—è
                if (t > 20 && !finalBoss.lobotomiaPlayed) {
                    finalBoss.lobotomiaPlayed = true;
                    finalBoss.speaking = false;
                    eventSystem.phase = 2;
                    eventSystem.timer = 0;
                    
                    // –ó–≤—É–∫ –ª–æ–±–æ—Ç–æ–º–∏–∏ (6 —Å–µ–∫—É–Ω–¥)
                    playSound('lobotomia', 0.9);
                }
            }
            // –§–∞–∑–∞ 2: "–Ø –¥–µ–ª–∞—é –ª–æ–±–æ—Ç–æ–º–∏—é" + –≤—Å–ø—ã—à–∫–∞ (6 —Å–µ–∫—É–Ω–¥)
            else if (eventSystem.phase === 2) {
                finalBoss.speakScale = 1 + Math.sin(t * 10) * 0.1;
                
                // –í—Å–ø—ã—à–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ 5–π —Å–µ–∫—É–Ω–¥–µ
                if (t > 5) {
                    finalBoss.flashWhite = Math.min(1, (t - 5) * 2);
                }
                
                // –ü–æ—Å–ª–µ 6 —Å–µ–∫—É–Ω–¥ - –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω –∏ —Å–º–µ–Ω–∞ —Å–∫–∏–Ω–∞
                if (t > 6) {
                    eventSystem.phase = 3;
                    eventSystem.timer = 0;
                    
                    // –ú–µ–Ω—è–µ–º —Å–∫–∏–Ω –Ω–∞ –∑–ª–æ–≥–æ
                    finalBoss.isEvil = true;
                    
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏–≥—Ä–æ–∫–∞ –∏ –±–æ—Å—Å–∞
                    finalBoss.x = canvas.width / 2;
                    finalBoss.y = 150;
                    player.x = canvas.width / 2;
                    player.y = canvas.height - 150;
                    player.targetX = player.x;
                    player.targetY = player.y;
                    mouseX = player.x;
                    mouseY = player.y;
                    
                    // –°–∏–Ω—è—è –∞—É—Ä–∞
                    document.getElementById('blueAura').classList.add('active');
                }
            }
            // –§–∞–∑–∞ 3: –ë–µ–ª–∞—è –≤—Å–ø—ã—à–∫–∞ —Å–ø–∞–¥–∞–µ—Ç + –ø–æ—è–≤–ª—è—é—Ç—Å—è –±—É–∫–≤—ã
            else if (eventSystem.phase === 3) {
                // –í—Å–ø—ã—à–∫–∞ —Å–ø–∞–¥–∞–µ—Ç
                finalBoss.flashWhite = Math.max(0, 1 - t * 0.5);
                
                // –£–±–∏—Ä–∞–µ–º —á/–±
                finalBoss.grayscale = Math.max(0, 1 - t * 0.3);
                document.getElementById('finalBossOverlay').style.filter = `grayscale(${finalBoss.grayscale * 100}%)`;
                
                // –ö–∞–º–µ—Ä–∞ –æ—Ç–¥–∞–ª—è–µ—Ç—Å—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ä–µ–Ω—É
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—É–∫–≤—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 0.6 —Å–µ–∫—É–Ω–¥—ã
                const lettersToShow = Math.min(4, Math.floor(t / 0.6));
                
                if (lettersToShow > finalBoss.lettersShown) {
                    finalBoss.lettersShown = lettersToShow;
                    playSound('undertaleHit', 0.7);
                    shakeScreen();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—É–∫–≤—ã
                    const letters = document.querySelectorAll('.boss-letter');
                    for (let i = 0; i < finalBoss.lettersShown; i++) {
                        letters[i].style.opacity = '1';
                        letters[i].style.transform = 'scale(1)';
                    }
                    
                    if (finalBoss.lettersShown === 1) {
                        document.getElementById('finalBossLetters').classList.add('show');
                    }
                }
                
                // –ü–æ—Å–ª–µ 4 –±—É–∫–≤ (2.4 —Å–µ–∫—É–Ω–¥—ã) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ—Å—Å-–±–∞—Ä
                if (t > 2.8 && !finalBoss.bossBarShown) {
                    finalBoss.bossBarShown = true;
                    playSound('undertaleChaos', 0.8);
                    
                    document.getElementById('finalBossBar').style.display = 'block';
                    
                    // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –±–æ—Å—Å-–±–∞—Ä–∞ - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –±–æ—é (—Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ–º–ø—Ç)
                    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI
                }
                
                // –ü–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –≤—Å–µ–≥–æ - –ø–µ—Ä–µ—Ö–æ–¥ –∫ –±–æ—é!
                if (t > 5 && !finalBoss.fightStarted) {
                    finalBoss.fightStarted = true;
                    player.canMove = true; // –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è
                    eventSystem.phase = 4; // –ë–æ–π —Å—Ç–∞–¥–∏—è 1
                    eventSystem.timer = 0;
                    
                    // –í–∫–ª—é—á–∞–µ–º –º—É–∑—ã–∫—É —Å—Ç–∞–¥–∏–∏ 1 - unknown-background-music (–ù–ï doom!)
                    // –í–ê–ñ–ù–û: stage1Music = unknown-background-music.mp3
                    playMusic('stage1Music', 0.5);
                    devLog('–ú—É–∑—ã–∫–∞ —Å—Ç–∞–¥–∏–∏ 1: ' + SOUNDS.stage1Music);
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—è
                    finalBoss.attackTimer = 2; // –ü–µ—Ä–≤–∞—è –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    finalBoss.censoredMissiles = [];
                    finalBoss.handsVisible = false;
                    
                    devLog('–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å - –ë–û–ô –ù–ê–ß–ê–õ–°–Ø!');
                }
            }
            // –§–∞–∑–∞ 4: –ë–û–ô
            else if (eventSystem.phase === 4) {
                // –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è
                updatePlayerMovement(dt);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç–∞–∫–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
                updateFinalBossAttacks(dt);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∫–µ—Ç—ã CENSORED
                updateCensoredMissiles(dt);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—Ç–∞–∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞
        function updateFinalBossAttacks(dt) {
            // –î–≤–∏–∂–µ–Ω–∏–µ –∫—Ä—ã–ª—å–µ–≤ –∏ –ø–æ–∑–∏—Ü–∏—è –±–æ—Å—Å–∞ –Ω–∞ —Å—Ç–∞–¥–∏–∏ 2+
            if (finalBoss.stage >= 2 || finalBoss.hasWings) {
                // –ò–≤–∞–Ω –º–∞—à–µ—Ç –∫—Ä—ã–ª—å—è–º–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
                if (!stage2Wings.flapTimer) stage2Wings.flapTimer = 0;
                stage2Wings.flapTimer += dt;
                stage2Wings.flapAngle = Math.sin(stage2Wings.flapTimer * 4) * 0.4;
                
                // –ò–≤–∞–Ω —Å–ª–µ–≥–∫–∞ –ª–µ—Ç–∞–µ—Ç –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ
                if (!finalBoss.flyTimer) finalBoss.flyTimer = 0;
                finalBoss.flyTimer += dt;
                const flyOffset = Math.sin(finalBoss.flyTimer * 0.5) * 80;
                finalBoss.x = canvas.width / 2 + flyOffset;
                
                // –ù–µ–±–æ–ª—å—à–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑
                finalBoss.y = 120 + Math.sin(finalBoss.flyTimer * 0.8) * 15;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 50% HP - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç–∞–¥–∏—é 2 (—Ç–µ–ø–µ—Ä—å 75 HP –∏–∑ 150)
            if (finalBoss.stage === 1 && finalBoss.health <= finalBoss.maxHealth * 0.5 && !finalBoss.stageTransition) {
                finalBoss.stageTransition = true;
                finalBoss.currentAttack = null;
                // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
                finalBoss.handsVisible = false;
                finalBoss.hasMicrophone = false;
                speakerAttack.active = false;
                speakers = [];
                musicNotes = [];
                batyas = [];
                batyaLasers = [];
                player.canMove = false;
                stopMusic();
                startStage2Cutscene();
                devLog('–°–¢–ê–î–ò–Ø 2 –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø! (50% HP)');
                return;
            }
            
            // –ï—Å–ª–∏ –∏–¥—ë—Ç –∫–∞—Ç—Å—Ü–µ–Ω–∞ —Å—Ç–∞–¥–∏–∏ 2
            if (finalBoss.stage2Cutscene) {
                updateStage2Cutscene(dt);
                return;
            }
            
            // –ï—Å–ª–∏ –∏–¥—ë—Ç –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —Å—Ç–∞–¥–∏—è–º–∏ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (finalBoss.stageTransition) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∫–∞—à–∫–∏ –í–°–ï–ì–î–ê (–¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∞—Ç–∞–∫)
            updatePoops(dt);
            
            finalBoss.attackTimer -= dt;
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—É—â–µ–π –∞—Ç–∞–∫–∏ –∏ —Ç–∞–π–º–µ—Ä –≤—ã—à–µ–ª - –≤—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é –∞—Ç–∞–∫—É
            if (!finalBoss.currentAttack && finalBoss.attackTimer <= 0) {
                // –í—ã–±–æ—Ä –∞—Ç–∞–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–∞–¥–∏–∏
                if (finalBoss.stage >= 2) {
                    // –°—Ç–∞–¥–∏—è 2
                    if (!finalBoss.stage2AttackCount) finalBoss.stage2AttackCount = 0;
                    finalBoss.stage2AttackCount++;
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–ª–∞–≥–∏ –∞—Ç–∞–∫
                    if (!finalBoss.labyrinthAttackUsed) finalBoss.labyrinthAttackUsed = false;
                    if (!finalBoss.firePlatformAttackUsed) finalBoss.firePlatformAttackUsed = false;
                    
                    // –ê—Ç–∞–∫–∞ –õ–∞–±–∏—Ä–∏–Ω—Ç: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∞—Ç–∞–∫–∞, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –±—ã–ª–∞
                    if (!finalBoss.labyrinthAttackUsed && finalBoss.stage2AttackCount > 1) {
                        if (Math.random() < 0.4 || finalBoss.stage2AttackCount > 4) {
                            startLabyrinthAttack();
                        } else if (!finalBoss.carAttackUsed && Math.random() < 0.5) {
                            startCarAttack();
                        } else if (!finalBoss.firePlatformAttackUsed && Math.random() < 0.5) {
                            startFirePlatformAttack();
                        } else {
                            startFireCircleAttack();
                        }
                    }
                    // –ê—Ç–∞–∫–∞ –û–≥–Ω–µ–Ω–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –±—ã–ª–∞
                    else if (!finalBoss.firePlatformAttackUsed && finalBoss.stage2AttackCount > 1) {
                        if (Math.random() < 0.5 || finalBoss.stage2AttackCount > 3) {
                            startFirePlatformAttack();
                        } else if (!finalBoss.carAttackUsed && Math.random() < 0.4) {
                            startCarAttack();
                        } else {
                            startFireCircleAttack();
                        }
                    }
                    // –ê—Ç–∞–∫–∞ –º–∞—à–∏–Ω–æ–π: –µ—Å–ª–∏ –µ—â–µ –Ω–µ –±—ã–ª–∞ –∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –∞—Ç–∞–∫–∞ —Å—Ç–∞–¥–∏–∏
                    else if (!finalBoss.carAttackUsed && finalBoss.stage2AttackCount > 1) {
                        if (Math.random() < 0.5 || finalBoss.stage2AttackCount > 3) {
                            startCarAttack();
                        } else {
                            startFireCircleAttack();
                        }
                    } else {
                        startFireCircleAttack();
                    }
                } else {
                    // –°—Ç–∞–¥–∏—è 1 - –æ–±—ã—á–Ω—ã–µ –∞—Ç–∞–∫–∏
                    const attackRoll = Math.random();
                    if (attackRoll < 0.33) {
                        startCensoredMissileAttack();
                    } else if (attackRoll < 0.66) {
                        startBatyaAttack();
                    } else {
                        startSpeakerAttack();
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∞—Ç–∞–∫—É
            if (finalBoss.currentAttack === 'censored') {
                updateCensoredAttack(dt);
            } else if (finalBoss.currentAttack === 'batya') {
                updateBatyaAttack(dt);
            } else if (finalBoss.currentAttack === 'speakers') {
                updateSpeakerAttack(dt);
            } else if (finalBoss.currentAttack === 'fireCircles') {
                updateFireCircleAttack(dt);
            } else if (finalBoss.currentAttack === 'car') {
                updateCarAttack(dt);
            } else if (finalBoss.currentAttack === 'labyrinth') {
                updateLabyrinthAttack(dt);
            } else if (finalBoss.currentAttack === 'firePlatform') {
                updateFirePlatformAttack(dt);
            }
            
            // –í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º –±—Ä–æ—à–µ–Ω–Ω—ã–µ –∫–∞–∫–∞—à–∫–∏ (–¥–∞–∂–µ –≤–Ω–µ –ø–∞—É–∑—ã!)
            updateThrownPoops(dt);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞—Ç–µ–π –∏ –ª–∞–∑–µ—Ä—ã
            updateBatyas(dt);
            updateBatyaLasers(dt);
        }
        
        // –ù–∞—á–∞–ª–æ –∞—Ç–∞–∫–∏ –ë–∞—Ç—è
        function startBatyaAttack() {
            finalBoss.currentAttack = 'batya';
            finalBoss.batyaPhase = 0; // 0 - —Å—Ç—É–∫ –∫—É–ª–∞–∫–æ–º, 1 - —Å–ø–∞–≤–Ω –±–∞—Ç–µ–π, 2 - –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏–µ, 3 - —Å—Ç—Ä–µ–ª—å–±–∞
            finalBoss.batyaTimer = 0;
            finalBoss.batyaPunchCount = 0;
            finalBoss.batyaShotsTotal = 5 + Math.floor(Math.random() * 6); // 5-10 –≤—ã—Å—Ç—Ä–µ–ª–æ–≤
            finalBoss.batyaShotsFired = 0;
            batyas = [];
            batyaLasers = [];
            devLog(`–ê—Ç–∞–∫–∞: –ë–ê–¢–Ø! (${finalBoss.batyaShotsTotal} –≤—ã—Å—Ç—Ä–µ–ª–æ–≤)`);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç–∞–∫–∏ –ë–∞—Ç—è
        function updateBatyaAttack(dt) {
            finalBoss.batyaTimer += dt;
            
            // –§–∞–∑–∞ 0: –°—Ç—É–∫ –∫—É–ª–∞–∫–æ–º (2 —É–¥–∞—Ä–∞)
            if (finalBoss.batyaPhase === 0) {
                if (finalBoss.batyaTimer > 0.5 && finalBoss.batyaPunchCount === 0) {
                    finalBoss.batyaPunchCount = 1;
                    playSound('tohaPunch', 0.6);
                    shakeScreen();
                    finalBoss.punchEffect = 1; // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞
                }
                if (finalBoss.batyaTimer > 1.0 && finalBoss.batyaPunchCount === 1) {
                    finalBoss.batyaPunchCount = 2;
                    playSound('tohaPunch', 0.7);
                    shakeScreen();
                    finalBoss.punchEffect = 1;
                }
                if (finalBoss.batyaTimer > 1.5) {
                    finalBoss.batyaPhase = 1;
                    finalBoss.batyaTimer = 0;
                }
            }
            // –§–∞–∑–∞ 1-3: –°–ø–∞–≤–Ω –±–∞—Ç–µ–π, –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏–µ, —Å—Ç—Ä–µ–ª—å–±–∞ (—Ü–∏–∫–ª)
            else if (finalBoss.batyaPhase >= 1) {
                // –°–ø–∞–≤–Ω–∏–º –Ω–æ–≤–æ–≥–æ –±–∞—Ç—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (batyas.length === 0 && finalBoss.batyaShotsFired < finalBoss.batyaShotsTotal) {
                    const batyaRoll = Math.random();
                    spawnBatya(); // –í—Å–µ–≥–¥–∞ 1 –±–∞—Ç—è
                    
                    // 50% —à–∞–Ω—Å —Å–ø–∞–≤–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ –±–∞—Ç–∏
                    if (batyaRoll < 0.5 && finalBoss.batyaShotsFired + 1 < finalBoss.batyaShotsTotal) {
                        setTimeout(() => spawnBatya(), 100);
                    }
                    // 25% —à–∞–Ω—Å —Å–ø–∞–≤–Ω–∞ —Ç—Ä–µ—Ç—å–µ–≥–æ –±–∞—Ç–∏
                    if (batyaRoll < 0.25 && finalBoss.batyaShotsFired + 2 < finalBoss.batyaShotsTotal) {
                        setTimeout(() => spawnBatya(), 200);
                    }
                }
            }
            
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ç–∞–∫–∏
            if (finalBoss.batyaShotsFired >= finalBoss.batyaShotsTotal && batyas.length === 0 && batyaLasers.length === 0) {
                finalBoss.currentAttack = null;
                // –ë–∞—Ç—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç 1 –∫–∞–∫–∞—à–∫—É!
                spawnPoops(1);
                finalBoss.attackTimer = 2; // –°–ª–µ–¥—É—é—â–∞—è –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                devLog('–ê—Ç–∞–∫–∞ –ë–∞—Ç—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –ø–æ—è–≤–∏–ª–∞—Å—å –∫–∞–∫–∞—à–∫–∞!');
            }
        }
        
        // –°–ø–∞–≤–Ω –æ–¥–Ω–æ–≥–æ –±–∞—Ç–∏
        function spawnBatya() {
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
            const side = Math.floor(Math.random() * 4);
            let x, y;
            
            if (side === 0) { // –°–≤–µ—Ä—Ö—É
                x = MAP_BOUNDS.minX + 100 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 200);
                y = MAP_BOUNDS.minY + 50;
            } else if (side === 1) { // –°–Ω–∏–∑—É
                x = MAP_BOUNDS.minX + 100 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 200);
                y = MAP_BOUNDS.maxY() - 50;
            } else if (side === 2) { // –°–ª–µ–≤–∞
                x = MAP_BOUNDS.minX + 50;
                y = MAP_BOUNDS.minY + 100 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 200);
            } else { // –°–ø—Ä–∞–≤–∞
                x = MAP_BOUNDS.maxX() - 50;
                y = MAP_BOUNDS.minY + 100 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 200);
            }
            
            batyas.push({
                x: x,
                y: y,
                radius: 45,
                phase: 0, // 0 - —Å–ª–µ–∂–µ–Ω–∏–µ, 1 - –∑–∞–º–µ—Ä (locked), 2 - —Å—Ç—Ä–µ–ª—å–±–∞
                timer: 0,
                trackDuration: 0.6, // 0.6 —Å–µ–∫—É–Ω–¥—ã —Å–ª–µ–∂–µ–Ω–∏—è (–±—ã–ª–æ 1.0)
                lockDuration: 0.5, // 0.5 —Å–µ–∫—É–Ω–¥—ã –∑–∞–º–∏—Ä–∞–Ω–∏—è - –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ–º–æ (–±—ã–ª–æ 1.0)
                aimAngle: 0,
                lockedAngle: 0, // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–≥–æ–ª
                fired: false
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—Ç–µ–π
        function updateBatyas(dt) {
            batyas = batyas.filter(batya => {
                batya.timer += dt;
                
                if (batya.phase === 0) {
                    // –§–∞–∑–∞ 0: –°–õ–ï–ñ–ï–ù–ò–ï - –ª–∞–∑–µ—Ä —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
                    batya.aimAngle = Math.atan2(player.y - batya.y, player.x - batya.x);
                    
                    if (batya.timer >= batya.trackDuration) {
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–º–∏—Ä–∞–Ω–∏—é
                        batya.phase = 1;
                        batya.timer = 0;
                        batya.lockedAngle = batya.aimAngle; // –§–∏–∫—Å–∏—Ä—É–µ–º —É–≥–æ–ª!
                    }
                } else if (batya.phase === 1) {
                    // –§–∞–∑–∞ 1: –ó–ê–ú–ò–†–ê–ù–ò–ï - –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É
                    // –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç —É–≤–µ—Ä–Ω—É—Ç—å—Å—è!
                    batya.aimAngle = batya.lockedAngle; // –î–µ—Ä–∂–∏–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–≥–æ–ª
                    
                    if (batya.timer >= batya.lockDuration && !batya.fired) {
                        // –°–¢–†–ï–õ–Ø–ï–ú!
                        batya.phase = 2;
                        batya.timer = 0;
                        batya.fired = true;
                        
                        playSound('burp', 0.7);
                        
                        batyaLasers.push({
                            startX: batya.x,
                            startY: batya.y,
                            angle: batya.lockedAngle, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–≥–æ–ª
                            length: 0,
                            maxLength: 6000, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —á—Ç–æ–±—ã –ª–∞–∑–µ—Ä —Ç–æ—á–Ω–æ –ø—Ä–æ–±–∏–≤–∞–ª –≤—Å—é –∫–∞—Ä—Ç—É
                            width: 30,
                            timer: 0,
                            duration: 0.8,
                            active: true
                        });
                        
                        finalBoss.batyaShotsFired++;
                    }
                } else if (batya.phase === 2) {
                    // –§–∞–∑–∞ 2: –ü–æ—Å–ª–µ –≤—ã—Å—Ç—Ä–µ–ª–∞ –∏—Å—á–µ–∑–∞–µ–º
                    if (batya.timer > 0.5) {
                        // –ß–∞—Å—Ç–∏—Ü—ã –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
                        for (let i = 0; i < 15; i++) {
                            particles.push({
                                x: batya.x + (Math.random() - 0.5) * 50,
                                y: batya.y + (Math.random() - 0.5) * 50,
                                vx: (Math.random() - 0.5) * 8,
                                vy: (Math.random() - 0.5) * 8,
                                radius: Math.random() * 6 + 3,
                                color: '#00ff00',
                                alpha: 1,
                                life: 0.6
                            });
                        }
                        return false; // –£–¥–∞–ª—è–µ–º –±–∞—Ç—é
                    }
                }
                
                return true;
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∞–∑–µ—Ä–æ–≤ –±–∞—Ç–∏
        function updateBatyaLasers(dt) {
            batyaLasers = batyaLasers.filter(laser => {
                laser.timer += dt;
                
                // –õ–∞–∑–µ—Ä –≤—ã—Ä–∞—Å—Ç–∞–µ—Ç
                if (laser.length < laser.maxLength) {
                    laser.length = Math.min(laser.maxLength, laser.length + 20000 * dt);
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∏–≥—Ä–æ–∫–∞
                if (laser.active) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ —Å –∫—Ä—É–≥–æ–º –∏–≥—Ä–æ–∫–∞
                    const dx = Math.cos(laser.angle);
                    const dy = Math.sin(laser.angle);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–µ–∫ –ø–æ –¥–ª–∏–Ω–µ –ª–∞–∑–µ—Ä–∞
                    for (let dist = 0; dist < laser.length; dist += 20) {
                        const lx = laser.startX + dx * dist;
                        const ly = laser.startY + dy * dist;
                        
                        const playerDist = Math.sqrt((lx - player.x)**2 + (ly - player.y)**2);
                        
                        if (playerDist < player.radius + laser.width / 2) {
                            // –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
                            if (player.shield > 0) {
                                player.shield--;
                                playSound('hit', 0.5);
                                laser.active = false;
                                
                                // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞
                                const pushAngle = laser.angle;
                                player.x += Math.cos(pushAngle) * 100;
                                player.y += Math.sin(pushAngle) * 100;
                                player.x = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.x));
                                player.y = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.y));
                                player.targetX = player.x;
                                player.targetY = player.y;
                            } else if (!godMode) {
                                gameOver();
                            }
                            break;
                        }
                    }
                }
                
                // –õ–∞–∑–µ—Ä –∏—Å—á–µ–∑–∞–µ—Ç
                if (laser.timer > laser.duration) {
                    laser.active = false;
                }
                
                return laser.timer < laser.duration + 0.3; // –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
            });
        }
        
        // –ù–∞—á–∞–ª–æ –∞—Ç–∞–∫–∏ "–î–∏–Ω–∞–º–∏–∫–∏"
        function startSpeakerAttack() {
            finalBoss.currentAttack = 'speakers';
            speakerAttack.phase = 0;
            speakerAttack.timer = 0;
            speakerAttack.spinCount = 0;
            speakerAttack.speakersSpawned = false;
            speakerAttack.musicPlaying = false;
            speakers = [];
            musicNotes = [];
            finalBoss.hasMicrophone = true;
            finalBoss.microphoneScale = 0;
            finalBoss.microphoneRotation = 0;
            devLog('–ê—Ç–∞–∫–∞: –î–ò–ù–ê–ú–ò–ö–ò!');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç–∞–∫–∏ "–î–∏–Ω–∞–º–∏–∫–∏"
        function updateSpeakerAttack(dt) {
            speakerAttack.timer += dt;
            const t = speakerAttack.timer;
            
            // –§–∞–∑–∞ 0: –î–æ—Å—Ç–∞—ë—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω (0-1 —Å–µ–∫)
            if (speakerAttack.phase === 0) {
                finalBoss.microphoneScale = Math.min(1, t * 2);
                
                if (t > 0.3 && !speakerAttack.whooshPlayed) {
                    speakerAttack.whooshPlayed = true;
                    playSound('whooshSfx', 0.6);
                }
                
                if (t >= 1) {
                    speakerAttack.phase = 1;
                    speakerAttack.timer = 0;
                    speakerAttack.spinCount = 0;
                }
            }
            // –§–∞–∑–∞ 1: –ö—Ä—É—Ç–∏—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω 2 —Ä–∞–∑–∞ (0-1.5 —Å–µ–∫)
            else if (speakerAttack.phase === 1) {
                finalBoss.microphoneRotation += dt * 20; // –ë—ã—Å—Ç—Ä–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
                
                // –ó–≤—É–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–æ—Ä–æ—Ç–µ
                if (t > 0.4 && speakerAttack.spinCount === 0) {
                    speakerAttack.spinCount = 1;
                    playSound('crashSpin', 0.5);
                }
                if (t > 1.0 && speakerAttack.spinCount === 1) {
                    speakerAttack.spinCount = 2;
                    playSound('crashSpin', 0.5);
                }
                
                if (t >= 1.5) {
                    speakerAttack.phase = 2;
                    speakerAttack.timer = 0;
                    finalBoss.microphoneRotation = 0; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ
                }
            }
            // –§–∞–∑–∞ 2: –ü–æ–¥–Ω–æ—Å–∏—Ç –∫ –ª–∏—Ü—É –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–µ—Ç—å (0-1 —Å–µ–∫)
            else if (speakerAttack.phase === 2) {
                finalBoss.singing = true;
                
                if (t >= 0.5 && !speakerAttack.musicPlaying) {
                    speakerAttack.musicPlaying = true;
                    playMusic('baobabMusic', 0.5, false); // –ú—É–∑—ã–∫–∞ –±–∞–æ–±–∞–±!
                }
                
                if (t >= 1) {
                    speakerAttack.phase = 3;
                    speakerAttack.timer = 0;
                }
            }
            // –§–∞–∑–∞ 3: –î–∏–Ω–∞–º–∏–∫–∏ –ø–∞–¥–∞—é—Ç —Å –Ω–µ–±–∞ (0-2 —Å–µ–∫)
            else if (speakerAttack.phase === 3) {
                if (!speakerAttack.speakersSpawned) {
                    speakerAttack.speakersSpawned = true;
                    
                    // –°–ø–∞–≤–Ω–∏–º 2 –¥–∏–Ω–∞–º–∏–∫–∞
                    speakers.push({
                        x: finalBoss.x - 150,
                        y: -100,
                        targetY: finalBoss.y,
                        width: 80,
                        height: 120,
                        falling: true,
                        pulse: 0,
                        side: 'left'
                    });
                    speakers.push({
                        x: finalBoss.x + 150,
                        y: -100,
                        targetY: finalBoss.y,
                        width: 80,
                        height: 120,
                        falling: true,
                        pulse: 0,
                        side: 'right'
                    });
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è
                speakers.forEach(sp => {
                    if (sp.falling) {
                        sp.y += 15;
                        if (sp.y >= sp.targetY) {
                            sp.y = sp.targetY;
                            sp.falling = false;
                            playSound('metalPipe', 0.4);
                            shakeScreen();
                        }
                    }
                });
                
                // –ö–æ–≥–¥–∞ –æ–±–∞ —É–ø–∞–ª–∏ - –Ω–∞—á–∏–Ω–∞–µ–º —Å—Ç—Ä–µ–ª—è—Ç—å
                if (speakers.every(sp => !sp.falling) && t > 1.5) {
                    speakerAttack.phase = 4;
                    speakerAttack.timer = 0;
                    speakerAttack.noteTimer = 0;
                }
            }
            // –§–∞–∑–∞ 4: –î–∏–Ω–∞–º–∏–∫–∏ —Å—Ç—Ä–µ–ª—è—é—Ç –Ω–æ—Ç–∞–º–∏ (15 —Å–µ–∫—É–Ω–¥)
            else if (speakerAttack.phase === 4) {
                // –ü—É–ª—å—Å–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏–∫–æ–≤
                speakers.forEach(sp => {
                    sp.pulse = Math.sin(t * 10) * 0.2;
                });
                
                // –°—Ç—Ä–µ–ª—è–µ–º –Ω–æ—Ç–∞–º–∏ —Ö–∞–æ—Ç–∏—á–Ω–æ
                speakerAttack.noteTimer = (speakerAttack.noteTimer || 0) + dt;
                
                // –í low mode - –ù–ê–ú–ù–û–ì–û —Ä–µ–∂–µ —Å—Ç—Ä–µ–ª—è–µ–º –∏ –º–µ–Ω—å—à–µ –Ω–æ—Ç
                const maxNotes = lowGraphics ? 8 : 100; // –û—á–µ–Ω—å –º–∞–ª–æ –Ω–æ—Ç –≤ low mode
                const baseFireRate = lowGraphics ? 0.6 : 0.15; // –û—á–µ–Ω—å —Ä–µ–¥–∫–æ —Å—Ç—Ä–µ–ª—è–µ–º –≤ low mode
                const minFireRate = lowGraphics ? 0.4 : 0.05;
                const fireRate = baseFireRate - Math.min(baseFireRate - minFireRate, t * 0.005);
                
                if (speakerAttack.noteTimer > fireRate && musicNotes.length < maxNotes) {
                    speakerAttack.noteTimer = 0;
                    
                    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –¥–∏–Ω–∞–º–∏–∫
                    const sp = speakers[Math.floor(Math.random() * speakers.length)];
                    
                    // –•–∞–æ—Ç–∏—á–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å —É–∫–ª–æ–Ω–æ–º –∫ –∏–≥—Ä–æ–∫—É
                    const angleToPlayer = Math.atan2(player.y - sp.y, player.x - sp.x);
                    const randomSpread = (Math.random() - 0.5) * 1.5; // –®–∏—Ä–æ–∫–∏–π —Ä–∞–∑–±—Ä–æ—Å
                    const angle = angleToPlayer + randomSpread;
                    const speed = 8 + Math.random() * 6;
                    
                    // –†–∞–∑–Ω—ã–µ –Ω–æ—Ç—ã (–º–µ–Ω—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤ low mode)
                    const notes = lowGraphics ? ['üéµ', '‚ô™'] : ['üéµ', 'üé∂', 'üéº', '‚ô™', '‚ô´'];
                    
                    musicNotes.push({
                        x: sp.x,
                        y: sp.y - 30,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        icon: notes[Math.floor(Math.random() * notes.length)],
                        rotation: 0, // –ë–µ–∑ –≤—Ä–∞—â–µ–Ω–∏—è –≤ low mode –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                        rotSpeed: lowGraphics ? 0 : (Math.random() - 0.5) * 0.3,
                        size: lowGraphics ? 30 : (25 + Math.random() * 15),
                        color: lowGraphics ? '#ff00ff' : `hsl(${Math.random() * 360}, 80%, 60%)`
                    });
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ—Ç—ã
                updateMusicNotes(dt);
                
                // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ç–∞–∫–∏ –ø–æ—Å–ª–µ 15 —Å–µ–∫—É–Ω–¥
                if (t > 15) {
                    speakerAttack.phase = 5;
                    speakerAttack.timer = 0;
                    stopMusic(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Baobab
                    finalBoss.singing = false;
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å—Ç–∞–¥–∏–∏
                    if (finalBoss.stage >= 2 || finalBoss.hasWings) {
                        playMusic('stage2Music', 0.5); // DOOM
                    } else {
                        playMusic('stage1Music', 0.5); // Unknown Background Music
                    }
                }
            }
            // –§–∞–∑–∞ 5: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ (–¥–∏–Ω–∞–º–∏–∫–∏ —É–ª–µ—Ç–∞—é—Ç)
            else if (speakerAttack.phase === 5) {
                finalBoss.hasMicrophone = false;
                
                // –î–∏–Ω–∞–º–∏–∫–∏ —É–ª–µ—Ç–∞—é—Ç –≤–≤–µ—Ä—Ö
                speakers.forEach(sp => {
                    sp.y -= 15;
                });
                
                // –û—á–∏—â–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –Ω–æ—Ç—ã
                updateMusicNotes(dt);
                
                if (t > 2) {
                    finalBoss.currentAttack = null;
                    speakers = [];
                    musicNotes = [];
                    finalBoss.attackTimer = 2; // –°–ª–µ–¥—É—é—â–∞—è –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    devLog('–ê—Ç–∞–∫–∞ –î–∏–Ω–∞–º–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –Ω–æ—Ç
        function updateMusicNotes(dt) {
            musicNotes = musicNotes.filter(note => {
                note.x += note.vx;
                note.y += note.vy;
                note.rotation += note.rotSpeed;
                
                // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–∫–æ–º
                const dx = note.x - player.x;
                const dy = note.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < player.radius + 15) {
                    if (player.shield > 0) {
                        player.shield--;
                        playSound('hit', 0.4);
                        return false;
                    } else if (!godMode) {
                        gameOver();
                        return false;
                    }
                }
                
                // –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ –≤—ã—à–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
                return note.x > -50 && note.x < canvas.width + 50 && 
                       note.y > -50 && note.y < canvas.height + 50;
            });
        }
        
        // ==================== –ê–¢–ê–ö–ê –ú–ê–®–ò–ù–ê (–°–¢–ê–î–ò–Ø 2 - FINAL v4) ====================
        function startCarAttack() {
            // Set state identifiers
            finalBoss.currentAttack = 'car';
            finalBoss.carAttackUsed = true;
            finalBoss.attackTimer = 0;
            
            // Set render flag ACTIVE!
            carAttack.active = true;
            
            stopMusic(); // Stop previous music
            
            // Initialize global state object
            carAttack.phase = 'warmup';
            carAttack.timer = 0;
            carAttack.passCount = 0;
            carAttack.maxPasses = 20; // 20 passes
            carAttack.exhaust = []; // Reset exhaust particles
            
            // Initialize car properties - –£–í–ï–õ–ò–ß–ï–ù–ù–ê–Ø –ú–ê–®–ò–ù–ê
            carAttack.car = {
                x: -500,
                y: 0,
                width: 280,  // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 200 –¥–æ 280
                height: 140, // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 100 –¥–æ 140
                speed: 0,
                laneY: 0
            };
            
            // Audio
            carAttack.engineAudio = playSound('carEngine');
            carAttack.musicAudio = null; // Will start later
            
            shakeScreen();
            console.log('START CAR ATTACK: ACTIVE = TRUE');
        }

        function updateCarAttack(dt) {
            if (!carAttack.active) return;
            
            carAttack.timer += dt;
            
            // Update exhaust particles
            if (carAttack.exhaust) {
                carAttack.exhaust = carAttack.exhaust.filter(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.alpha -= dt * 2;
                    p.size += dt * 10;
                    return p.alpha > 0;
                });
            } else {
                carAttack.exhaust = [];
            }
            
            // --- PHASE 1: WARMUP (7 Seconds) ---
            if (carAttack.phase === 'warmup') {
                if (Math.random() < 0.1) shakeScreen();
                
                if (carAttack.timer >= 7.0) {
                    // Transition to ACTIVE
                    carAttack.phase = 'active';
                    carAttack.subPhase = 'warning';
                    carAttack.timer = 0;
                    
                    // Stop Engine
                    if (carAttack.engineAudio) {
                        carAttack.engineAudio.pause();
                        carAttack.engineAudio = null;
                    }
                    
                    // Start Music
                    carAttack.musicAudio = new Audio(SOUNDS.carMusic);
                    carAttack.musicAudio.volume = 0.6;
                    carAttack.musicAudio.loop = true;
                    carAttack.musicAudio.play().catch(e => {});
                    window.currentCarMusic = carAttack.musicAudio;
                    
                    // Initial Setup for first pass
                    setupNextCarPass();
                }
                return;
            }
            
            // --- PHASE 2: ACTIVE (Looping) ---
            if (carAttack.phase === 'active') {
                // Sub-phase: WARNING (0.6s)
                if (carAttack.subPhase === 'warning') {
                    if (carAttack.timer >= 0.6) {
                        carAttack.subPhase = 'dash';
                        carAttack.timer = 0;
                        
                        // Set car speed and position for the dash
                        // ALTERNATING DIRECTION: Even = Right, Odd = Left
                        const isRight = (carAttack.passCount % 2 === 0);
                        
                        if (isRight) {
                            carAttack.car.x = MAP_BOUNDS.minX - 300;
                            carAttack.car.speed = 4000; // Right
                        } else {
                            carAttack.car.x = MAP_BOUNDS.maxX() + 100;
                            carAttack.car.speed = -4000; // Left
                        }
                        
                        // –ó–ê–î–ê–ß–ê 1: –£–±—Ä–∞–ª–∏ –∑–≤—É–∫ "Fa" –ø—Ä–∏ –ø—Ä–æ–ª–µ—Ç–µ –º–∞—à–∏–Ω—ã
                        // playSound('dash', 0.4);
                    }
                }
                // Sub-phase: DASH
                else if (carAttack.subPhase === 'dash') {
                    // Move Car
                    carAttack.car.x += carAttack.car.speed * dt;
                    
                    // Create exhaust particles
                    if (Math.random() < 0.8) {
                        const isMovingRight = carAttack.car.speed > 0;
                        const spawnX = isMovingRight ? carAttack.car.x : carAttack.car.x + carAttack.car.width;
                        const spawnY = carAttack.car.laneY + carAttack.car.height - 20; // Near wheels
                        
                        carAttack.exhaust.push({
                            x: spawnX,
                            y: spawnY + (Math.random() - 0.5) * 20,
                            vx: (isMovingRight ? -1 : 1) * (Math.random() * 50 + 50), // Opposite to movement
                            vy: (Math.random() - 0.5) * 20,
                            size: 10 + Math.random() * 10,
                            alpha: 0.6,
                            color: Math.random() > 0.5 ? '#555' : '#888'
                        });
                    }
                    
                    // Collision Check
                    if (checkCarCollision()) {
                        if (player.shield > 0) {
                            player.shield--;
                            playSound('hit', 0.5);
                            // Knockback
                            const knockDir = carAttack.car.speed > 0 ? 1 : -1;
                            player.x += knockDir * 100;
                            player.targetX += knockDir * 100;
                        } else if (!godMode) {
                            playSound('hit', 0.5);
                            gameOver();
                        }
                    }
                    
                    // Check if car is off screen (end of dash)
                    const isOffScreen = (carAttack.car.speed > 0 && carAttack.car.x > canvas.width + 200) ||
                                      (carAttack.car.speed < 0 && carAttack.car.x < -400);
                                      
                    if (isOffScreen) {
                        carAttack.passCount++;
                        if (carAttack.passCount >= carAttack.maxPasses) {
                            endCarAttack();
                        } else {
                            setupNextCarPass();
                        }
                    }
                }
            }
        }
        
        function setupNextCarPass() {
            carAttack.subPhase = 'warning';
            carAttack.timer = 0;
            
            // Random Y position for the lane
            const minY = MAP_BOUNDS.minY + 50;
            const maxY = MAP_BOUNDS.maxY() - 150;
            carAttack.car.laneY = minY + Math.random() * (maxY - minY);
            
            // Play Warning Sound
            playSound('carWarning', 0.5);
        }
        
        function checkCarCollision() {
            // Simple AABB collision with reduced hitbox for fairness
            const hitMargin = 20;
            return (
                player.x + player.radius > carAttack.car.x + hitMargin &&
                player.x - player.radius < carAttack.car.x + carAttack.car.width - hitMargin &&
                player.y + player.radius > carAttack.car.laneY + hitMargin &&
                player.y - player.radius < carAttack.car.laneY + carAttack.car.height - hitMargin
            );
        }

        function renderCarAttack() {
            // RENDER WARMUP TEXT - REMOVED
            
            // RENDER RED ZONE (Warning)
            if (carAttack.phase === 'active' && (carAttack.subPhase === 'warning' || carAttack.subPhase === 'dash')) {
                ctx.save();
                ctx.fillStyle = 'rgba(255, 0, 0, 0.4)';
                ctx.fillRect(0, carAttack.car.laneY, canvas.width, carAttack.car.height);
                
                // Dashed lines
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.setLineDash([20, 20]);
                ctx.beginPath();
                ctx.moveTo(0, carAttack.car.laneY);
                ctx.lineTo(canvas.width, carAttack.car.laneY);
                ctx.moveTo(0, carAttack.car.laneY + carAttack.car.height);
                ctx.lineTo(canvas.width, carAttack.car.laneY + carAttack.car.height);
                ctx.stroke();
                ctx.restore();
            }
            
            // RENDER EXHAUST
            if (carAttack.exhaust) {
                carAttack.exhaust.forEach(p => {
                    ctx.save();
                    ctx.globalAlpha = p.alpha;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
            }
            
            // RENDER CAR
            if (carAttack.phase === 'active' && carAttack.subPhase === 'dash') {
                ctx.save();
                
                if (carImg && carImg.complete) {
                    // Draw Image with Flip logic
                    ctx.translate(carAttack.car.x + carAttack.car.width/2, carAttack.car.laneY + carAttack.car.height/2);
                    
                    // The image faces LEFT by default.
                    // If speed > 0 (moving right), we need to FLIP it horizontally.
                    if (carAttack.car.speed > 0) {
                        ctx.scale(-1, 1);
                    }
                    
                    // Draw image centered
                    ctx.drawImage(carImg, -carAttack.car.width/2, -carAttack.car.height/2, carAttack.car.width, carAttack.car.height);
                    
                    // Draw transparent hitbox for debug/fallback (optional, but good for gameplay clarity if image has weird transparency)
                    // ctx.strokeStyle = 'rgba(0, 100, 255, 0.5)';
                    // ctx.strokeRect(-carAttack.car.width/2, -carAttack.car.height/2, carAttack.car.width, carAttack.car.height);
                    
                } else {
                    // Fallback: Blue Rectangle
                    ctx.fillStyle = 'rgba(0, 102, 255, 0.5)'; // Semi-transparent blue
                    ctx.fillRect(carAttack.car.x, carAttack.car.laneY, carAttack.car.width, carAttack.car.height);
                    
                    // Border
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(carAttack.car.x, carAttack.car.laneY, carAttack.car.width, carAttack.car.height);
                    
                    ctx.fillStyle = 'white';
                    ctx.font = '20px Arial';
                    ctx.fillText('CAR', carAttack.car.x + 20, carAttack.car.laneY + 50);
                }
                
                ctx.restore();
            }
        }

        function endCarAttack() {
            carAttack.active = false;
            stopCarSounds();
            
            finalBoss.currentAttack = null;
            finalBoss.attackTimer = 2.0;
            
            // Resume Boss Music
            playMusic('stage2Music', 0.5);
            console.log('END CAR ATTACK');
        }


        // === –ê–¢–ê–ö–ê: –û–ì–ù–ï–ù–ù–ê–Ø –ü–õ–ê–¢–§–û–†–ú–ê –ò –ó–ú–ï–ò ===
        let firePlatformAttack = {
            active: false,
            phase: 0, // 0 - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 1 - –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, 2 - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, 3 - –∏–≥—Ä–∞ —Å–æ –∑–º–µ—è–º–∏, 4 - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            timer: 0,
            platformY: 0, // –í—ã—Å–æ—Ç–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            duration: 25, // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ç–∞–∫–∏ (—Å–µ–∫—É–Ω–¥—ã)
            timeLeft: 25,
            warningZone: null, // –ó–æ–Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            instructionsShown: false
        };
        let fireSnakes = []; // –û–≥–Ω–µ–Ω–Ω—ã–µ –∑–º–µ–∏
        let originalGravityEnabled = false; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏
        let originalPlayerControl = 'cursor'; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

        function stopCarSounds() {
            if (carAttack.engineAudio) {
                try { carAttack.engineAudio.pause(); } catch(e){}
                carAttack.engineAudio = null;
            }
            if (carAttack.musicAudio) {
                try { carAttack.musicAudio.pause(); } catch(e){}
                carAttack.musicAudio = null;
            }
        }

        // ==================== –ê–¢–ê–ö–ê –õ–ê–ë–ò–†–ò–ù–¢ (–°–¢–ê–î–ò–Ø 2) ====================
        function startLabyrinthAttack() {
            finalBoss.currentAttack = 'labyrinth';
            finalBoss.labyrinthAttackUsed = true;
            labyrinthAttack.active = true;
            labyrinthAttack.phase = 0; // –ö–∞—Ç—Å—Ü–µ–Ω–∞ –∑–∞—Ö–≤–∞—Ç–∞
            labyrinthAttack.timer = 0;
            labyrinthAttack.timeLeft = labyrinthAttack.timeLimit;
            labyrinthAttack.buildProgress = 0;
            labyrinthAttack.hammerRotation = 0;
            labyrinthAttack.timerVisible = false;
            labyrinthAttack.bellPlayed = false; // –í–ê–ñ–ù–û: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞—Ç–∞–∫–∏
            labyrinthWalls = [];
            labyrinthBonuses = [];
            
            player.canMove = false; // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –≤—Ä–µ–º—è –∫–∞—Ç—Å—Ü–µ–Ω—ã
            stopMusic(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º—É–∑—ã–∫—É —Å—Ç–∞–¥–∏–∏ 2
            
            // –ü—Ä—è—á–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤–∏–¥–µ–Ω
            document.getElementById('labyrinthTimer').classList.remove('visible');
            
            devLog('–ê—Ç–∞–∫–∞: –õ–ê–ë–ò–†–ò–ù–¢!');
        }

        function updateLabyrinthAttack(dt) {
            labyrinthAttack.timer += dt;
            const t = labyrinthAttack.timer;
            
            // –≠—Ç–∞–ø 1: –ö–∞—Ç—Å—Ü–µ–Ω–∞ –∑–∞—Ö–≤–∞—Ç–∞ (0-5 —Å–µ–∫)
            if (labyrinthAttack.phase === 0) {
                // –§–∞–∑–∞ 0: –ö–∞–º–µ—Ä–∞ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –ò–≤–∞–Ω—É (0-1 —Å–µ–∫)
                if (t < 1) {
                    camera.targetZoom = 2.5;
                    camera.targetX = finalBoss.x - canvas.width/2;
                    camera.targetY = finalBoss.y - canvas.height/2;
                }
                // –§–∞–∑–∞ 1: –ò–≤–∞–Ω —Å–º–µ–µ—Ç—Å—è (1-3 —Å–µ–∫)
                else if (t >= 1 && t < 1.1) {
                    playSound('evilLaugh', 0.8);
                }
                // –§–∞–∑–∞ 2: –ò–≤–∞–Ω –ø–æ–¥–ª–µ—Ç–∞–µ—Ç –∫ –∏–≥—Ä–æ–∫—É (3-4.5 —Å–µ–∫)
                else if (t >= 3 && t < 4.5) {
                    finalBoss.x += (player.x - finalBoss.x) * 0.15;
                    finalBoss.y += (player.y - finalBoss.y) * 0.15;
                    camera.targetX = finalBoss.x - canvas.width/2;
                    camera.targetY = finalBoss.y - canvas.height/2;
                }
                // –§–∞–∑–∞ 3: –ò–≤–∞–Ω —Ö–≤–∞—Ç–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤–Ω–∏–∑ (4.5-5 —Å–µ–∫)
                else if (t >= 4.5) {
                    const targetX = canvas.width / 2;
                    const targetY = canvas.height / 2 + 100;
                    player.x += (targetX - player.x) * 0.2;
                    player.y += (targetY - player.y) * 0.2;
                    player.targetX = player.x;
                    player.targetY = player.y;
                    
                    // –ò–≤–∞–Ω —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
                    finalBoss.x += (player.x - finalBoss.x) * 0.2;
                    finalBoss.y += ((player.y - 80) - finalBoss.y) * 0.2;
                    
                    // –ö–∞–º–µ—Ä–∞ –ø–ª–∞–≤–Ω–æ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
                    camera.targetX = player.x - canvas.width/2;
                    camera.targetY = player.y - canvas.height/2;
                    camera.targetZoom = 1.5;
                }
                
                if (t >= 5) {
                    labyrinthAttack.phase = 1;
                    labyrinthAttack.timer = 0;
                    // –ò–≤–∞–Ω –±–µ—Ä–µ—Ç –º–æ–ª–æ—Ç–æ–∫
                    finalBoss.hasHammer = true;
                }
            }
            // –≠—Ç–∞–ø 2: –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ (0-8 —Å–µ–∫)
            else if (labyrinthAttack.phase === 1) {
                labyrinthAttack.buildProgress = Math.min(1, t / 8);
                labyrinthAttack.hammerRotation += dt * 10; // –ë—ã—Å—Ç—Ä–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –º–æ–ª–æ—Ç–∫–∞
                
                // –ò–≤–∞–Ω –±—ã—Å—Ç—Ä–æ –ª–µ—Ç–∞–µ—Ç –≤–æ–∫—Ä—É–≥ –∏–≥—Ä–æ–∫–∞
                const flyRadius = 200 - labyrinthAttack.buildProgress * 50;
                const flyAngle = t * 3; // –ë—ã—Å—Ç—Ä–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
                finalBoss.x = player.x + Math.cos(flyAngle) * flyRadius;
                finalBoss.y = player.y + Math.sin(flyAngle) * flyRadius;
                
                // –ó–≤—É–∫–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ - –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
                if (t > 0.5 && t < 0.6) {
                    playSound('buildingPutaway', 0.6);
                }
                if (t > 1.5 && t < 1.6) {
                    playSound('legoConstruction', 0.6);
                }
                if (t > 3 && t < 3.1) {
                    playSound('hammerHd', 0.6);
                }
                if (t > 4.5 && t < 4.6) {
                    playSound('buildingPutaway', 0.5);
                }
                if (t > 6 && t < 6.1) {
                    playSound('hammerHd', 0.7);
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–µ–Ω—ã –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
                if (labyrinthWalls.length === 0 && t > 1) {
                    generateLabyrinth();
                }
                
                // –ö–∞–º–µ—Ä–∞ –æ—Ç–¥–∞–ª—è–µ—Ç—Å—è —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å—å –ª–∞–±–∏—Ä–∏–Ω—Ç
                camera.targetZoom = 0.8;
                camera.targetX = player.x - canvas.width/2;
                camera.targetY = player.y - canvas.height/2;
                
                if (t >= 8) {
                    labyrinthAttack.phase = 2;
                    labyrinthAttack.timer = 0;
                    finalBoss.hasHammer = false;
                }
            }
            // –≠—Ç–∞–ø 3: –ó–∞–ø—É—Å–∫ –æ—Ç—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ (0-2 —Å–µ–∫)
            else if (labyrinthAttack.phase === 2) {
                if (t > 0.5 && !labyrinthAttack.bellPlayed) {
                    labyrinthAttack.bellPlayed = true;
                    playSound('godBell', 0.7);
                    labyrinthAttack.timerVisible = true;
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                    document.getElementById('labyrinthTimer').classList.add('visible');
                }
                
                if (t >= 2) {
                    labyrinthAttack.phase = 3;
                    labyrinthAttack.timer = 0;
                    player.canMove = true; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
                    camera.targetZoom = 1;
                    
                    // –°–ø–∞–≤–Ω–∏–º –±–æ–Ω—É—Å—ã –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ
                    spawnLabyrinthBonuses();
                }
            }
            // –≠—Ç–∞–ø 4: –ò–≥—Ä–∞ –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ
            else if (labyrinthAttack.phase === 3) {
                labyrinthAttack.timeLeft -= dt;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ç–∞–π–º–µ—Ä–∞
                const timerEl = document.getElementById('labyrinthTimer');
                timerEl.textContent = `‚è±Ô∏è ${Math.ceil(labyrinthAttack.timeLeft)}`;
                
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è (< 10 —Å–µ–∫—É–Ω–¥)
                if (labyrinthAttack.timeLeft < 10) {
                    timerEl.classList.add('critical');
                } else {
                    timerEl.classList.remove('critical');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ —Å —É—á–µ—Ç–æ–º —Å—Ç–µ–Ω –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
                checkLabyrinthCollisions();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã
                labyrinthBonuses = labyrinthBonuses.filter(bonus => {
                    const dx = bonus.x - player.x;
                    const dy = bonus.y - player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < player.radius + 20) {
                        // –ü–æ–¥–æ–±—Ä–∞–ª–∏ –±–æ–Ω—É—Å - –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –≤—Ä–µ–º—è
                        labyrinthAttack.timeLeft += 5;
                        playSound('powerup', 0.5);
                        devLog('+5 —Å–µ–∫—É–Ω–¥!');
                        return false;
                    }
                    bonus.pulse += dt * 3;
                    return true;
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
                const exitDist = Math.sqrt((player.x - labyrinthAttack.exitX)**2 + (player.y - labyrinthAttack.exitY)**2);
                if (exitDist < player.radius + 30) {
                    // –ò–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª—Å—è!
                    endLabyrinthAttack(true);
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
                if (labyrinthAttack.timeLeft <= 0) {
                    // –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ - –∏–≥—Ä–æ–∫ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç
                    endLabyrinthAttack(false);
                    return;
                }
            }
        }

        function generateLabyrinth() {
            // –£–°–õ–û–ñ–ù–Å–ù–ù–´–ô –õ–ê–ë–ò–†–ò–ù–¢ - –ê–ª–≥–æ—Ä–∏—Ç–º Recursive Backtracking
            const centerX = player.x;
            const centerY = player.y;
            const cellSize = 70; // –ü—Ä–æ—Ö–æ–¥—ã –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à–∏—Ä–æ–∫–∏–µ
            const gridSize = 15; // –ë–æ–ª—å—à–µ –∫–ª–µ—Ç–æ–∫ = —Å–ª–æ–∂–Ω–µ–µ –ª–∞–±–∏—Ä–∏–Ω—Ç
            
            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É - –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤—Å–µ —Å—Ç–µ–Ω—ã
            const grid = [];
            const visited = [];
            for (let y = 0; y < gridSize; y++) {
                grid[y] = [];
                visited[y] = [];
                for (let x = 0; x < gridSize; x++) {
                    grid[y][x] = true; // true = —Å—Ç–µ–Ω–∞
                    visited[y][x] = false;
                }
            }
            
            // Recursive Backtracking –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
            function carvePath(x, y) {
                visited[y][x] = true;
                grid[y][x] = false; // –£–±–∏—Ä–∞–µ–º —Å—Ç–µ–Ω—É
                
                // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –≤–≤–µ—Ä—Ö, –≤–ø—Ä–∞–≤–æ, –≤–Ω–∏–∑, –≤–ª–µ–≤–æ
                const directions = [
                    {dx: 0, dy: -1},
                    {dx: 1, dy: 0},
                    {dx: 0, dy: 1},
                    {dx: -1, dy: 0}
                ];
                
                // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
                for (let i = directions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [directions[i], directions[j]] = [directions[j], directions[i]];
                }
                
                for (let dir of directions) {
                    const nx = x + dir.dx * 2;
                    const ny = y + dir.dy * 2;
                    
                    if (nx >= 1 && nx < gridSize - 1 && ny >= 1 && ny < gridSize - 1 && !visited[ny][nx]) {
                        // –£–±–∏—Ä–∞–µ–º —Å—Ç–µ–Ω—É –º–µ–∂–¥—É —Ç–µ–∫—É—â–µ–π –∏ —Å–ª–µ–¥—É—é—â–µ–π –∫–ª–µ—Ç–∫–æ–π
                        grid[y + dir.dy][x + dir.dx] = false;
                        carvePath(nx, ny);
                    }
                }
            }
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Å —Ü–µ–Ω—Ç—Ä–∞
            let startX = Math.floor(gridSize / 2);
            let startY = Math.floor(gridSize / 2);
            if (startX % 2 === 0) startX--;
            if (startY % 2 === 0) startY--;
            carvePath(startX, startY);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—ã –¥–ª—è —É—Å–ª–æ–∂–Ω–µ–Ω–∏—è (–±–æ–ª—å—à–µ –ø—É—Ç–µ–π = –±–æ–ª—å—à–µ —Ç—É–ø–∏–∫–æ–≤)
            const extraPaths = 8 + Math.floor(Math.random() * 8); // 8-16 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ö–æ–¥–æ–≤
            for (let i = 0; i < extraPaths; i++) {
                const rx = 1 + Math.floor(Math.random() * (gridSize - 2));
                const ry = 1 + Math.floor(Math.random() * (gridSize - 2));
                if (grid[ry][rx]) {
                    grid[ry][rx] = false;
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –≤—ã—Ö–æ–¥ –≤ —Å–ª—É—á–∞–π–Ω–æ–º —É–≥–ª—É (–ù–ï –≤ —Ü–µ–Ω—Ç—Ä–µ!)
            const exitSide = Math.floor(Math.random() * 4);
            let exitCol, exitRow;
            
            if (exitSide === 0) { // –í–µ—Ä—Ö
                exitCol = 1 + Math.floor(Math.random() * (gridSize - 2));
                exitRow = 0;
                grid[0][exitCol] = false;
                grid[1][exitCol] = false;
                labyrinthAttack.exitX = centerX - (gridSize * cellSize) / 2 + exitCol * cellSize + cellSize/2;
                labyrinthAttack.exitY = centerY - (gridSize * cellSize) / 2 - 20;
            } else if (exitSide === 1) { // –ü—Ä–∞–≤–æ
                exitCol = gridSize - 1;
                exitRow = 1 + Math.floor(Math.random() * (gridSize - 2));
                grid[exitRow][gridSize-1] = false;
                grid[exitRow][gridSize-2] = false;
                labyrinthAttack.exitX = centerX + (gridSize * cellSize) / 2 + 20;
                labyrinthAttack.exitY = centerY - (gridSize * cellSize) / 2 + exitRow * cellSize + cellSize/2;
            } else if (exitSide === 2) { // –ù–∏–∑
                exitCol = 1 + Math.floor(Math.random() * (gridSize - 2));
                exitRow = gridSize - 1;
                grid[gridSize-1][exitCol] = false;
                grid[gridSize-2][exitCol] = false;
                labyrinthAttack.exitX = centerX - (gridSize * cellSize) / 2 + exitCol * cellSize + cellSize/2;
                labyrinthAttack.exitY = centerY + (gridSize * cellSize) / 2 + 20;
            } else { // –õ–µ–≤–æ
                exitCol = 0;
                exitRow = 1 + Math.floor(Math.random() * (gridSize - 2));
                grid[exitRow][0] = false;
                grid[exitRow][1] = false;
                labyrinthAttack.exitX = centerX - (gridSize * cellSize) / 2 - 20;
                labyrinthAttack.exitY = centerY - (gridSize * cellSize) / 2 + exitRow * cellSize + cellSize/2;
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
            const labWidth = gridSize * cellSize;
            const labHeight = gridSize * cellSize;
            const left = centerX - labWidth/2;
            const top = centerY - labHeight/2;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ç–∫—É –≤ —Å—Ç–µ–Ω—ã (–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏)
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    if (grid[y][x]) {
                        // –≠—Ç–æ —Å—Ç–µ–Ω–∞ - —Å–æ–∑–¥–∞–µ–º –±–ª–æ–∫
                        labyrinthWalls.push({
                            x: left + x * cellSize,
                            y: top + y * cellSize,
                            width: cellSize,
                            height: cellSize,
                            alpha: 0
                        });
                    }
                }
            }
            
            // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–Ω
            labyrinthWalls.forEach((wall, i) => {
                setTimeout(() => {
                    if (labyrinthWalls[i]) labyrinthWalls[i].alpha = 1;
                }, i * 3);
            });
            
            devLog(`–õ–∞–±–∏—Ä–∏–Ω—Ç —Å–æ–∑–¥–∞–Ω: ${labyrinthWalls.length} —Å—Ç–µ–Ω, –≤—ã—Ö–æ–¥ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ ${exitSide}`);
        }

        function spawnLabyrinthBonuses() {
            // –°–ø–∞–≤–Ω–∏–º 5-8 –±–æ–Ω—É—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
            const count = 5 + Math.floor(Math.random() * 4);
            for (let i = 0; i < count; i++) {
                let x, y, attempts = 0;
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ
                do {
                    x = player.x + (Math.random() - 0.5) * 500;
                    y = player.y + (Math.random() - 0.5) * 500;
                    attempts++;
                } while (checkWallCollision(x, y, 20) && attempts < 20);
                
                if (attempts < 20) {
                    labyrinthBonuses.push({
                        x: x,
                        y: y,
                        pulse: Math.random() * Math.PI * 2
                    });
                }
            }
        }

        function checkLabyrinthCollisions() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ —Å–æ —Å—Ç–µ–Ω–∞–º–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
            labyrinthWalls.forEach(wall => {
                if (wall.alpha < 1) return; // –°—Ç–µ–Ω–∞ –µ—â–µ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å
                
                const nearestX = Math.max(wall.x, Math.min(player.x, wall.x + wall.width));
                const nearestY = Math.max(wall.y, Math.min(player.y, wall.y + wall.height));
                
                const dx = player.x - nearestX;
                const dy = player.y - nearestY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < player.radius) {
                    // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞ –æ—Ç —Å—Ç–µ–Ω—ã
                    if (dist > 0) {
                        const pushX = (dx / dist) * (player.radius - dist);
                        const pushY = (dy / dist) * (player.radius - dist);
                        player.x += pushX;
                        player.y += pushY;
                        player.targetX = player.x;
                        player.targetY = player.y;
                    }
                }
            });
        }

        function checkWallCollision(x, y, radius) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å—Ç–µ–Ω–∞ –≤ –¥–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            for (let wall of labyrinthWalls) {
                const nearestX = Math.max(wall.x, Math.min(x, wall.x + wall.width));
                const nearestY = Math.max(wall.y, Math.min(y, wall.y + wall.height));
                
                const dx = x - nearestX;
                const dy = y - nearestY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < radius) return true;
            }
            return false;
        }

        function endLabyrinthAttack(success) {
            labyrinthAttack.active = false;
            labyrinthAttack.timerVisible = false;
            labyrinthWalls = [];
            labyrinthBonuses = [];
            
            finalBoss.currentAttack = null;
            finalBoss.hasHammer = false;
            player.canMove = true;
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            const timerEl = document.getElementById('labyrinthTimer');
            timerEl.classList.remove('visible');
            timerEl.classList.remove('critical');
            
            camera.targetZoom = 1;
            camera.targetX = 0;
            camera.targetY = 0;
            
            if (success) {
                // –ò–≥—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –≤—ã–±—Ä–∞–ª—Å—è!
                devLog('–ò–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª—Å—è –∏–∑ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞!');
                finalBoss.attackTimer = 2;
                spawnPoops(1); // –ù–∞–≥—Ä–∞–¥–∞: –∫–∞–∫–∞—à–∫–∞ –¥–ª—è –±—Ä–æ—Å–∫–∞
                playMusic('stage2Music', 0.5);
            } else {
                // –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ - –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–Ω
                devLog('–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ - –∏—Å–ø–µ–ø–µ–ª–µ–Ω!');
                if (player.shield > 0) {
                    player.shield--;
                    playSound('hit', 0.6);
                } else if (!godMode) {
                    gameOver();
                    return;
                }
                finalBoss.attackTimer = 2;
                playMusic('stage2Music', 0.5);
            }
        }

        function renderLabyrinth() {
            // –†–µ–Ω–¥–µ—Ä —Å—Ç–µ–Ω –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
            labyrinthWalls.forEach(wall => {
                if (wall.alpha <= 0) return;
                
                ctx.save();
                ctx.globalAlpha = wall.alpha;
                
                // –ú–∞–≥–∏—á–µ—Å–∫–∏–π —Ü–≤–µ—Ç —Å—Ç–µ–Ω
                const grad = ctx.createLinearGradient(wall.x, wall.y, wall.x + wall.width, wall.y + wall.height);
                grad.addColorStop(0, '#8b00ff');
                grad.addColorStop(0.5, '#ff00ff');
                grad.addColorStop(1, '#8b00ff');
                
                ctx.fillStyle = grad;
                ctx.fillRect(wall.x, wall.y, wall.width, wall.height);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                if (!lowGraphics) {
                    ctx.shadowColor = '#ff00ff';
                    ctx.shadowBlur = 10;
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(wall.x, wall.y, wall.width, wall.height);
                }
                
                ctx.restore();
            });
            
            // –†–µ–Ω–¥–µ—Ä –≤—ã—Ö–æ–¥–∞ (—è—Ä–∫–∞—è –∑–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞)
            if (labyrinthAttack.phase === 3) {
                ctx.save();
                const pulse = Math.sin(Date.now() * 0.005) * 0.3 + 0.7;
                ctx.globalAlpha = pulse;
                
                const exitGrad = ctx.createRadialGradient(
                    labyrinthAttack.exitX, labyrinthAttack.exitY, 0,
                    labyrinthAttack.exitX, labyrinthAttack.exitY, 50
                );
                exitGrad.addColorStop(0, 'rgba(0, 255, 0, 1)');
                exitGrad.addColorStop(0.7, 'rgba(0, 255, 0, 0.5)');
                exitGrad.addColorStop(1, 'rgba(0, 255, 0, 0)');
                
                ctx.beginPath();
                ctx.arc(labyrinthAttack.exitX, labyrinthAttack.exitY, 50, 0, Math.PI * 2);
                ctx.fillStyle = exitGrad;
                ctx.fill();
                
                // –¢–µ–∫—Å—Ç "–í–´–•–û–î"
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#ffffff';
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 20;
                ctx.fillText('–í–´–•–û–î', labyrinthAttack.exitX, labyrinthAttack.exitY);
                
                ctx.restore();
            }
            
            // –†–µ–Ω–¥–µ—Ä –±–æ–Ω—É—Å–æ–≤
            labyrinthBonuses.forEach(bonus => {
                const scale = 1 + Math.sin(bonus.pulse) * 0.2;
                
                ctx.save();
                ctx.translate(bonus.x, bonus.y);
                ctx.scale(scale, scale);
                
                if (!lowGraphics) {
                    ctx.shadowColor = '#ffd700';
                    ctx.shadowBlur = 20;
                }
                
                renderIcon(ctx, '‚è∞', 0, 0, 32);
                
                ctx.shadowBlur = 0;
                ctx.restore();
            });
            
            // –†–µ–Ω–¥–µ—Ä –º–æ–ª–æ—Ç–∫–∞ —É –ò–≤–∞–Ω–∞
            if (finalBoss.hasHammer && labyrinthAttack.phase === 1) {
                ctx.save();
                ctx.translate(finalBoss.x + 60, finalBoss.y);
                ctx.rotate(labyrinthAttack.hammerRotation);
                renderIcon(ctx, 'üî®', 0, 0, 40);
                ctx.restore();
            }
        }

        // ==================== –ê–¢–ê–ö–ê –û–ì–ù–ï–ù–ù–´–• –ö–†–£–ì–û–í (–°–¢–ê–î–ò–Ø 2) ====================

        // ========== –ê–¢–ê–ö–ê: –û–ì–ù–ï–ù–ù–ê–Ø –ü–õ–ê–¢–§–û–†–ú–ê –ò –ó–ú–ï–ò ==========
        
        function startFirePlatformAttack() {
            finalBoss.currentAttack = 'firePlatform';
            finalBoss.firePlatformAttackUsed = true;
            firePlatformAttack.active = true;
            firePlatformAttack.phase = 0; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            firePlatformAttack.timer = 0;
            firePlatformAttack.timeLeft = firePlatformAttack.duration;
            firePlatformAttack.instructionsShown = false;
            fireSnakes = [];
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            originalGravityEnabled = false; // –í –∏–≥—Ä–µ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏ –Ω–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            originalPlayerControl = controlType;
            
            // –ó–æ–Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–≥–¥–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞)
            firePlatformAttack.warningZone = {
                x: player.x,
                y: player.y + 100,
                width: 600,
                height: 100,
                alpha: 0
            };
            
            devLog('–ê—Ç–∞–∫–∞: –û–ì–ù–ï–ù–ù–ê–Ø –ü–õ–ê–¢–§–û–†–ú–ê –ò –ó–ú–ï–ò!');
        }
        
        function updateFirePlatformAttack(dt) {
            firePlatformAttack.timer += dt;
            const t = firePlatformAttack.timer;
            
            // –≠–¢–ê–ü 0: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (1 —Å–µ–∫)
            if (firePlatformAttack.phase === 0) {
                if (t < 0.1) {
                    playSound('platformAlert', 0.7);
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –∑–æ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                firePlatformAttack.warningZone.alpha = Math.sin(t * 10) * 0.5 + 0.5;
                
                if (t >= 1) {
                    firePlatformAttack.phase = 1;
                    firePlatformAttack.timer = 0;
                    playSound('firePlatformRise', 0.6);
                }
            }
            // –≠–¢–ê–ü 1: –ü–æ—è–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ –ø–æ–¥—ä—ë–º (2 —Å–µ–∫)
            else if (firePlatformAttack.phase === 1) {
                const progress = Math.min(1, t / 2);
                firePlatformAttack.platformY = player.y + 100 + progress * 200;
                
                // –ò–≥—Ä–æ–∫ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
                player.y = firePlatformAttack.platformY - 50;
                player.targetY = player.y;
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±—ã—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                player.canMove = false;
                
                if (t >= 2) {
                    firePlatformAttack.phase = 2;
                    firePlatformAttack.timer = 0;
                }
            }
            // –≠–¢–ê–ü 2: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (5 —Å–µ–∫)
            else if (firePlatformAttack.phase === 2) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                if (!firePlatformAttack.instructionsShown) {
                    firePlatformAttack.instructionsShown = true;
                    showFirePlatformInstructions();
                }
                
                // –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –∏ –ø—Ä—ã–≥–∞—Ç—å
                enablePlatformControls();
                
                if (t >= 5) {
                    firePlatformAttack.phase = 3;
                    firePlatformAttack.timer = 0;
                    hideFirePlatformInstructions();
                    // –°–ø–∞–≤–Ω–∏–º –∑–º–µ–π
                    spawnFireSnakes();
                    playSound('snakeHiss', 0.5);
                }
            }
            // –≠–¢–ê–ü 3: –ò–≥—Ä–∞ —Å–æ –∑–º–µ—è–º–∏
            else if (firePlatformAttack.phase === 3) {
                firePlatformAttack.timeLeft -= dt;
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
                enablePlatformControls();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–º–µ–π
                updateFireSnakes(dt);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
                if (firePlatformAttack.timeLeft <= 0) {
                    endFirePlatformAttack(true);
                }
            }
        }
        
        function enablePlatformControls() {
            // –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ ‚Üê ‚Üí –∏ SPACE (–ø—Ä—ã–∂–æ–∫)
            player.canMove = true;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ—Å—Ç—É—é "–≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é" - –∏–≥—Ä–æ–∫ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
            const platformSurface = firePlatformAttack.platformY - 50;
            if (player.y < platformSurface - 120) {
                // –ò–≥—Ä–æ–∫ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ - –ø–∞–¥–∞–µ—Ç –≤–Ω–∏–∑
                player.y += 3;
            } else if (player.y > platformSurface) {
                // –ò–≥—Ä–æ–∫ –Ω–∏–∂–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è
                player.y = platformSurface;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ Y (–∏–≥—Ä–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –ª–µ—Ç–µ—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –≤–≤–µ—Ä—Ö)
            if (player.targetY < platformSurface - 120) {
                player.targetY = platformSurface - 120;
            }
        }
        
        function spawnFireSnakes() {
            // –°–æ–∑–¥–∞—ë–º 3-5 –æ–≥–Ω–µ–Ω–Ω—ã—Ö –∑–º–µ–π —Å–Ω–∏–∑—É
            const count = 3 + Math.floor(Math.random() * 3);
            const platformCenterX = player.x;
            const platformY = firePlatformAttack.platformY;
            
            for (let i = 0; i < count; i++) {
                const offsetX = (i - count/2) * 200 + (Math.random() - 0.5) * 100;
                fireSnakes.push({
                    x: platformCenterX + offsetX,
                    y: platformY + 200 + Math.random() * 100,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    length: 60 + Math.random() * 40,
                    jumpTimer: Math.random() * 3, // –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä—ã–∂–∫–æ–º
                    jumping: false,
                    jumpY: 0,
                    phase: Math.random() * Math.PI * 2 // –§–∞–∑–∞ –≤–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
                });
            }
        }
        
        function updateFireSnakes(dt) {
            fireSnakes.forEach(snake => {
                if (!snake.jumping) {
                    // –•–∞–æ—Ç–∏—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                    snake.x += snake.vx;
                    snake.y += snake.vy;
                    snake.phase += dt * 2;
                    
                    // –í–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                    snake.x += Math.cos(snake.phase) * 1.5;
                    snake.y += Math.sin(snake.phase * 0.8) * 1;
                    
                    // –î–µ—Ä–∂–∏–º –∑–º–µ–π –≤ –∑–æ–Ω–µ –ø–æ–¥ –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
                    const platformCenterX = player.x;
                    const platformY = firePlatformAttack.platformY;
                    
                    if (snake.x < platformCenterX - 400) snake.vx = Math.abs(snake.vx);
                    if (snake.x > platformCenterX + 400) snake.vx = -Math.abs(snake.vx);
                    if (snake.y < platformY + 150) snake.vy = Math.abs(snake.vy);
                    if (snake.y > platformY + 350) snake.vy = -Math.abs(snake.vy);
                    
                    // –¢–∞–π–º–µ—Ä –¥–ª—è –≤—ã–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è
                    snake.jumpTimer -= dt;
                    if (snake.jumpTimer <= 0) {
                        // –ó–º–µ—è –≤—ã–ø—Ä—ã–≥–∏–≤–∞–µ—Ç!
                        snake.jumping = true;
                        snake.jumpY = snake.y;
                        snake.jumpTargetY = platformY - 70; // –ü—Ä—ã–≥–∞–µ—Ç –¥–æ —É—Ä–æ–≤–Ω—è –∏–≥—Ä–æ–∫–∞
                        snake.jumpSpeed = 12;
                        playSound('snakeJump', 0.4);
                        snake.jumpTimer = 2 + Math.random() * 3; // –°–ª–µ–¥—É—é—â–∏–π –ø—Ä—ã–∂–æ–∫ —á–µ—Ä–µ–∑ 2-5 —Å–µ–∫
                    }
                } else {
                    // –ó–º–µ—è –ø—Ä—ã–≥–∞–µ—Ç –≤–≤–µ—Ä—Ö
                    snake.y -= snake.jumpSpeed;
                    snake.jumpSpeed -= 0.6; // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å –∏–≥—Ä–æ–∫–æ–º
                    const dx = snake.x - player.x;
                    const dy = snake.y - player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < player.radius + 20) {
                        // –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
                        if (player.shield > 0) {
                            player.shield--;
                            playSound('hit', 0.6);
                        } else if (!godMode) {
                            gameOver();
                        }
                        // –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–º–µ—é –Ω–∞–∑–∞–¥ –≤–Ω–∏–∑
                        snake.jumping = false;
                        snake.y = firePlatformAttack.platformY + 200;
                        snake.jumpSpeed = 0;
                    }
                    
                    // –ó–º–µ—è –ø–∞–¥–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤–Ω–∏–∑
                    if (snake.y > snake.jumpY) {
                        snake.jumping = false;
                        snake.y = snake.jumpY;
                        snake.jumpSpeed = 0;
                    }
                }
            });
        }
        
        function endFirePlatformAttack(success) {
            firePlatformAttack.active = false;
            fireSnakes = [];
            
            finalBoss.currentAttack = null;
            player.canMove = true;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–≥—Ä–æ–∫–∞ –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É
            player.y = canvas.height / 2;
            player.targetY = player.y;
            
            if (success) {
                devLog('–ò–≥—Ä–æ–∫ –ø–µ—Ä–µ–∂–∏–ª –æ–≥–Ω–µ–Ω–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É!');
                finalBoss.attackTimer = 2;
                spawnPoops(1); // –ù–∞–≥—Ä–∞–¥–∞: –∫–∞–∫–∞—à–∫–∞ –¥–ª—è –±—Ä–æ—Å–∫–∞
                playMusic('stage2Music', 0.5);
            }
        }
        
        function showFirePlatformInstructions() {
            // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            let instructionEl = document.getElementById('platformInstructions');
            if (!instructionEl) {
                instructionEl = document.createElement('div');
                instructionEl.id = 'platformInstructions';
                instructionEl.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(50,0,0,0.95));
                    padding: 30px 50px;
                    border-radius: 20px;
                    color: white;
                    font-size: 18px;
                    z-index: 400;
                    text-align: center;
                    border: 3px solid #ff6600;
                    box-shadow: 0 0 50px rgba(255, 100, 0, 0.5);
                `;
                document.body.appendChild(instructionEl);
            }
            
            instructionEl.innerHTML = `
                <h2 style="font-size: 32px; margin-bottom: 20px; color: #ff6600;">üî• –û–ì–ù–ï–ù–ù–ê–Ø –ü–õ–ê–¢–§–û–†–ú–ê üî•</h2>
                <p style="margin: 10px 0;"><strong>‚Üê ‚Üí</strong> –î–≤–∏–∂–µ–Ω–∏–µ</p>
                <p style="margin: 10px 0;"><strong>SPACE</strong> –ü—Ä—ã–∂–æ–∫</p>
                <p style="margin: 10px 0; color: #ff6666;"><strong>–ò–∑–±–µ–≥–∞–π –æ–≥–Ω–µ–Ω–Ω—ã—Ö –∑–º–µ–π!</strong></p>
            `;
            instructionEl.style.display = 'block';
        }
        
        function hideFirePlatformInstructions() {
            const instructionEl = document.getElementById('platformInstructions');
            if (instructionEl) {
                instructionEl.style.display = 'none';
            }
        }
        
        function renderFirePlatform() {
            // –†–µ–Ω–¥–µ—Ä –∑–æ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            if (firePlatformAttack.phase === 0 && firePlatformAttack.warningZone) {
                const zone = firePlatformAttack.warningZone;
                ctx.save();
                ctx.globalAlpha = zone.alpha;
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(zone.x - zone.width/2, zone.y - zone.height/2, zone.width, zone.height);
                ctx.strokeStyle = '#ff6600';
                ctx.lineWidth = 4;
                ctx.strokeRect(zone.x - zone.width/2, zone.y - zone.height/2, zone.width, zone.height);
                ctx.restore();
                
                // –¢–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                ctx.save();
                ctx.globalAlpha = zone.alpha;
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#ffffff';
                ctx.fillText('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! ‚ö†Ô∏è', zone.x, zone.y);
                ctx.restore();
            }
            
            // –†–µ–Ω–¥–µ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            if (firePlatformAttack.phase >= 1) {
                const platformX = player.x;
                const platformY = firePlatformAttack.platformY;
                const platformWidth = 600;
                const platformHeight = 30;
                
                ctx.save();
                
                // –û–≥–Ω–µ–Ω–Ω–∞—è —Ç–µ–∫—Å—Ç—É—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                const grad = ctx.createLinearGradient(platformX - platformWidth/2, platformY, platformX + platformWidth/2, platformY);
                grad.addColorStop(0, '#ff4400');
                grad.addColorStop(0.3, '#ff6600');
                grad.addColorStop(0.5, '#ff8800');
                grad.addColorStop(0.7, '#ff6600');
                grad.addColorStop(1, '#ff4400');
                ctx.fillStyle = grad;
                
                // –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
                ctx.fillRect(platformX - platformWidth/2, platformY - platformHeight/2, platformWidth, platformHeight);
                
                // –Ø–∑—ã–∫–∏ –ø–ª–∞–º–µ–Ω–∏ –ø–æ –∫—Ä–∞—è–º
                if (!lowGraphics) {
                    for (let i = 0; i < 20; i++) {
                        const flameX = platformX - platformWidth/2 + i * (platformWidth/19);
                        const flameHeight = 15 + Math.sin(Date.now() * 0.01 + i) * 8;
                        ctx.fillStyle = `rgba(255, ${100 + Math.random() * 100}, 0, 0.7)`;
                        ctx.beginPath();
                        ctx.moveTo(flameX, platformY - platformHeight/2);
                        ctx.lineTo(flameX - 5, platformY - platformHeight/2 - flameHeight);
                        ctx.lineTo(flameX + 5, platformY - platformHeight/2 - flameHeight);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = '#ff6600';
                ctx.shadowBlur = 30;
                ctx.strokeStyle = '#ff8800';
                ctx.lineWidth = 3;
                ctx.strokeRect(platformX - platformWidth/2, platformY - platformHeight/2, platformWidth, platformHeight);
                
                ctx.restore();
            }
        }
        
        function renderFireSnakes() {
            fireSnakes.forEach(snake => {
                ctx.save();
                
                // –¢–µ–ª–æ –∑–º–µ–∏ (–≤–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ)
                const segments = 8;
                ctx.beginPath();
                for (let i = 0; i < segments; i++) {
                    const segX = snake.x + Math.cos(snake.phase + i * 0.5) * 10;
                    const segY = snake.y + i * (snake.length / segments);
                    if (i === 0) {
                        ctx.moveTo(segX, segY);
                    } else {
                        ctx.lineTo(segX, segY);
                    }
                }
                
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç –∑–º–µ–∏
                const snakeGrad = ctx.createLinearGradient(snake.x, snake.y, snake.x, snake.y + snake.length);
                snakeGrad.addColorStop(0, '#ff0000');
                snakeGrad.addColorStop(0.5, '#ff6600');
                snakeGrad.addColorStop(1, '#ff8800');
                
                ctx.strokeStyle = snakeGrad;
                ctx.lineWidth = 12;
                ctx.lineCap = 'round';
                ctx.shadowColor = '#ff6600';
                ctx.shadowBlur = 20;
                ctx.stroke();
                
                // –ì–æ–ª–æ–≤–∞ –∑–º–µ–∏ (–±–æ–ª–µ–µ —è—Ä–∫–∞—è)
                ctx.beginPath();
                ctx.arc(snake.x, snake.y, 10, 0, Math.PI * 2);
                ctx.fillStyle = '#ffff00';
                ctx.shadowColor = '#ffff00';
                ctx.shadowBlur = 25;
                ctx.fill();
                
                // –ì–ª–∞–∑–∞ –∑–º–µ–∏
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(snake.x - 4, snake.y - 2, 2, 0, Math.PI * 2);
                ctx.arc(snake.x + 4, snake.y - 2, 2, 0, Math.PI * 2);
                ctx.fill();
                
                // –ß–∞—Å—Ç–∏—Ü—ã –æ–≥–Ω—è
                if (!lowGraphics && Math.random() < 0.3) {
                    particles.push({
                        x: snake.x + (Math.random() - 0.5) * 20,
                        y: snake.y + Math.random() * snake.length,
                        vx: (Math.random() - 0.5) * 2,
                        vy: -Math.random() * 2,
                        radius: 2 + Math.random() * 3,
                        color: Math.random() > 0.5 ? '#ff6600' : '#ff8800',
                        alpha: 1,
                        life: 0.5
                    });
                }
                
                ctx.restore();
            });
        }

        function startFireCircleAttack() {
            finalBoss.currentAttack = 'fireCircles';
            fireCircleAttack.active = true;
            fireCircleAttack.phase = 0;
            fireCircleAttack.timer = 0;
            fireCircleAttack.wavesTotal = 5 + Math.floor(Math.random() * 6); // 5-10 –≤–æ–ª–Ω
            fireCircleAttack.wavesDone = 0;
            fireCircleAttack.circlesSpawned = 0;
            fireCircles = [];
            finalBoss.hasFireball = true; // –§–∞–µ—Ä–±–æ–ª –≤ —Ä—É–∫–µ –ø—Ä–∏ –∞—Ç–∞–∫–µ —Å—Ñ–µ—Ä–∞–º–∏
            devLog(`–ê—Ç–∞–∫–∞: –û–ì–ù–ï–ù–ù–´–ï –ö–†–£–ì–ò! (${fireCircleAttack.wavesTotal} –≤–æ–ª–Ω)`);
        }
        
        function updateFireCircleAttack(dt) {
            fireCircleAttack.timer += dt;
            
            // –°–ø–∞–≤–Ω–∏–º –∫—Ä—É–≥–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –≤ 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –≤–æ–ª–Ω–∞–º–∏
            if (fireCircleAttack.wavesDone < fireCircleAttack.wavesTotal) {
                if (fireCircleAttack.timer >= 5.0) {
                    fireCircleAttack.timer = 0;
                    
                    // –°–ø–∞–≤–Ω–∏–º 5-10 –∫—Ä—É–≥–æ–≤ –∑–∞ –≤–æ–ª–Ω—É
                    const circlesCount = 5 + Math.floor(Math.random() * 6);
                    
                    for (let i = 0; i < circlesCount; i++) {
                        // –ü–æ–∑–∏—Ü–∏—è –∫—Ä—É–≥–∞ - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª—É—á–∞–π–Ω–∞—è!
                        const x = MAP_BOUNDS.minX + 100 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 200);
                        const y = MAP_BOUNDS.minY + 100 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 200);
                        
                        fireCircles.push({
                            x: x,
                            y: y,
                            radius: 80 + Math.random() * 40,
                            maxRadius: 80 + Math.random() * 40,
                            shrinkTimer: 0,
                            shrinkDuration: 2 + Math.random() * 1, // 2-3 —Å–µ–∫—É–Ω–¥—ã –¥–æ –≤–∑—Ä—ã–≤–∞
                            exploded: false,
                            alpha: 0.8
                        });
                    }
                    
                    // –ó–≤—É–∫ –ù–ï –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ - –æ–Ω –±—É–¥–µ—Ç –∏–≥—Ä–∞—Ç—å –∑–∞ 0.6 —Å–µ–∫—É–Ω–¥—ã –¥–æ –≤–∑—Ä—ã–≤–∞ –∫–∞–∂–¥–æ–π —Å—Ñ–µ—Ä—ã
                    fireCircleAttack.wavesDone++;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥–∏
            fireCircles = fireCircles.filter(circle => {
                if (circle.exploded) {
                    circle.alpha -= dt * 2;
                    return circle.alpha > 0;
                }
                
                circle.shrinkTimer += dt;
                const progress = circle.shrinkTimer / circle.shrinkDuration;
                
                // –ö—Ä—É–≥ —Å–∂–∏–º–∞–µ—Ç—Å—è
                circle.radius = circle.maxRadius * (1 - progress);
                
                // –ó–≤—É–∫ –≥–∞—Å—Ç–µ—Ä–∞ –∑–∞ 0.6 —Å–µ–∫—É–Ω–¥—ã –¥–æ –≤–∑—Ä—ã–≤–∞
                const timeToExplode = circle.shrinkDuration - circle.shrinkTimer;
                if (timeToExplode <= 0.6 && !circle.soundPlayed) {
                    circle.soundPlayed = true;
                    playSound('gasterBlaster', 0.6);
                }
                
                // –°—Ñ–µ—Ä–∞ –ù–ï –Ω–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω –ø–æ–∫–∞ –Ω–µ –≤–∑–æ—Ä–≤–∞–ª–∞—Å—å - –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –≤—ã–π—Ç–∏ –∏–∑ –Ω–µ—ë!
                // –í—ã—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ —É–±—Ä–∞–Ω–æ - –∏–≥—Ä–æ–∫ —Å–∞–º –¥–æ–ª–∂–µ–Ω –≤—ã–±–µ–∂–∞—Ç—å
                
                // –í–∑—Ä—ã–≤ –∫–æ–≥–¥–∞ –∫—Ä—É–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∂–∞–ª—Å—è
                if (circle.shrinkTimer >= circle.shrinkDuration && !circle.exploded) {
                    circle.exploded = true;
                    // –ë–µ–∑ –∑–≤—É–∫–∞ metal pipe –ø—Ä–∏ –≤–∑—Ä—ã–≤–µ —Å—Ñ–µ—Ä—ã
                    shakeScreen();
                    
                    // –û—Å–∫–æ–ª–∫–∏ –ª–µ—Ç—è—Ç –≤–æ –≤—Å–µ —Å—Ç–æ—Ä–æ–Ω—ã
                    const fragmentCount = lowGraphics ? 8 : 12;
                    for (let i = 0; i < fragmentCount; i++) {
                        const angle = (i / fragmentCount) * Math.PI * 2;
                        const speed = 10 + Math.random() * 8;
                        
                        fireShards.push({
                            x: circle.x,
                            y: circle.y,
                            vx: Math.cos(angle) * speed,
                            vy: Math.sin(angle) * speed,
                            radius: 8 + Math.random() * 8,
                            color: Math.random() > 0.5 ? '#ff6600' : '#ff0000',
                            alpha: 1,
                            life: 2.5,
                            glow: !lowGraphics
                        });
                    }
                }
                
                return true;
            });
            
            updateFireShards(dt);
            
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ç–∞–∫–∏
            if (fireCircleAttack.wavesDone >= fireCircleAttack.wavesTotal && fireCircles.length === 0 && fireShards.length === 0) {
                finalBoss.currentAttack = null;
                fireCircleAttack.active = false;
                finalBoss.hasFireball = false; // –£–±–∏—Ä–∞–µ–º —Ñ–∞–µ—Ä–±–æ–ª
                // –ë–∞—Ç—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç 1 –∫–∞–∫–∞—à–∫—É!
                spawnPoops(1);
                finalBoss.attackTimer = 2;
                devLog('–ê—Ç–∞–∫–∞ –û–≥–Ω–µ–Ω–Ω—ã–µ –ö—Ä—É–≥–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –ø–æ—è–≤–∏–ª–∞—Å—å –∫–∞–∫–∞—à–∫–∞!');
            }
        }

        function updateFireShards(dt) {
            fireShards = fireShards.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.98;
                p.vy *= 0.98;
                p.life -= dt;
                p.alpha = Math.min(1, p.life);

                // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
                if (p.life > 0.5) {
                    const dx = p.x - player.x;
                    const dy = p.y - player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < p.radius + player.radius) {
                        if (player.shield > 0) {
                            player.shield--;
                            playSound('hit', 0.4);
                            return false; // –£–¥–∞–ª—è–µ–º –æ—Å–∫–æ–ª–æ–∫
                        } else if (!godMode) {
                            gameOver();
                        }
                    }
                }
                return p.life > 0;
            });
        }

        function renderFireShards() {
            fireShards.forEach(p => {
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(Date.now() * 0.008);
                
                if (p.glow && !lowGraphics) {
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 20;
                }
                
                if (lowGraphics) {
                    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø—Ä–æ—Å—Ç–æ–π –∫–≤–∞–¥—Ä–∞—Ç
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.radius, -p.radius, p.radius*2, p.radius*2);
                } else {
                    // –ù–µ—Ä–æ–≤–Ω—ã–π –æ—Å–∫–æ–ª–æ–∫
                    ctx.beginPath();
                    ctx.moveTo(-p.radius, -p.radius * 0.5);
                    ctx.lineTo(p.radius * 0.5, -p.radius);
                    ctx.lineTo(p.radius, p.radius * 0.5);
                    ctx.lineTo(-p.radius * 0.3, p.radius * 0.8);
                    ctx.closePath();
                    
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                    
                    ctx.strokeStyle = `rgba(255, 255, 255, ${p.alpha * 0.8})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                ctx.restore();
            });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–≥–Ω–µ–Ω–Ω—ã—Ö –∫—Ä—É–≥–æ–≤
        function renderFireCircles() {
            fireCircles.forEach(circle => {
                ctx.save();
                ctx.translate(circle.x, circle.y);
                
                // –û–≥–Ω–µ–Ω–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ (–æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ low mode)
                if (!lowGraphics) {
                    ctx.shadowColor = circle.exploded ? '#ff0000' : '#ff6600';
                    ctx.shadowBlur = 30;
                }
                
                // –í–Ω–µ—à–Ω–∏–π –∫—Ä—É–≥ (–∑–æ–Ω–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
                ctx.beginPath();
                ctx.arc(0, 0, circle.maxRadius, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 100, 0, ${circle.alpha * 0.3})`;
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // –°–∂–∏–º–∞—é—â–∏–π—Å—è –∫—Ä—É–≥
                if (!circle.exploded) {
                    if (lowGraphics) {
                        // LOW MODE: –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π –∫—Ä—É–≥ (—Ç–æ–ª—å–∫–æ –æ–±–≤–æ–¥–∫–∞)
                        ctx.beginPath();
                        ctx.arc(0, 0, circle.radius, 0, Math.PI * 2);
                        ctx.strokeStyle = '#ff6600';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    } else {
                    const grad = ctx.createRadialGradient(0, 0, 0, 0, 0, circle.radius);
                    grad.addColorStop(0, `rgba(255, 200, 0, ${circle.alpha * 0.8})`);
                    grad.addColorStop(0.5, `rgba(255, 100, 0, ${circle.alpha * 0.5})`);
                    grad.addColorStop(1, `rgba(255, 0, 0, ${circle.alpha * 0.3})`);
                    
                    ctx.beginPath();
                    ctx.arc(0, 0, circle.radius, 0, Math.PI * 2);
                    ctx.fillStyle = grad;
                    ctx.fill();
                    
                    // –û–±–≤–æ–¥–∫–∞ —Å–∂–∏–º–∞—é—â–µ–≥–æ—Å—è –∫—Ä—É–≥–∞
                    ctx.beginPath();
                    ctx.arc(0, 0, circle.radius, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(255, 255, 0, ${circle.alpha})`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // –ú–∏–≥–∞—é—â–∏–π —Ü–µ–Ω—Ç—Ä –∫–æ–≥–¥–∞ –ø–æ—á—Ç–∏ –≤–∑–æ—Ä–≤—ë—Ç—Å—è
                    if (circle.radius < 30) {
                        const flash = Math.sin(Date.now() * 0.03) * 0.5 + 0.5;
                        ctx.beginPath();
                        ctx.arc(0, 0, 15, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(255, 255, 255, ${flash})`;
                        ctx.fill();
                    }
                    } // –ó–∞–∫—Ä—ã–≤–∞–µ–º else –¥–ª—è lowGraphics
                }
                
                ctx.restore();
            });
        }
        
        // –ù–∞—á–∞–ª–æ –∞—Ç–∞–∫–∏ CENSORED —Ä–∞–∫–µ—Ç
        function startCensoredMissileAttack() {
            finalBoss.currentAttack = 'censored';
            finalBoss.handsVisible = true;
            finalBoss.handsTimer = 0;
            finalBoss.missileCount = 0;
            finalBoss.missilesLaunched = 0;
            devLog('–ê—Ç–∞–∫–∞: CENSORED —Ä–∞–∫–µ—Ç—ã!');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç–∞–∫–∏ CENSORED
        function updateCensoredAttack(dt) {
            finalBoss.handsTimer += dt;
            
            // –ü–æ—è–≤–ª–µ–Ω–∏–µ —Ä—É–∫ (0-1.5 —Å–µ–∫)
            if (finalBoss.handsTimer < 1.5) {
                // –†—É–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è
                finalBoss.handsScale = Math.min(1, finalBoss.handsTimer / 0.8);
            }
            // –ó–∞–ø—É—Å–∫ —Ä–∞–∫–µ—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏ (1.5-4.5 —Å–µ–∫)
            else if (finalBoss.handsTimer < 4.5 && finalBoss.missilesLaunched < 4) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–∫–µ—Ç—É –∫–∞–∂–¥—ã–µ 0.75 —Å–µ–∫—É–Ω–¥—ã
                const launchTime = 1.5 + finalBoss.missilesLaunched * 0.75;
                
                if (finalBoss.handsTimer >= launchTime && finalBoss.missilesLaunched < 4) {
                    // –ó–∞–ø—É—Å–∫ —Ä–∞–∫–µ—Ç—ã!
                    launchCensoredMissile();
                    finalBoss.missilesLaunched++;
                }
            }
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ç–∞–∫–∏
        else if (finalBoss.handsTimer > 5 && finalBoss.censoredMissiles.length === 0) {
                finalBoss.currentAttack = null;
                finalBoss.handsVisible = false;
                finalBoss.attackTimer = 2; // –°–ª–µ–¥—É—é—â–∞—è –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –æ–¥–Ω–æ–π CENSORED —Ä–∞–∫–µ—Ç—ã
        function launchCensoredMissile() {
            const angle = Math.atan2(player.y - finalBoss.y, player.x - finalBoss.x);
            
            // –°–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞—É–¥–∏–æ –æ–±—ä–µ–∫—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–∞–∫–µ—Ç—ã
            let missileSound = null;
            try {
                missileSound = new Audio(SOUNDS.missileLock);
                missileSound.volume = 0.4;
                missileSound.loop = true;
                missileSound.play().catch(() => {});
            } catch(e) {}
            
            finalBoss.censoredMissiles.push({
                x: finalBoss.x,
                y: finalBoss.y,
                vx: Math.cos(angle) * 5,
                vy: Math.sin(angle) * 5,
                targetX: player.x,
                targetY: player.y,
                width: 120,
                height: 40,
                rotation: angle,
                homingTimer: 7, // –°–∞–º–æ–Ω–∞–≤–æ–¥–∏—Ç—Å—è 7 —Å–µ–∫—É–Ω–¥
                trail: [],
                alive: true,
                sound: missileSound, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–≤—É–∫ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ —Ä–∞–∑—Ä—É—à–µ–Ω–∏–∏
                soundStopped: false // –§–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–≤—É–∫–∞
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–≤—É–∫–∞ —Ä–∞–∫–µ—Ç—ã
        function stopMissileSound(missile) {
            if (missile.sound && !missile.soundStopped) {
                try {
                    missile.sound.pause();
                    missile.sound.currentTime = 0;
                    missile.sound.src = ''; // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º
                    missile.soundStopped = true;
                } catch(e) {}
                missile.sound = null;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CENSORED —Ä–∞–∫–µ—Ç
        function updateCensoredMissiles(dt) {
            finalBoss.censoredMissiles = finalBoss.censoredMissiles.filter(missile => {
                if (!missile.alive) {
                    stopMissileSound(missile);
                    return false;
                }
                
                // –°–∞–º–æ–Ω–∞–≤–µ–¥–µ–Ω–∏–µ
                if (missile.homingTimer > 0) {
                    missile.homingTimer -= dt;
                    
                    // –¶–µ–ª–∏–º—Å—è –Ω–∞ –∏–≥—Ä–æ–∫–∞
                    const dx = player.x - missile.x;
                    const dy = player.y - missile.y;
                    const targetAngle = Math.atan2(dy, dx);
                    
                    // –ü–ª–∞–≤–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç
                    let angleDiff = targetAngle - missile.rotation;
                    while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                    while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                    missile.rotation += angleDiff * 0.05;
                    
                    // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏
                    const speed = 6 + (7 - missile.homingTimer) * 0.5;
                    missile.vx = Math.cos(missile.rotation) * speed;
                    missile.vy = Math.sin(missile.rotation) * speed;
                    
                    // –ó–≤—É–∫ –Ω–∞–≤–µ–¥–µ–Ω–∏—è —É–∂–µ –∏–≥—Ä–∞–µ—Ç—Å—è –≤ loop - –Ω–µ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
                } else {
                    // –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞–≤–µ–¥–µ–Ω–∏—è - –ª–µ—Ç–∏—Ç –ø—Ä—è–º–æ
                    const speed = 12;
                    missile.vx = Math.cos(missile.rotation) * speed;
                    missile.vy = Math.sin(missile.rotation) * speed;
                }
                
                missile.x += missile.vx;
                missile.y += missile.vy;
                
                // –°–ª–µ–¥ –∑–∞ —Ä–∞–∫–µ—Ç–æ–π
                missile.trail.push({ x: missile.x, y: missile.y, alpha: 1 });
                missile.trail = missile.trail.filter(t => {
                    t.alpha -= dt * 3;
                    return t.alpha > 0;
                });
                if (missile.trail.length > 20) missile.trail.shift();
                
                // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å–æ —Å—Ç–µ–Ω–æ–π
                if (missile.x < MAP_BOUNDS.minX || missile.x > MAP_BOUNDS.maxX() ||
                    missile.y < MAP_BOUNDS.minY || missile.y > MAP_BOUNDS.maxY()) {
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ —Ä–∞–∫–µ—Ç—ã!
                    stopMissileSound(missile);
                    
                    // –í–∑—Ä—ã–≤ –∏ –æ—Å–∫–æ–ª–∫–∏!
                    explodeCensoredMissile(missile);
                    return false;
                }
                
                // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–∫–æ–º
                const dx = missile.x - player.x;
                const dy = missile.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 40 + player.radius) {
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ —Ä–∞–∫–µ—Ç—ã!
                    stopMissileSound(missile);
                    
                    if (player.shield > 0) {
                        player.shield--;
                        playSound('hit', 0.5);
                        explodeCensoredMissile(missile);
                        return false;
                    } else if (!godMode) {
                        gameOver();
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        // –í–∑—Ä—ã–≤ CENSORED —Ä–∞–∫–µ—Ç—ã
        function explodeCensoredMissile(missile) {
            playSound('metalPipe', 0.6);
            shakeScreen();
            
            // –ë–û–õ–¨–®–ò–ï –Ø–†–ö–ò–ï –æ—Å–∫–æ–ª–∫–∏ - –û–ü–ê–°–ù–û–°–¢–¨! –õ–µ–≥–∫–æ —É–≤–∏–¥–µ—Ç—å
            for (let i = 0; i < 20; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 6 + Math.random() * 12;
                
                particles.push({
                    x: missile.x,
                    y: missile.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: 12 + Math.random() * 15, // –ö—Ä—É–ø–Ω–µ–µ!
                    color: Math.random() > 0.5 ? '#ff3333' : '#ff6600', // –ö—Ä–∞—Å–Ω—ã–µ/–æ—Ä–∞–Ω–∂–µ–≤—ã–µ - –∑–∞–º–µ—Ç–Ω—ã–µ!
                    alpha: 1,
                    life: 2.5, // –î–æ–ª—å—à–µ –∂–∏–≤—É—Ç
                    isFragment: true, // –û—Å–∫–æ–ª–æ–∫ –º–æ–∂–µ—Ç —Ä–∞–Ω–∏—Ç—å!
                    glow: true // –°–≤–µ—Ç—è—Ç—Å—è!
                });
            }
            
            // –ö—Ä–∞—Å–Ω—ã–µ –±—É–∫–≤—ã CENSORED —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è - –ö–†–£–ü–ù–ï–ï
            const letters = ['C', 'E', 'N', 'S', 'O', 'R', 'E', 'D'];
            letters.forEach((letter, i) => {
                const angle = (i / letters.length) * Math.PI * 2;
                const speed = 10 + Math.random() * 6;
                
                particles.push({
                    x: missile.x,
                    y: missile.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: 12, // –ö—Ä—É–ø–Ω–µ–µ!
                    color: '#ff0000',
                    alpha: 1,
                    life: 2.5, // –î–æ–ª—å—à–µ –∂–∏–≤—É—Ç
                    isLetter: true,
                    letter: letter,
                    glow: true
                });
            });
        }
        
        function shakeScreen() {
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 300);
        }
        
        // ==================== –ö–ê–¢–°–¶–ï–ù–ê –°–¢–ê–î–ò–ò 2 ====================
        let fireParticles = []; // –ß–∞—Å—Ç–∏—Ü—ã –æ–≥–Ω—è
        let stage2Wings = { left: 0, right: 0, angle: 0 }; // –ö—Ä—ã–ª—å—è
        
        function startStage2Cutscene() {
            finalBoss.stage2Cutscene = true;
            finalBoss.stage2Phase = 0;
            finalBoss.stage2Timer = 0;
            finalBoss.auraActive = true; // –°–∏–Ω—è—è –∞—É—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞
            fireParticles = [];
            stage2Wings = { left: 0, right: 0, angle: 0, flapAngle: 0 };
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –Ω–∞ –±–æ—Å—Å–µ
            camera.targetZoom = 2.0;
            camera.targetX = finalBoss.x - canvas.width/2;
            camera.targetY = finalBoss.y - canvas.height/2;
            
            devLog('–ö–∞—Ç—Å—Ü–µ–Ω–∞ —Å—Ç–∞–¥–∏–∏ 2 –Ω–∞—á–∞–ª–∞—Å—å');
        }
        
        function updateStage2Cutscene(dt) {
            finalBoss.stage2Timer += dt;
            const t = finalBoss.stage2Timer;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–º–µ—Ä—É
            camera.x += (camera.targetX - camera.x) * 0.05;
            camera.y += (camera.targetY - camera.y) * 0.05;
            camera.zoom += (camera.targetZoom - camera.zoom) * 0.05;
            
            // –§–∞–∑–∞ 0: –ö–∞–º–µ—Ä–∞ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è, –∞—É—Ä–∞ –≥–∞—Å–Ω–µ—Ç (0-2 —Å–µ–∫)
            if (finalBoss.stage2Phase === 0) {
                // –ì–∞—Å–Ω–µ—Ç —Å–∏–Ω—è—è –∞—É—Ä–∞
                finalBoss.auraActive = false;
                document.getElementById('blueAura').classList.remove('active');
                
                if (t > 2) {
                    finalBoss.stage2Phase = 1;
                    finalBoss.stage2Timer = 0;
                    // –ù–∞—á–∏–Ω–∞–µ–º –æ–≥–æ–Ω—å
                    playSound('fireFlame', 0.7);
                }
            }
            // –§–∞–∑–∞ 1: –ò–≤–∞–Ω –∑–∞–≥–æ—Ä–∞–µ—Ç—Å—è (0-3 —Å–µ–∫)
            else if (finalBoss.stage2Phase === 1) {
                finalBoss.onFire = true;
                
                // –°–æ–∑–¥–∞—ë–º —á–∞—Å—Ç–∏—Ü—ã –æ–≥–Ω—è
                for (let i = 0; i < (lowGraphics ? 2 : 8); i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * finalBoss.radius * 0.8;
                    fireParticles.push({
                        x: finalBoss.x + Math.cos(angle) * dist,
                        y: finalBoss.y + Math.sin(angle) * dist,
                        vx: (Math.random() - 0.5) * 3,
                        vy: -3 - Math.random() * 5, // –í–≤–µ—Ä—Ö
                        size: 10 + Math.random() * 20,
                        life: 0.5 + Math.random() * 0.5,
                        maxLife: 0.5 + Math.random() * 0.5,
                        color: Math.random() > 0.3 ? '#ff6600' : (Math.random() > 0.5 ? '#ff0000' : '#ffff00')
                    });
                }
                
                if (t > 3) {
                    finalBoss.stage2Phase = 2;
                    finalBoss.stage2Timer = 0;
                    // –ù–∞—á–∏–Ω–∞–µ–º –º—É–∑—ã–∫—É –∫—Ä—ã–ª—å–µ–≤ (19 —Å–µ–∫—É–Ω–¥)
                    playSound('doomWings', 0.8);
                }
            }
            // –§–∞–∑–∞ 2: –ö—Ä—ã–ª—å—è —Ä–∞—Å—Ç—É—Ç + –ò–≤–∞–Ω –∫—Ä–∏—á–∏—Ç (0-15 —Å–µ–∫)
            else if (finalBoss.stage2Phase === 2) {
                finalBoss.onFire = true;
                finalBoss.screaming = true;
                
                // –ß–∞—Å—Ç–∏—Ü—ã –æ–≥–Ω—è –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è
                for (let i = 0; i < (lowGraphics ? 1 : 5); i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * finalBoss.radius * 0.8;
                    fireParticles.push({
                        x: finalBoss.x + Math.cos(angle) * dist,
                        y: finalBoss.y + Math.sin(angle) * dist,
                        vx: (Math.random() - 0.5) * 3,
                        vy: -3 - Math.random() * 5,
                        size: 10 + Math.random() * 20,
                        life: 0.5 + Math.random() * 0.5,
                        maxLife: 0.5 + Math.random() * 0.5,
                        color: Math.random() > 0.3 ? '#ff6600' : (Math.random() > 0.5 ? '#ff0000' : '#ffff00')
                    });
                }
                
                // –ö—Ä—ã–ª—å—è –º–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞—Å—Ç—É—Ç
                const wingGrowth = Math.min(1, t / 12); // –ó–∞ 12 —Å–µ–∫—É–Ω–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã—Ä–∞—Å—Ç–∞—é—Ç
                stage2Wings.left = wingGrowth;
                stage2Wings.right = wingGrowth;
                
                // –ù–µ–±–æ–ª—å—à–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫—Ä—ã–ª—å–µ–≤ –ø—Ä–∏ —Ä–æ—Å—Ç–µ
                stage2Wings.angle = Math.sin(t * 2) * 0.1 * wingGrowth;
                
                // –¢–†–Ø–°–ö–ê –ö–ê–ú–ï–†–´ - –≤—Å—ë —Å–∏–ª—å–Ω–µ–µ –∏ —Å–∏–ª—å–Ω–µ–µ –¥–æ –≤—Å–ø—ã—à–∫–∏!
                const shakeIntensity = Math.min(1, t / 15) * 15; // –ù–∞—Ä–∞—Å—Ç–∞–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
                camera.x += (Math.random() - 0.5) * shakeIntensity;
                camera.y += (Math.random() - 0.5) * shakeIntensity;
                
                if (t > 15) {
                    finalBoss.stage2Phase = 3;
                    finalBoss.stage2Timer = 0;
                    // –í—Å–ø—ã—à–∫–∞ –∑–≤–µ–∑–¥—ã (–±–µ–∑ –∑–≤—É–∫–∞ metal pipe)
                    finalBoss.starFlash = true;
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–¥–ø–∏—Å—å –ó–û–õ–û –ø–µ—Ä–µ–¥ –æ—Ä–∞–Ω–∂–µ–≤–æ–π –≤—Å–ø—ã—à–∫–æ–π - –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –æ–≥–Ω—ë–º –≤ –∫–æ–Ω—Ü–µ
                    document.getElementById('finalBossLetters').classList.remove('show');
                    document.getElementById('finalBossLetters').style.opacity = '0';
                }
            }
            // –§–∞–∑–∞ 3: –ó–≤–µ–∑–¥–∞ + –æ—Ä–∞–Ω–∂–µ–≤–∞—è –≤—Å–ø—ã—à–∫–∞ (0-2 —Å–µ–∫)
            else if (finalBoss.stage2Phase === 3) {
                // –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤—Å–ø—ã—à–∫–∞ –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç
                finalBoss.orangeFlash = Math.min(1, t * 2);
                
                // –¢—Ä—è—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞
                if (t < 1) {
                    camera.x += (Math.random() - 0.5) * 10;
                    camera.y += (Math.random() - 0.5) * 10;
                }
                
                if (t > 2) {
                    finalBoss.stage2Phase = 4;
                    finalBoss.stage2Timer = 0;
                    // –ü–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    finalBoss.x = canvas.width / 2;
                    finalBoss.y = 120;
                    player.x = canvas.width / 2;
                    player.y = canvas.height - 120;
                    player.targetX = player.x;
                    player.targetY = player.y;
                    mouseX = player.x;
                    mouseY = player.y;
                    // –û–≥–æ–Ω—å –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è
                    finalBoss.onFire = false;
                    finalBoss.screaming = false;
                    fireParticles = [];
                }
            }
            // –§–∞–∑–∞ 4: –í—Å–ø—ã—à–∫–∞ —Å–ø–∞–¥–∞–µ—Ç, –ò–≤–∞–Ω —Å –∫—Ä—ã–ª—å—è–º–∏ –º–∞—à–µ—Ç –∏–º–∏ (0-3 —Å–µ–∫)
            else if (finalBoss.stage2Phase === 4) {
                // –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤—Å–ø—ã—à–∫–∞ —Å–ø–∞–¥–∞–µ—Ç
                finalBoss.orangeFlash = Math.max(0, 1 - t);
                
                // –ö–∞–º–µ—Ä–∞ –æ—Ç–¥–∞–ª—è–µ—Ç—Å—è
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                // –ö—Ä—ã–ª—å—è –º–∞—à—É—Ç
                stage2Wings.flapAngle = Math.sin(t * 4) * 0.4;
                
                if (t > 3) {
                    // –ö–∞—Ç—Å—Ü–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –Ω–∞—á–∏–Ω–∞–µ–º –±–æ–π —Å—Ç–∞–¥–∏–∏ 2!
                    finalBoss.stage2Cutscene = false;
                    finalBoss.stage = 2;
                    finalBoss.hasWings = true;
                    finalBoss.stageTransition = false; // –ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω
                    finalBoss.attackTimer = 2; // –ü–µ—Ä–≤–∞—è –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    player.canMove = true; // –ò–≥—Ä–æ–∫ —Å–Ω–æ–≤–∞ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è
                    
                    // –í–∫–ª—é—á–∞–µ–º DOOM –º—É–∑—ã–∫—É –¥–ª—è —Å—Ç–∞–¥–∏–∏ 2!
                    playMusic('stage2Music', 0.5);
                    
                    // –ù–∞–¥–ø–∏—Å—å –ó–û–õ–û –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ–≥–Ω—ë–º - —Å–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏!
                    document.getElementById('finalBossLetters').style.opacity = '1';
                    document.getElementById('finalBossLetters').classList.add('show');
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –±—É–∫–≤ —Å –æ–≥–Ω–µ–Ω–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º
                    const letters = document.querySelectorAll('.boss-letter');
                    letters.forEach((l, i) => {
                        // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º
                        l.style.opacity = '0';
                        l.style.transform = 'scale(0)';
                        
                        setTimeout(() => {
                            l.style.opacity = '1';
                            l.style.transform = 'scale(1)';
                            l.style.textShadow = '0 0 30px #ff6600, 0 0 60px #ff3300, 0 0 90px #ff0000';
                            playSound('undertaleHit', 0.5);
                            shakeScreen();
                        }, i * 200);
                    });
                    
                    devLog('–°–¢–ê–î–ò–Ø 2 - –ö–†–´–õ–¨–Ø –í–´–†–û–°–õ–ò! –ë–û–ô –ü–†–û–î–û–õ–ñ–ê–ï–¢–°–Ø!');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—ã –æ–≥–Ω—è
            fireParticles = fireParticles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy -= 0.1; // –ü–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –≤–≤–µ—Ä—Ö
                p.life -= dt;
                p.size *= 0.98;
                return p.life > 0 && p.size > 1;
            });
        }
        
        function renderStage2Effects() {
            // –û–≥–æ–Ω—å –≤–æ–∫—Ä—É–≥ –ò–≤–∞–Ω–∞
            if (finalBoss.onFire) {
                fireParticles.forEach(p => {
                    const alpha = p.life / p.maxLife;
                    ctx.save();
                    ctx.globalAlpha = alpha;
                    
                    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –æ–≥–Ω—è
                    const fireGrad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
                    if (p.color === '#ffff00') {
                        fireGrad.addColorStop(0, 'rgba(255, 255, 200, 1)');
                        fireGrad.addColorStop(0.3, 'rgba(255, 255, 0, 0.8)');
                        fireGrad.addColorStop(0.7, 'rgba(255, 150, 0, 0.5)');
                        fireGrad.addColorStop(1, 'rgba(255, 50, 0, 0)');
                    } else if (p.color === '#ff0000') {
                        fireGrad.addColorStop(0, 'rgba(255, 200, 100, 1)');
                        fireGrad.addColorStop(0.3, 'rgba(255, 100, 0, 0.8)');
                        fireGrad.addColorStop(0.7, 'rgba(255, 0, 0, 0.5)');
                        fireGrad.addColorStop(1, 'rgba(100, 0, 0, 0)');
                    } else {
                        fireGrad.addColorStop(0, 'rgba(255, 255, 150, 1)');
                        fireGrad.addColorStop(0.3, 'rgba(255, 200, 50, 0.8)');
                        fireGrad.addColorStop(0.7, 'rgba(255, 100, 0, 0.5)');
                        fireGrad.addColorStop(1, 'rgba(200, 50, 0, 0)');
                    }
                    
                    ctx.beginPath();
                    // –§–æ—Ä–º–∞ –ø–ª–∞–º–µ–Ω–∏ (–Ω–µ –∫—Ä—É–≥–ª–∞—è)
                    ctx.moveTo(p.x, p.y + p.size);
                    ctx.quadraticCurveTo(p.x - p.size * 0.7, p.y, p.x, p.y - p.size * 1.5);
                    ctx.quadraticCurveTo(p.x + p.size * 0.7, p.y, p.x, p.y + p.size);
                    ctx.fillStyle = fireGrad;
                    ctx.fill();
                    
                    ctx.restore();
                });
            }
            
            // –ö—Ä—ã–ª—å—è
            if ((stage2Wings.left > 0 || stage2Wings.right > 0) || finalBoss.hasWings) {
                const wingSize = finalBoss.hasWings ? 1 : Math.max(stage2Wings.left, stage2Wings.right);
                const flapAngle = stage2Wings.flapAngle || 0;
                const baseAngle = stage2Wings.angle || 0;
                
                ctx.save();
                ctx.translate(finalBoss.x, finalBoss.y);
                
                // –õ–µ–≤–æ–µ –∫—Ä—ã–ª–æ
                ctx.save();
                ctx.rotate(-0.3 + baseAngle - flapAngle);
                ctx.scale(wingSize, wingSize);
                renderWing(ctx, -1); // -1 = –ª–µ–≤–æ–µ
                ctx.restore();
                
                // –ü—Ä–∞–≤–æ–µ –∫—Ä—ã–ª–æ
                ctx.save();
                ctx.rotate(0.3 - baseAngle + flapAngle);
                ctx.scale(wingSize, wingSize);
                renderWing(ctx, 1); // 1 = –ø—Ä–∞–≤–æ–µ
                ctx.restore();
                
                ctx.restore();
            }
            
            // –ó–≤–µ–∑–¥–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
            if (finalBoss.starFlash && finalBoss.stage2Phase === 3) {
                const starAlpha = Math.sin(finalBoss.stage2Timer * 10) * 0.5 + 0.5;
                ctx.save();
                ctx.translate(finalBoss.x, finalBoss.y);
                
                // –ó–≤–µ–∑–¥–∞
                ctx.beginPath();
                for (let i = 0; i < 10; i++) {
                    const angle = (i / 10) * Math.PI * 2 - Math.PI / 2;
                    const radius = i % 2 === 0 ? 50 : 20;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fillStyle = `rgba(255, 255, 200, ${starAlpha})`;
                ctx.shadowColor = '#ffffff';
                ctx.shadowBlur = 50;
                ctx.fill();
                
                ctx.restore();
            }
            
            // –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤—Å–ø—ã—à–∫–∞
            if (finalBoss.orangeFlash > 0) {
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.fillStyle = `rgba(255, 150, 0, ${finalBoss.orangeFlash})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ê–î–°–ö–û–ì–û –∫—Ä—ã–ª–∞
        function renderWing(ctx, side) {
            // side: -1 = –ª–µ–≤–æ–µ, 1 = –ø—Ä–∞–≤–æ–µ
            const wingLength = 200;
            const wingWidth = 120;
            
            ctx.save();
            if (side === 1) ctx.scale(-1, 1); // –ó–µ—Ä–∫–∞–ª–∏–º –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ
            
            // –ê–¥—Å–∫–æ–µ –∫—Ä—ã–ª–æ - –∫–æ—Å—Ç—è–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –ø–µ—Ä–µ–ø–æ–Ω–∫–∞–º–∏
            
            // –û—Å–Ω–æ–≤–Ω–∞—è –ø–µ—Ä–µ–ø–æ–Ω–∫–∞ (—Ç—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è/–±–∞–≥—Ä–æ–≤–∞—è)
            ctx.beginPath();
            ctx.moveTo(-10, 0);
            
            // –ö–æ—Å—Ç—è–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã (5 –ø–∞–ª—å—Ü–µ–≤ –∫–∞–∫ —É –ª–µ—Ç—É—á–µ–π –º—ã—à–∏)
            const fingers = 5;
            for (let i = 0; i < fingers; i++) {
                const angle = -0.4 + (i / (fingers - 1)) * 0.8;
                const len = wingLength * (0.7 + Math.sin(i * 0.5) * 0.3);
                const tipX = -len * Math.cos(angle);
                const tipY = len * Math.sin(angle) * 0.6;
                ctx.lineTo(tipX, tipY);
                
                if (i < fingers - 1) {
                    // –í–ø–∞–¥–∏–Ω—ã –º–µ–∂–¥—É –ø–∞–ª—å—Ü–∞–º–∏
                    const nextAngle = -0.4 + ((i + 1) / (fingers - 1)) * 0.8;
                    const midLen = wingLength * 0.5;
                    const midX = -midLen * Math.cos((angle + nextAngle) / 2);
                    const midY = midLen * Math.sin((angle + nextAngle) / 2) * 0.6 + 20;
                    ctx.lineTo(midX, midY);
                }
            }
            ctx.lineTo(-10, 0);
            ctx.closePath();
            
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–ø–æ–Ω–∫–∏ - –∞–¥—Å–∫–∏–π –∫—Ä–∞—Å–Ω–æ-—á—ë—Ä–Ω—ã–π
            const wingGrad = ctx.createLinearGradient(-10, 0, -wingLength, 0);
            wingGrad.addColorStop(0, '#1a0000');
            wingGrad.addColorStop(0.3, '#4a0000');
            wingGrad.addColorStop(0.6, '#800000');
            wingGrad.addColorStop(1, '#330000');
            ctx.fillStyle = wingGrad;
            ctx.shadowColor = '#ff3300';
            ctx.shadowBlur = 30;
            ctx.fill();
            
            // –ö–æ—Å—Ç—è–Ω—ã–µ –ø–∞–ª—å—Ü—ã (–±–µ–ª—ã–µ/—Å–µ—Ä—ã–µ –∫–æ—Å—Ç–∏)
            ctx.shadowBlur = 0;
            for (let i = 0; i < fingers; i++) {
                const angle = -0.4 + (i / (fingers - 1)) * 0.8;
                const len = wingLength * (0.7 + Math.sin(i * 0.5) * 0.3);
                const tipX = -len * Math.cos(angle);
                const tipY = len * Math.sin(angle) * 0.6;
                
                ctx.beginPath();
                ctx.moveTo(-10, 0);
                ctx.lineTo(tipX, tipY);
                
                const boneGrad = ctx.createLinearGradient(-10, 0, tipX, tipY);
                boneGrad.addColorStop(0, '#888888');
                boneGrad.addColorStop(0.5, '#cccccc');
                boneGrad.addColorStop(1, '#666666');
                ctx.strokeStyle = boneGrad;
                ctx.lineWidth = 6 - i * 0.5;
                ctx.stroke();
                
                // –°—É—Å—Ç–∞–≤—ã
                const joints = 3;
                for (let j = 1; j < joints; j++) {
                    const jt = j / joints;
                    const jx = -10 + (tipX + 10) * jt;
                    const jy = tipY * jt;
                    ctx.beginPath();
                    ctx.arc(jx, jy, 4 - j, 0, Math.PI * 2);
                    ctx.fillStyle = '#aaaaaa';
                    ctx.fill();
                }
                
                // –ö–æ–≥–æ—Ç—å –Ω–∞ –∫–æ–Ω—á–∏–∫–µ
                ctx.beginPath();
                ctx.moveTo(tipX, tipY);
                ctx.lineTo(tipX - 15, tipY + 10);
                ctx.lineTo(tipX - 5, tipY);
                ctx.closePath();
                ctx.fillStyle = '#333333';
                ctx.fill();
            }
            
            // –í–µ–Ω—ã –Ω–∞ –ø–µ—Ä–µ–ø–æ–Ω–∫–µ
            ctx.strokeStyle = 'rgba(100, 0, 0, 0.6)';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                const startX = -20 - Math.random() * 50;
                const startY = (Math.random() - 0.5) * 40;
                ctx.moveTo(startX, startY);
                for (let j = 0; j < 4; j++) {
                    ctx.lineTo(
                        startX - 20 - j * 25 + (Math.random() - 0.5) * 20,
                        startY + (Math.random() - 0.5) * 50
                    );
                }
                ctx.stroke();
            }
            
            // –û–≥–Ω–µ–Ω–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–Ω—á–∏–∫–∞—Ö
            for (let i = 0; i < fingers; i++) {
                const angle = -0.4 + (i / (fingers - 1)) * 0.8;
                const len = wingLength * (0.7 + Math.sin(i * 0.5) * 0.3);
                const tipX = -len * Math.cos(angle);
                const tipY = len * Math.sin(angle) * 0.6;
                
                ctx.beginPath();
                ctx.arc(tipX - 10, tipY + 5, 8 + Math.sin(Date.now() * 0.01 + i) * 3, 0, Math.PI * 2);
                const fireGrad = ctx.createRadialGradient(tipX - 10, tipY + 5, 0, tipX - 10, tipY + 5, 12);
                fireGrad.addColorStop(0, 'rgba(255, 200, 50, 0.8)');
                fireGrad.addColorStop(0.5, 'rgba(255, 100, 0, 0.5)');
                fireGrad.addColorStop(1, 'rgba(255, 50, 0, 0)');
                ctx.fillStyle = fireGrad;
                ctx.fill();
            }
            
            ctx.restore();
        }
        
        // ==================== –ö–ê–ö–ê–®–ö–ò –î–õ–Ø –§–ò–ù–ê–õ–¨–ù–û–ì–û –ë–û–°–°–ê ====================
        let playerPoop = null; // –ö–∞–∫–∞—à–∫–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–µ—Å—ë—Ç –∏–≥—Ä–æ–∫
        
        // –°–ø–∞–≤–Ω –∫–∞–∫–∞—à–µ–∫
        function spawnPoops(count) {
            poops = [];
            for (let i = 0; i < count; i++) {
                poops.push({
                    x: MAP_BOUNDS.minX + 100 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 200),
                    y: MAP_BOUNDS.minY + 100 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 200),
                    rotation: 0,
                    pulse: Math.random() * Math.PI * 2
                });
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∫–∞—à–µ–∫ –Ω–∞ –∑–µ–º–ª–µ
        function updatePoops(dt) {
            poops = poops.filter(poop => {
                const dx = poop.x - player.x;
                const dy = poop.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < player.radius + 25 && !playerPoop) {
                    // –ü–æ–¥–±–∏—Ä–∞–µ–º –∫–∞–∫–∞—à–∫—É
                    playerPoop = { icon: 'üí©' };
                    playSound('powerup', 0.3);
                    devLog('–ü–æ–¥–æ–±—Ä–∞–ª –∫–∞–∫–∞—à–∫—É! –ö–∏–Ω—å –≤ –±–æ—Å—Å–∞!');
                    return false;
                }
                
                poop.pulse += dt * 3;
                poop.rotation += dt;
                return true;
            });
        }
        
        // –°–∏—Å—Ç–µ–º–∞ –æ–≥–Ω–µ–Ω–Ω—ã—Ö –∫—Ä—É–≥–æ–≤ –¥–ª—è —Å—Ç–∞–¥–∏–∏ 2
        let fireCircles = [];
        let fireShards = []; // –û—Ç–¥–µ–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –æ—Å–∫–æ–ª–∫–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å –ª–∏–º–∏—Ç–æ–º —á–∞—Å—Ç–∏—Ü
        let fireCircleAttack = {
            active: false,
            phase: 0,
            timer: 0,
            circlesSpawned: 0,
            totalCircles: 0,
            wavesTotal: 0,
            wavesDone: 0
        };

        // –ê—Ç–∞–∫–∞ –ú–∞—à–∏–Ω–∞
        let carAttack = {
            active: false,
            phase: 'warmup', // warmup, driving
            timer: 0,
            car: {
                x: -300,
                y: 0,
                width: 240,
                height: 120,
                speed: 0,
                dir: 1,
                shakeX: 0,
                shakeY: 0,
                state: 'hidden'
            },
            exhaust: [], // –®–ª–µ–π—Ñ –≤—ã—Ö–ª–æ–ø–∞
            engineAudio: null,
            musicAudio: null
        };

        // ==================== –ê–¢–ê–ö–ê –õ–ê–ë–ò–†–ò–ù–¢ (–°–¢–ê–î–ò–Ø 2) ====================
        let labyrinthWalls = []; // –°—Ç–µ–Ω—ã –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
        let labyrinthBonuses = []; // –ë–æ–Ω—É—Å—ã –≤–Ω—É—Ç—Ä–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        let labyrinthAttack = {
            active: false,
            phase: 0, // 0 - –∫–∞—Ç—Å—Ü–µ–Ω–∞ –∑–∞—Ö–≤–∞—Ç–∞, 1 - —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, 2 - —Ç–∞–π–º–µ—Ä, 3 - –∏–≥—Ä–∞ –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ, 4 - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            timer: 0,
            timeLimit: 40, // –í—Ä–µ–º—è –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ (—Å–µ–∫—É–Ω–¥—ã)
            timeLeft: 40,
            exitX: 0,
            exitY: 0,
            buildProgress: 0,
            hammerRotation: 0,
            timerVisible: false
        };

        function stopCarSounds() {
            if (carAttack.engineAudio) {
                try { carAttack.engineAudio.pause(); carAttack.engineAudio.currentTime = 0; } catch(e){}
                carAttack.engineAudio = null;
            }
            if (carAttack.musicAudio) {
                try { carAttack.musicAudio.pause(); carAttack.musicAudio.currentTime = 0; } catch(e){}
                carAttack.musicAudio = null;
            }
        }
        
        // –ë—Ä–æ—Å–æ–∫ –∫–∞–∫–∞—à–∫–∏ –≤ –±–æ—Å—Å–∞
        function throwPoopAtBoss() {
            if (!playerPoop || !finalBoss.active) return;
            
            const dx = finalBoss.x - player.x;
            const dy = finalBoss.y - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            thrownPoops.push({
                x: player.x,
                y: player.y,
                vx: (dx / dist) * 25,
                vy: (dy / dist) * 25,
                rotation: 0
            });
            
            playSound('swoosh', 0.4);
            playerPoop = null;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–∞–∫–∞—à–µ–∫
        function updateThrownPoops(dt) {
            thrownPoops = thrownPoops.filter(poop => {
                poop.x += poop.vx;
                poop.y += poop.vy;
                poop.rotation += 0.4;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –±–æ—Å—Å–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ –ø–∞—É–∑–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å!)
                if (finalBoss.active || eventSystem.type === 'finalBoss') {
                    const dx = poop.x - finalBoss.x;
                    const dy = poop.y - finalBoss.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < finalBoss.radius + 20) {
                        // –ü–û–ü–ê–î–ê–ù–ò–ï! –ë–æ—Å—Å —Ç–µ—Ä—è–µ—Ç HP!
                        finalBoss.health = Math.max(0, finalBoss.health - 10); // -10 HP
                        playSound('poopSplat', 0.7);
                        shakeScreen();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º HP –±–∞—Ä (—Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ–º maxHealth 150)
                        const hpPercent = (finalBoss.health / finalBoss.maxHealth) * 100;
                        document.querySelector('#finalBossBar .fill').style.width = hpPercent + '%';
                        
                        // –ß–∞—Å—Ç–∏—Ü—ã –ø–æ–ø–∞–¥–∞–Ω–∏—è (–∫–æ—Ä–∏—á–Ω–µ–≤—ã–µ)
                        for (let i = 0; i < 20; i++) {
                            particles.push({
                                x: poop.x,
                                y: poop.y,
                                vx: (Math.random() - 0.5) * 15,
                                vy: (Math.random() - 0.5) * 15,
                                radius: Math.random() * 6 + 3,
                                color: '#8B4513',
                                alpha: 1,
                                life: 0.8
                            });
                        }
                        
                        devLog(`üí© –ü–û–ü–ê–î–ê–ù–ò–ï! HP –±–æ—Å—Å–∞: ${finalBoss.health}/${finalBoss.maxHealth}`);
                        return false;
                    }
                }
                
                // –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ –≤—ã—à–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
                return poop.x > 0 && poop.x < canvas.width && poop.y > 0 && poop.y < canvas.height;
            });
        }
        
        // ==================== –ò–ì–†–û–ö ====================
        function updatePlayerMovement(dt) {
            if (!player.canMove) return;
            
            // WASD —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (controlType === 'wasd') {
                const speed = player.speed * (player.effects.speed ? 1.5 : 1);
                if (keys['w'] || keys['—Ü']) player.targetY -= speed;
                if (keys['s'] || keys['—ã']) player.targetY += speed;
                if (keys['a'] || keys['—Ñ']) player.targetX -= speed;
                if (keys['d'] || keys['–≤']) player.targetX += speed;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
            player.targetX = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.targetX));
            player.targetY = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.targetY));
            
            // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
            const dx = player.targetX - player.x;
            const dy = player.targetY - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
            const maxSpeed = player.speed * (player.effects.speed ? 1.5 : 1);
            let moveX = dx * 0.35;
            let moveY = dy * 0.35;
            const moveLen = Math.sqrt(moveX*moveX + moveY*moveY);
            if (moveLen > maxSpeed) {
                moveX = (moveX / moveLen) * maxSpeed;
                moveY = (moveY / moveLen) * maxSpeed;
            }
            
            player.x += moveX;
            player.y += moveY;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞
            player.x = Math.max(MAP_BOUNDS.minX + player.radius, Math.min(MAP_BOUNDS.maxX() - player.radius, player.x));
            player.y = Math.max(MAP_BOUNDS.minY + player.radius, Math.min(MAP_BOUNDS.maxY() - player.radius, player.y));
            
            // –ß–∞—Å—Ç–∏—Ü—ã –∑–∞ –∏–≥—Ä–æ–∫–æ–º (–æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ low mode)
            if (Math.random() < (lowGraphics ? 0.05 : 0.3)) {
                particles.push({
                    x: player.x,
                    y: player.y,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    radius: Math.random() * 3 + 1,
                    color: player.shield > 0 ? '#ffd700' : '#00d4ff',
                    alpha: 0.8,
                    life: lowGraphics ? 0.3 : 0.5
                });
            }
        }
        
        // ==================== –í–†–ê–ì ====================
        function updateEnemy(dt) {
            if (eventSystem.active) return;
            if (player.effects.freeze) return;
            
            const diff = DIFFICULTIES[difficulty];
            
            // –°–∫–æ—Ä–æ—Å—Ç—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º - –µ—â—ë –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ!
            const timeBonus = Math.min(timer * 0.05, 5); // +5 —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–∞–∫—Å–∏–º—É–º –∑–∞ 100 —Å–µ–∫—É–Ω–¥
            const currentSpeed = diff.speed + timeBonus * diff.speedScale;
            
            // –†–∞—Å—á—ë—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
            if (!enemy.lastPlayerPos) enemy.lastPlayerPos = { x: player.x, y: player.y };
            enemy.playerVelocity.x = (player.x - enemy.lastPlayerPos.x) / dt;
            enemy.playerVelocity.y = (player.y - enemy.lastPlayerPos.y) / dt;
            enemy.lastPlayerPos.x = player.x;
            enemy.lastPlayerPos.y = player.y;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∑—ã –¥–ª—è —Å–∏–Ω—É—Å–æ–∏–¥—ã –∏ –∑–∏–≥–∑–∞–≥–∞
            enemy.sinPhase += dt * 3;
            enemy.zigzagPhase += dt * 5;
            
            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            const distToPlayer = Math.sqrt((enemy.x - player.x)**2 + (enemy.y - player.y)**2);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º confusion
            if (enemy.confused) {
                enemy.confusedTimer -= dt;
                if (enemy.confusedTimer <= 0) {
                    enemy.confused = false;
                    enemy.aiMode = 'chase';
                }
            }
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏
            if (!enemy.reactionTimer) enemy.reactionTimer = 0;
            enemy.reactionTimer -= dt;
            
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            if (!enemy.lastKnownX) { enemy.lastKnownX = player.x; enemy.lastKnownY = player.y; }
            if (enemy.reactionTimer <= 0) {
                enemy.lastKnownX = player.x;
                enemy.lastKnownY = player.y;
                enemy.reactionTimer = diff.reactionDelay;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —â–∏—Ç –∏–≥—Ä–æ–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–∞–Ω–∏–∫–∏
            enemy.panicMode = player.shield > 0;
            
            // –û–±–º–∞–Ω–∫–∞ (bait) - –ø—Ä–∏—Ç–≤–æ—Ä—è–µ—Ç—Å—è —á—Ç–æ –æ—Ç—Å—Ç—É–ø–∞–µ—Ç
            if (!enemy.baitTimer) enemy.baitTimer = 0;
            enemy.baitTimer -= dt;
            
            // AI –≤—ã–±–æ—Ä –ø–æ–≤–µ–¥–µ–Ω–∏—è - –û–ß–ï–ù–¨ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∏ –¥–∏–Ω–∞–º–∏—á–Ω—ã–π
            enemy.aiTimer -= dt;
            
            // –ö–æ–º–±–æ-–∞—Ç–∞–∫–∏ - —Å–µ—Ä–∏—è –±—ã—Å—Ç—Ä—ã—Ö —Å–º–µ–Ω —Ä–µ–∂–∏–º–æ–≤
            if (!enemy.comboMode) enemy.comboMode = 0;
            if (!enemy.comboCooldown) enemy.comboCooldown = 0;
            enemy.comboCooldown -= dt;
            
            if (enemy.aiTimer <= 0 && !enemy.confused) {
                // –ß–∞—â–µ –º–µ–Ω—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —Å–ª–æ–∂–Ω–æ—Å—Ç—è—Ö
                enemy.aiTimer = 0.3 + Math.random() * (1.5 - diff.aiChance * 1.2);
                
                const roll = Math.random();
                
                // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —Å–æ —â–∏—Ç–æ–º - —Ä–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏ (–≤—ã–∂–∏–¥–∞–Ω–∏–µ –∏–ª–∏ –∑–∞—Ö–æ–¥ —Å–æ —Å–ø–∏–Ω—ã)
                if (enemy.panicMode && roll < 0.3 * diff.aiChance) {
                    const panicModes = ['orbit', 'waitForShield', 'flankBack'];
                    enemy.aiMode = panicModes[Math.floor(Math.random() * panicModes.length)];
                    enemy.aiTimer = 1 + Math.random();
                }
                // –û–±–º–∞–Ω–∫–∞ (Bait) - –ø—Ä–∏—Ç–≤–æ—Ä—è–µ—Ç—Å—è —á—Ç–æ –æ—Ç—Å—Ç—É–ø–∞–µ—Ç, –ø–æ—Ç–æ–º —Ä—ã–≤–æ–∫
                else if (roll < diff.baitChance && distToPlayer < 300 && enemy.baitTimer <= 0) {
                    enemy.aiMode = 'bait';
                    enemy.baitTimer = 8; // –ö—É–ª–¥–∞—É–Ω –æ–±–º–∞–Ω–∫–∏
                    enemy.baitPhase = 0;
                    enemy.baitDuration = 0.6 + Math.random() * 0.4;
                    // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "–æ—Ç—Å—Ç—É–ø–ª–µ–Ω–∏—è" - –æ—Ç –∏–≥—Ä–æ–∫–∞
                    const dx = enemy.x - player.x;
                    const dy = enemy.y - player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    enemy.baitDirection = { x: dx/dist, y: dy/dist };
                }
                // –®–∞–Ω—Å –∫–æ–º–±–æ-–∞—Ç–∞–∫–∏ (—Å–µ—Ä–∏—è —Ä—ã–≤–∫–æ–≤ –∏ –æ–±–º–∞–Ω–æ–∫)
                else if (roll < 0.15 * diff.aiChance && distToPlayer < 400 && enemy.comboCooldown <= 0) {
                    enemy.comboMode = 4; // 4 –±—ã—Å—Ç—Ä—ã—Ö –∞—Ç–∞–∫–∏ –ø–æ–¥—Ä—è–¥
                    enemy.comboCooldown = 12;
                }
                // –ï—Å–ª–∏ –≤ –∫–æ–º–±–æ —Ä–µ–∂–∏–º–µ - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∞—Ç–∞–∫–∏
                else if (enemy.comboMode > 0) {
                    enemy.comboMode--;
                    enemy.aiTimer = 0.25;
                    
                    const comboModes = ['rush', 'intercept', 'flank', 'predict'];
                    enemy.aiMode = comboModes[Math.floor(Math.random() * comboModes.length)];
                    enemy.rushDuration = 0.5;
                } 
                // –†—ã–≤–æ–∫ –∫–æ–≥–¥–∞ –±–ª–∏–∑–∫–æ
                else if (roll < diff.rushChance && distToPlayer < 450) {
                    enemy.aiMode = 'rush';
                    enemy.rushDuration = 0.6 + Math.random() * 0.4;
                } 
                // –î–≤–æ–π–Ω–æ–π —Ä—ã–≤–æ–∫ –∫–æ–≥–¥–∞ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ
                else if (roll < diff.rushChance * 1.5 && distToPlayer < 280) {
                    enemy.aiMode = 'doubleRush';
                    enemy.rushDuration = 1.0;
                    enemy.doubleRushPhase = 0;
                } 
                // –°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ - –ø–ª–∞–≤–Ω—ã–µ –¥—É–≥–∏
                else if (roll < diff.aiChance * 0.25) {
                    enemy.aiMode = 'sinusoidal';
                    enemy.sinPhase = 0;
                }
                // –ó–∏–≥–∑–∞–≥ –ø—Ä–∏ —Å–±–ª–∏–∂–µ–Ω–∏–∏
                else if (roll < diff.aiChance * 0.4 && distToPlayer < 400) {
                    enemy.aiMode = 'zigzag';
                    enemy.zigzagPhase = 0;
                }
                // –ö—Ä—É–≥–æ–≤–æ–π –æ–±—Ö–æ–¥
                else if (roll < diff.aiChance * 0.55) {
                    enemy.aiMode = 'orbit';
                    enemy.orbitAngle = Math.atan2(enemy.y - player.y, enemy.x - player.x);
                    enemy.orbitDir = Math.random() < 0.5 ? 1 : -1;
                }
                // –û–ø–µ—Ä–µ–∂–µ–Ω–∏–µ - —Å—Ç—Ä–µ–ª—å–±–∞ –Ω–∞ –æ–ø–µ—Ä–µ–∂–µ–Ω–∏–µ
                else if (roll < diff.aiChance * 0.7) {
                    enemy.aiMode = 'leadShot';
                }
                // –£–º–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ - –∑–∞—Ö–æ–¥ —Å —Ñ–ª–∞–Ω–≥–∞ –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —É —Å—Ç–µ–Ω—ã
                else if (roll < diff.aiChance * 0.85) {
                    enemy.aiMode = 'smartFlank';
                }
                // –î—Ä—É–≥–∏–µ —É–º–Ω—ã–µ —Ä–µ–∂–∏–º—ã
                else if (roll < diff.aiChance) {
                    const modes = ['intercept', 'ambush', 'flank', 'pincer', 'predict'];
                    enemy.aiMode = modes[Math.floor(Math.random() * modes.length)];
                } 
                else {
                    enemy.aiMode = 'chase';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä—ã–≤–æ–∫
            if (enemy.aiMode === 'rush' && enemy.rushDuration !== undefined) {
                enemy.rushDuration -= dt;
                if (enemy.rushDuration <= 0) {
                    enemy.aiMode = 'chase';
                }
            }
            
            // –¶–µ–ª—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º lastKnown –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏
            let targetX = enemy.lastKnownX;
            let targetY = enemy.lastKnownY;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ–∫—Ç–æ—Ä –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
            if (!enemy.playerVelX) { enemy.playerVelX = 0; enemy.playerVelY = 0; }
            const velSmooth = 0.1;
            enemy.playerVelX += (player.targetX - player.x - enemy.playerVelX) * velSmooth;
            enemy.playerVelY += (player.targetY - player.y - enemy.playerVelY) * velSmooth;
            
            if (enemy.aiMode === 'intercept') {
                // –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞
                const predTime = 20 + diff.interceptPower * 40;
                targetX = player.x + enemy.playerVelX * predTime * diff.interceptPower;
                targetY = player.y + enemy.playerVelY * predTime * diff.interceptPower;
            } else if (enemy.aiMode === 'ambush') {
                // –ó–∞–±–µ–≥–∞–µ–º –≤–ø–µ—Ä—ë–¥ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
                const velLen = Math.sqrt(enemy.playerVelX**2 + enemy.playerVelY**2);
                if (velLen > 0.5) {
                    targetX = player.x + (enemy.playerVelX / velLen) * (150 + diff.interceptPower * 150);
                    targetY = player.y + (enemy.playerVelY / velLen) * (150 + diff.interceptPower * 150);
                }
            } else if (enemy.aiMode === 'flank') {
                // –û–±—Ö–æ–¥–∏–º —Å–±–æ–∫—É - –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –¥–≤–∏–∂–µ–Ω–∏—é –∏–≥—Ä–æ–∫–∞
                const velLen = Math.sqrt(enemy.playerVelX**2 + enemy.playerVelY**2);
                if (velLen > 0.3) {
                    // –í—ã–±–∏—Ä–∞–µ–º —Å—Ç–æ—Ä–æ–Ω—É –æ–±—Ö–æ–¥–∞ (–±–ª–∏–∂–µ –∫ –≤—Ä–∞–≥—É)
                    const perpX1 = -enemy.playerVelY / velLen;
                    const perpY1 = enemy.playerVelX / velLen;
                    const perpX2 = enemy.playerVelY / velLen;
                    const perpY2 = -enemy.playerVelX / velLen;
                    
                    const d1 = Math.sqrt((player.x + perpX1 * 100 - enemy.x)**2 + (player.y + perpY1 * 100 - enemy.y)**2);
                    const d2 = Math.sqrt((player.x + perpX2 * 100 - enemy.x)**2 + (player.y + perpY2 * 100 - enemy.y)**2);
                    
                    if (d1 < d2) {
                        targetX = player.x + perpX1 * 120;
                        targetY = player.y + perpY1 * 120;
                    } else {
                        targetX = player.x + perpX2 * 120;
                        targetY = player.y + perpY2 * 120;
                    }
                }
            } else if (enemy.aiMode === 'pincer') {
                // –ö–ª–µ—à–Ω–∏ - –∑–∞–≥–æ–Ω—è–µ–º –∫ —Å—Ç–µ–Ω–µ
                const toWallX = player.x < canvas.width/2 ? MAP_BOUNDS.minX : MAP_BOUNDS.maxX();
                const toWallY = player.y < canvas.height/2 ? MAP_BOUNDS.minY : MAP_BOUNDS.maxY();
                targetX = (player.x + toWallX) / 2;
                targetY = (player.y + toWallY) / 2;
            } else if (enemy.aiMode === 'predict') {
                // –°–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–∫–æ—Ä–µ–Ω–∏—è
                const accelX = player.targetX - player.x;
                const accelY = player.targetY - player.y;
                const predTime = 30 * diff.interceptPower;
                targetX = player.x + accelX * predTime * 0.3;
                targetY = player.y + accelY * predTime * 0.3;
            } else if (enemy.aiMode === 'feint') {
                // –û–±–º–∞–Ω–∫–∞ - —Å–Ω–∞—á–∞–ª–∞ –∏–¥—ë–º –≤ –¥—Ä—É–≥—É—é —Å—Ç–æ—Ä–æ–Ω—É
                if (enemy.feintTimer > 0) {
                    enemy.feintTimer -= dt;
                    targetX = enemy.feintDir.x;
                    targetY = enemy.feintDir.y;
                } else {
                    // –†–µ–∑–∫–∏–π —Ä—ã–≤–æ–∫ –∫ –∏–≥—Ä–æ–∫—É!
                    enemy.aiMode = 'rush';
                    enemy.rushDuration = 0.6;
                }
            } else if (enemy.aiMode === 'orbit') {
                // –ö—Ä—É–≥–æ–≤–æ–π –æ–±—Ö–æ–¥ - –±–µ–∂–∏—Ç –ø–æ –¥—É–≥–µ –∫ –∏–≥—Ä–æ–∫—É
                enemy.orbitAngle += enemy.orbitDir * 0.03 * (1 + diff.aiChance);
                const orbitRadius = 150 - diff.aiChance * 50;
                targetX = player.x + Math.cos(enemy.orbitAngle) * orbitRadius;
                targetY = player.y + Math.sin(enemy.orbitAngle) * orbitRadius;
                
                // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å—É–∂–∞–µ–º –æ—Ä–±–∏—Ç—É
                const shrinkRate = 0.02;
                targetX = targetX * (1 - shrinkRate) + player.x * shrinkRate;
                targetY = targetY * (1 - shrinkRate) + player.y * shrinkRate;
            } else if (enemy.aiMode === 'doubleRush') {
                // –î–≤–æ–π–Ω–æ–π —Ä—ã–≤–æ–∫ - —Ä—ã–≤–æ–∫, –ø–∞—É–∑–∞, —Ä—ã–≤–æ–∫
                if (enemy.doubleRushPhase === 0) {
                    // –ü–µ—Ä–≤—ã–π —Ä—ã–≤–æ–∫
                    targetX = player.x;
                    targetY = player.y;
                    if (enemy.rushDuration < 0.4) {
                        enemy.doubleRushPhase = 1;
                        enemy.rushDuration = 0.2; // –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞
                    }
                } else if (enemy.doubleRushPhase === 1) {
                    // –ü–∞—É–∑–∞ - —Å—Ç–æ–∏–º –Ω–∞ –º–µ—Å—Ç–µ
                    targetX = enemy.x;
                    targetY = enemy.y;
                    if (enemy.rushDuration <= 0) {
                        enemy.doubleRushPhase = 2;
                        enemy.rushDuration = 0.4; // –í—Ç–æ—Ä–æ–π —Ä—ã–≤–æ–∫
                    }
                } else {
                    // –í—Ç–æ—Ä–æ–π —Ä—ã–≤–æ–∫ –∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                    targetX = player.x + enemy.playerVelX * 20;
                    targetY = player.y + enemy.playerVelY * 20;
                }
            } else if (enemy.aiMode === 'zigzag') {
                // –ó–∏–≥–∑–∞–≥ - –±–µ–∂–∏—Ç –∫ –∏–≥—Ä–æ–∫—É –∑–∏–≥–∑–∞–≥–∞–º–∏
                enemy.zigzagPhase += dt * (5 + diff.zigzagIntensity * 3);
                
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > 0) {
                    const perpX = -dy / dist;
                    const perpY = dx / dist;
                    const zigzagOffset = Math.sin(enemy.zigzagPhase) * (80 + diff.zigzagIntensity * 60);
                    
                    targetX = player.x + perpX * zigzagOffset;
                    targetY = player.y + perpY * zigzagOffset;
                }
            } else if (enemy.aiMode === 'sinusoidal') {
                // –°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ - –ø–ª–∞–≤–Ω—ã–µ –¥—É–≥–∏
                enemy.sinPhase += dt * 2.5;
                
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > 0) {
                    // –ü–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –¥—É–≥–∏
                    const perpX = -dy / dist;
                    const perpY = dx / dist;
                    const sinOffset = Math.sin(enemy.sinPhase) * diff.sinAmplitude;
                    
                    targetX = player.x + perpX * sinOffset;
                    targetY = player.y + perpY * sinOffset;
                }
            } else if (enemy.aiMode === 'bait') {
                // –û–±–º–∞–Ω–∫–∞ (Bait) - –ø—Ä–∏—Ç–≤–æ—Ä—è–µ—Ç—Å—è —á—Ç–æ –æ—Ç—Å—Ç—É–ø–∞–µ—Ç
                if (!enemy.baitPhase) enemy.baitPhase = 0;
                
                if (enemy.baitPhase === 0) {
                    // –§–∞–∑–∞ 1: "–û—Ç—Å—Ç—É–ø–∞–µ–º" –æ—Ç –∏–≥—Ä–æ–∫–∞
                    enemy.baitDuration -= dt;
                    targetX = enemy.x + enemy.baitDirection.x * 150;
                    targetY = enemy.y + enemy.baitDirection.y * 150;
                    
                    if (enemy.baitDuration <= 0) {
                        enemy.baitPhase = 1;
                        enemy.rushDuration = 0.8;
                    }
                } else {
                    // –§–∞–∑–∞ 2: –†–ï–ó–ö–ò–ô –†–´–í–û–ö –∫ –∏–≥—Ä–æ–∫—É!
                    targetX = player.x;
                    targetY = player.y;
                    enemy.rushDuration -= dt;
                    if (enemy.rushDuration <= 0) {
                        enemy.aiMode = 'chase';
                    }
                }
            } else if (enemy.aiMode === 'leadShot') {
                // –û–ø–µ—Ä–µ–∂–µ–Ω–∏–µ - —Å—Ç—Ä–µ–ª—è–µ–º —Ç—É–¥–∞ –≥–¥–µ –∏–≥—Ä–æ–∫ –ë–£–î–ï–¢
                const predTime = 0.5 + diff.interceptPower * 0.8;
                targetX = player.x + enemy.playerVelocity.x * predTime * 0.02;
                targetY = player.y + enemy.playerVelocity.y * predTime * 0.02;
            } else if (enemy.aiMode === 'smartFlank') {
                // –£–º–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ - –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —É —Å—Ç–µ–Ω—ã, –∑–∞—Ö–æ–¥–∏–º —Å —Ñ–ª–∞–Ω–≥–∞
                const playerNearWallLeft = player.x < MAP_BOUNDS.minX + 150;
                const playerNearWallRight = player.x > MAP_BOUNDS.maxX() - 150;
                const playerNearWallTop = player.y < MAP_BOUNDS.minY + 150;
                const playerNearWallBottom = player.y > MAP_BOUNDS.maxY() - 150;
                
                if (playerNearWallLeft) {
                    // –ó–∞—Ö–æ–¥–∏–º —Å–ø—Ä–∞–≤–∞
                    targetX = player.x + 100;
                    targetY = player.y + (Math.random() - 0.5) * 100;
                } else if (playerNearWallRight) {
                    // –ó–∞—Ö–æ–¥–∏–º —Å–ª–µ–≤–∞
                    targetX = player.x - 100;
                    targetY = player.y + (Math.random() - 0.5) * 100;
                } else if (playerNearWallTop) {
                    // –ó–∞—Ö–æ–¥–∏–º —Å–Ω–∏–∑—É
                    targetX = player.x + (Math.random() - 0.5) * 100;
                    targetY = player.y + 100;
                } else if (playerNearWallBottom) {
                    // –ó–∞—Ö–æ–¥–∏–º —Å–≤–µ—Ä—Ö—É
                    targetX = player.x + (Math.random() - 0.5) * 100;
                    targetY = player.y - 100;
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —É —Å—Ç–µ–Ω—ã - –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ—Å–ª–µ–¥—É–µ–º
                    targetX = player.x;
                    targetY = player.y;
                }
            } else if (enemy.aiMode === 'waitForShield') {
                // –ü–∞–Ω–∏–∫–∞: –∂–¥—ë–º –∫–æ–≥–¥–∞ —â–∏—Ç –ø—Ä–æ–ø–∞–¥—ë—Ç, –¥–µ—Ä–∂–∏–º—Å—è –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏
                const safeDist = 200;
                const dx = enemy.x - player.x;
                const dy = enemy.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < safeDist) {
                    // –û—Ç—Ö–æ–¥–∏–º
                    targetX = enemy.x + dx / dist * 50;
                    targetY = enemy.y + dy / dist * 50;
                } else {
                    // –ö—Ä—É–∂–∏–º –≤–æ–∫—Ä—É–≥
                    if (!enemy.orbitAngle) enemy.orbitAngle = Math.atan2(dy, dx);
                    enemy.orbitAngle += 0.02;
                    targetX = player.x + Math.cos(enemy.orbitAngle) * safeDist;
                    targetY = player.y + Math.sin(enemy.orbitAngle) * safeDist;
                }
                
                // –ï—Å–ª–∏ —â–∏—Ç –ø—Ä–æ–ø–∞–ª - –∞—Ç–∞–∫—É–µ–º!
                if (player.shield === 0) {
                    enemy.aiMode = 'rush';
                    enemy.rushDuration = 0.8;
                }
            } else if (enemy.aiMode === 'flankBack') {
                // –ü–∞–Ω–∏–∫–∞: –∑–∞—Ö–æ–¥–∏–º —Å–æ —Å–ø–∏–Ω—ã
                const velLen = Math.sqrt(enemy.playerVelocity.x**2 + enemy.playerVelocity.y**2);
                if (velLen > 0.01) {
                    // –ó–∞—Ö–æ–¥–∏–º –ø–æ–∑–∞–¥–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
                    const backX = -enemy.playerVelocity.x / velLen;
                    const backY = -enemy.playerVelocity.y / velLen;
                    targetX = player.x + backX * 150;
                    targetY = player.y + backY * 150;
                } else {
                    targetX = player.x;
                    targetY = player.y;
                }
            } else if (enemy.confused) {
                // –°–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                targetX = enemy.x + (Math.random() - 0.5) * 200;
                targetY = enemy.y + (Math.random() - 0.5) * 200;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ü–µ–ª—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–∞—Ä—Ç—ã
            targetX = Math.max(MAP_BOUNDS.minX + 50, Math.min(MAP_BOUNDS.maxX() - 50, targetX));
            targetY = Math.max(MAP_BOUNDS.minY + 50, Math.min(MAP_BOUNDS.maxY() - 50, targetY));
            
            // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
            const dx = targetX - enemy.x;
            const dy = targetY - enemy.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if (dist > 0) {
                let speed = currentSpeed * (player.effects.slow ? 0.35 : 1);
                
                // –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
                if (enemy.aiMode === 'rush') speed *= 2.5;
                else if (enemy.aiMode === 'doubleRush' && enemy.doubleRushPhase === 2) speed *= 2.8;
                else if (enemy.aiMode === 'bait' && enemy.baitPhase === 1) speed *= 3.0; // –†—ã–≤–æ–∫ –ø–æ—Å–ª–µ –æ–±–º–∞–Ω–∫–∏ –û–ß–ï–ù–¨ –±—ã—Å—Ç—Ä—ã–π
                else if (enemy.aiMode === 'leadShot') speed *= 1.4;
                else if (enemy.aiMode === 'sinusoidal') speed *= 1.2;
                else if (enemy.aiMode === 'zigzag') speed *= 1.3;
                
                // –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –±–ª–∏–∑–∫–æ –∫ –∏–≥—Ä–æ–∫—É
                const distToPlayer = Math.sqrt((enemy.x - player.x)**2 + (enemy.y - player.y)**2);
                if (distToPlayer < 250) {
                    speed *= 1 + (1 - distToPlayer / 250) * 0.4 * diff.aiChance;
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ –∫–æ–º–±–æ-—Ä–µ–∂–∏–º–µ
                if (enemy.comboMode > 0) {
                    speed *= 1.15;
                }
                
                const moveX = (dx / dist) * speed;
                const moveY = (dy / dist) * speed;
                
                // –ü–ª–∞–≤–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ - –º–µ–Ω–µ–µ –ø–ª–∞–≤–Ω–æ = —Ä–µ–∑—á–µ –¥–≤–∏–∂–µ–Ω–∏—è
                const smoothing = 0.2 + diff.aiChance * 0.15;
                enemy.smoothX += (enemy.x + moveX - enemy.smoothX) * smoothing;
                enemy.smoothY += (enemy.y + moveY - enemy.smoothY) * smoothing;
                
                enemy.x = enemy.smoothX;
                enemy.y = enemy.smoothY;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
            enemy.x = Math.max(MAP_BOUNDS.minX + enemy.radius, Math.min(MAP_BOUNDS.maxX() - enemy.radius, enemy.x));
            enemy.y = Math.max(MAP_BOUNDS.minY + enemy.radius, Math.min(MAP_BOUNDS.maxY() - enemy.radius, enemy.y));
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
            if (!player.effects.invisible && !godMode) {
                const collDist = Math.sqrt((enemy.x - player.x)**2 + (enemy.y - player.y)**2);
                if (collDist < enemy.radius + player.radius) {
                    if (player.shield > 0) {
                        player.shield--;
                        playSound('hit', 0.5);
                        
                        // –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–∞–≥–∞
                        let newX, newY;
                        do {
                            newX = MAP_BOUNDS.minX + 100 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 200);
                            newY = MAP_BOUNDS.minY + 100 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 200);
                        } while (Math.sqrt((newX - player.x)**2 + (newY - player.y)**2) < 350);
                        
                        enemy.x = newX;
                        enemy.y = newY;
                        enemy.smoothX = newX;
                        enemy.smoothY = newY;
                        
                        // –ß–∞—Å—Ç–∏—Ü—ã —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
                        for (let i = 0; i < 20; i++) {
                            particles.push({
                                x: newX,
                                y: newY,
                                vx: (Math.random() - 0.5) * 10,
                                vy: (Math.random() - 0.5) * 10,
                                radius: Math.random() * 5 + 2,
                                color: '#ff0066',
                                alpha: 1,
                                life: 0.8
                            });
                        }
                    } else {
                        gameOver();
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä AI
            const modeNames = {
                'chase': 'üéØ –ü–æ–≥–æ–Ω—è',
                'intercept': 'üß† –ü–µ—Ä–µ—Ö–≤–∞—Ç',
                'ambush': 'üï≥Ô∏è –ó–∞—Å–∞–¥–∞',
                'rush': '‚ö° –†–´–í–û–ö!',
                'flank': 'üîÑ –û–±—Ö–æ–¥',
                'pincer': 'ü¶Ä –ö–ª–µ—à–Ω–∏',
                'predict': 'üîÆ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ',
                'confused': 'üòµ –°–±–∏—Ç —Å —Ç–æ–ª–∫—É',
                'feint': 'üé≠ –û–±–º–∞–Ω–∫–∞',
                'orbit': 'üåÄ –û—Ä–±–∏—Ç–∞',
                'doubleRush': '‚ö°‚ö° –î–í–û–ô–ù–û–ô –†–´–í–û–ö!',
                'zigzag': '„Ä∞Ô∏è –ó–∏–≥–∑–∞–≥',
                'sinusoidal': 'üåä –°–∏–Ω—É—Å–æ–∏–¥–∞',
                'bait': 'üé£ –û–±–º–∞–Ω–∫–∞-–†—ã–≤–æ–∫',
                'leadShot': 'üéØ –û–ø–µ—Ä–µ–∂–µ–Ω–∏–µ',
                'smartFlank': 'üß† –£–º–Ω—ã–π –û–±—Ö–æ–¥',
                'waitForShield': '‚è≥ –í—ã–∂–∏–¥–∞–µ—Ç',
                'flankBack': 'üîô –ó–∞—Ö–æ–¥ —Å–æ –°–ø–∏–Ω—ã'
            };
            const speedInfo = ` | –°–∫–æ—Ä–æ—Å—Ç—å: ${currentSpeed.toFixed(1)}`;
            const comboInfo = enemy.comboMode > 0 ? ' | üî• –ö–û–ú–ë–û!' : '';
            const panicInfo = enemy.panicMode ? ' | üò∞ –ü–ê–ù–ò–ö–ê' : '';
            document.getElementById('aiMode').textContent = `ü§ñ AI: ${modeNames[enemy.aiMode] || enemy.aiMode}${speedInfo}${comboInfo}${panicInfo}`;
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï ====================
        function update(dt) {
            if (gameState !== 'playing') return;
            if (gamePaused) return;
            
            timer += dt;
            
            // –ö—É–ª–¥–∞—É–Ω—ã
            Object.keys(skillCooldowns).forEach(skill => {
                if (skillCooldowns[skill] > 0) {
                    skillCooldowns[skill] -= dt;
                }
            });
            
            // –≠—Ñ—Ñ–µ–∫—Ç—ã
            Object.keys(player.effects).forEach(effect => {
                if (player.effects[effect] > 0) {
                    player.effects[effect] -= dt;
                    if (player.effects[effect] <= 0) {
                        delete player.effects[effect];
                        if (effect === 'freeze') {
                            document.getElementById('timeStopAura').classList.remove('active');
                        }
                    }
                }
            });
            
            // –ö–∞—Ç—Å—Ü–µ–Ω–∞
            if (cutscene.active) {
                updateCutscene(dt);
                updateCamera(dt);
                updateParticles(dt);
                return;
            }
            
            // –ò–≤–µ–Ω—Ç—ã
            if (eventSystem.active) {
                if (eventSystem.type === 'mellstroy') {
                    updateMellstroyEvent(dt);
                } else if (eventSystem.type === 'zhiragedon') {
                    updateZhiragedonEvent(dt);
                } else if (eventSystem.type === 'finalBoss') {
                    updateFinalBossEvent(dt);
                }
                updateCamera(dt);
                updateParticles(dt);
                return;
            }
            
            updateEvents(dt);
            updatePlayerMovement(dt);
            updateEnemy(dt);
            updateParticles(dt);
            updatePowerups(dt);
            updateCoins(dt);
            updateCamera(dt);
            
            // –°–ø–∞–≤–Ω –±–æ–Ω—É—Å–æ–≤ (—Ä–µ–∂–µ –≤ low mode –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
            const powerupChance = lowGraphics ? 0.002 : 0.003;
            const coinChance = lowGraphics ? 0.005 : 0.008;
            if (Math.random() < powerupChance) {
                spawnPowerup();
            }
            if (Math.random() < coinChance) {
                spawnCoin();
            }
            
            // UI
            document.getElementById('timer').textContent = `‚è±Ô∏è ${timer.toFixed(1)}s`;
            document.getElementById('score').textContent = `üí∞ ${score}`;
            document.getElementById('combo').textContent = combo > 1 ? `üî• x${combo} COMBO` : '';
            
            updateEffectsUI();
            updateSkillsUI();
        }
        
        function updateParticles(dt) {
            // –§–æ–Ω–æ–≤—ã–µ —á–∞—Å—Ç–∏—Ü—ã
            bgParticles.forEach(p => {
                p.x += Math.cos(p.angle) * p.speed;
                p.y += Math.sin(p.angle) * p.speed;
                
                if (p.x < 0) p.x = canvas.width;
                if (p.x > canvas.width) p.x = 0;
                if (p.y < 0) p.y = canvas.height;
                if (p.y > canvas.height) p.y = 0;
            });
            
            // –û–±—ã—á–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã - –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ low mode
            const maxParticles = lowGraphics ? 50 : 500;
            if (particles.length > maxParticles) {
                particles = particles.slice(-maxParticles);
            }
            
            particles = particles.filter(p => {
                if (p.type === 'shockwave') {
                    p.radius += 8;
                    p.alpha -= lowGraphics ? 0.04 : 0.02;
                    return p.alpha > 0;
                }
                
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.98; // –ù–µ–±–æ–ª—å—à–æ–µ —Ç—Ä–µ–Ω–∏–µ
                p.vy *= 0.98;
                p.life -= dt;
                p.alpha = Math.min(1, p.life);
                
                // –û—Å–∫–æ–ª–∫–∏ –æ—Ç CENSORED —Ä–∞–∫–µ—Ç—ã –º–æ–≥—É—Ç —Ä–∞–Ω–∏—Ç—å –∏–≥—Ä–æ–∫–∞!
                if (p.isFragment && p.life > 0.3) {
                    const dx = p.x - player.x;
                    const dy = p.y - player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < p.radius + player.radius) {
                        if (player.shield > 0) {
                            player.shield--;
                            playSound('hit', 0.4);
                            p.life = 0; // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –æ—Å–∫–æ–ª–æ–∫
                        } else if (!godMode) {
                            gameOver();
                        }
                    }
                }
                
                return p.life > 0;
            });
            
            // –î—ã–º
            smokeParticles = smokeParticles.filter(s => {
                s.timer -= dt;
                s.alpha = s.timer / 3;
                s.radius += 0.5;
                return s.timer > 0;
            });
            
            // –ü—Ä–∏–∑—Ä–∞–∫–∏ —Ä—ã–≤–∫–∞
            dashGhosts = dashGhosts.filter(g => {
                g.timer -= dt;
                g.alpha = g.timer * 2;
                return g.timer > 0;
            });
        }
        
        function updatePowerups(dt) {
            powerups = powerups.filter(p => {
                p.timer -= dt;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–±–æ—Ä–∞
                const dx = p.x - player.x;
                const dy = p.y - player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < player.radius + 25) {
                    playSound('powerup', 0.4);
                    applyPowerup(p.type);
                    return false;
                }
                
                return p.timer > 0;
            });
        }
        
        function updateCoins(dt) {
            coins = coins.filter(c => {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–±–æ—Ä–∞
                const dx = c.x - player.x;
                const dy = c.y - player.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                // –ü—Ä–∏—Ç—è–≥–∏–≤–∞–Ω–∏–µ –º–∞–≥–Ω–∏—Ç–æ–º
                if (player.effects.magnet && dist < 200) {
                    c.x -= dx * 0.1;
                    c.y -= dy * 0.1;
                    dist = Math.sqrt((c.x - player.x)**2 + (c.y - player.y)**2);
                }
                
                if (dist < player.radius + 15) {
                    playSound('coin', 0.15);
                    const value = c.golden ? 5 : 1;
                    score += value * (player.effects.doublePoints ? 2 : 1);
                    combo++;
                    return false;
                }
                
                return true;
            });
        }
        
        function updateCamera(dt) {
            camera.x += (camera.targetX - camera.x) * 0.08;
            camera.y += (camera.targetY - camera.y) * 0.08;
            camera.zoom += (camera.targetZoom - camera.zoom) * 0.08;
        }
        
        function spawnPowerup() {
            if (powerups.length >= 4) return;
            
            const types = ['slow', 'shield', 'shrink', 'speed', 'invisible', 'freeze', 'magnet', 'doublePoints'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            powerups.push({
                x: MAP_BOUNDS.minX + 50 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 100),
                y: MAP_BOUNDS.minY + 50 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 100),
                type: type,
                timer: 15
            });
        }
        
        function spawnCoin() {
            if (coins.length >= 10) return;
            
            coins.push({
                x: MAP_BOUNDS.minX + 50 + Math.random() * (MAP_BOUNDS.maxX() - MAP_BOUNDS.minX - 100),
                y: MAP_BOUNDS.minY + 50 + Math.random() * (MAP_BOUNDS.maxY() - MAP_BOUNDS.minY - 100),
                golden: Math.random() < 0.1,
                rotation: 0
            });
        }
        
        function applyPowerup(type) {
            switch(type) {
                case 'slow':
                    player.effects.slow = 4;
                    break;
                case 'shield':
                    player.shield = Math.min(3, player.shield + 1);
                    break;
                case 'shrink':
                    player.effects.shrink = 5;
                    break;
                case 'speed':
                    player.effects.speed = 4;
                    break;
                case 'invisible':
                    player.effects.invisible = 3;
                    break;
                case 'freeze':
                    player.effects.freeze = 2;
                    break;
                case 'magnet':
                    player.effects.magnet = 5;
                    break;
                case 'doublePoints':
                    player.effects.doublePoints = 6;
                    break;
            }
        }
        
        function updateEffectsUI() {
            const container = document.getElementById('effects');
            container.innerHTML = '';
            
            if (player.shield > 0) {
                const badge = document.createElement('div');
                badge.className = 'effect-badge';
                badge.style.background = 'linear-gradient(135deg, #f1c40f, #e67e22)';
                badge.textContent = `üõ°Ô∏è x${player.shield}`;
                container.appendChild(badge);
            }
            
            const effectNames = {
                slow: { icon: 'üêå', color: '#3498db' },
                speed: { icon: '‚ö°', color: '#f39c12' },
                invisible: { icon: 'üëª', color: '#9b59b6' },
                freeze: { icon: '‚è±Ô∏è', color: '#8e44ad' },
                magnet: { icon: 'üß≤', color: '#e74c3c' },
                doublePoints: { icon: '‚ú®', color: '#2ecc71' },
                shrink: { icon: 'üî¨', color: '#1abc9c' }
            };
            
            Object.keys(player.effects).forEach(effect => {
                if (player.effects[effect] > 0 && effectNames[effect]) {
                    const badge = document.createElement('div');
                    badge.className = 'effect-badge';
                    badge.style.background = effectNames[effect].color;
                    badge.textContent = `${effectNames[effect].icon} ${player.effects[effect].toFixed(1)}s`;
                    container.appendChild(badge);
                }
            });
        }
        
        function updateSkillsUI() {
            document.querySelectorAll('.hotbar-slot').forEach(slot => {
                const skill = slot.dataset.skill;
                const cd = skillCooldowns[skill];
                const maxCd = SKILL_COOLDOWNS[skill];
                
                if (cd > 0) {
                    slot.classList.add('on-cooldown');
                    const progress = (cd / maxCd) * 100;
                    slot.style.setProperty('--cd-progress', progress + '%');
                    
                    let cdText = slot.querySelector('.cd-text');
                    if (!cdText) {
                        cdText = document.createElement('span');
                        cdText.className = 'cd-text';
                        slot.appendChild(cdText);
                    }
                    cdText.textContent = cd.toFixed(1);
                } else {
                    slot.classList.remove('on-cooldown');
                    slot.style.setProperty('--cd-progress', '0%');
                    const cdText = slot.querySelector('.cd-text');
                    if (cdText) cdText.remove();
                }
            });
        }
        
        // ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω
            const gradX = player.x / canvas.width;
            const gradY = player.y / canvas.height;
            const gradient = ctx.createRadialGradient(
                player.x, player.y, 0,
                player.x, player.y, 500
            );
            gradient.addColorStop(0, `hsl(${240 + gradX * 60}, 50%, 20%)`);
            gradient.addColorStop(1, `hsl(${280 + gradY * 40}, 40%, 10%)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –°–µ—Ç–∫–∞ - –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ low mode
            if (lowGraphics) {
                // –ë–µ–∑ —Å–µ—Ç–∫–∏ –≤ low mode
            } else {
            ctx.strokeStyle = 'rgba(255,255,255,0.03)';
            ctx.lineWidth = 1;
            const gridSize = 50;
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            } // –ó–∞–∫—Ä—ã–≤–∞–µ–º —É—Å–ª–æ–≤–∏–µ !lowGraphics –¥–ª—è —Å–µ—Ç–∫–∏
            
            // –§–æ–Ω–æ–≤—ã–µ —á–∞—Å—Ç–∏—Ü—ã
            if (!lowGraphics) {
                bgParticles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞–º–µ—Ä—É
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-canvas.width/2 - camera.x, -canvas.height/2 - camera.y);
            
            // –î—ã–º
            smokeParticles.forEach(s => {
                const grad = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.radius);
                grad.addColorStop(0, `rgba(100, 100, 100, ${s.alpha * 0.5})`);
                grad.addColorStop(1, `rgba(50, 50, 50, 0)`);
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
                ctx.fillStyle = grad;
                ctx.fill();
            });
            
            // –ü—Ä–∏–∑—Ä–∞–∫–∏ —Ä—ã–≤–∫–∞
            dashGhosts.forEach(g => {
                ctx.beginPath();
                ctx.arc(g.x, g.y, player.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(0, 212, 255, ${g.alpha * 0.5})`;
                ctx.fill();
            });
            
            // –ë–æ–Ω—É—Å—ã
            powerups.forEach(p => {
                const icons = {
                    slow: 'üêå', shield: 'üõ°Ô∏è', shrink: 'üî¨', speed: '‚ö°',
                    invisible: 'üëª', freeze: '‚ùÑÔ∏è', magnet: 'üß≤', doublePoints: '‚ú®'
                };
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                if (!lowGraphics) {
                    ctx.shadowColor = '#fff';
                    ctx.shadowBlur = 20;
                }
                
                renderIcon(ctx, icons[p.type] || '?', p.x, p.y, 32);
                
                ctx.shadowBlur = 0;
            });
            
            // –ú–æ–Ω–µ—Ç—ã
            coins.forEach(c => {
                ctx.save();
                ctx.translate(c.x, c.y);
                c.rotation += 0.1;
                
                const scaleX = Math.cos(c.rotation);
                ctx.scale(scaleX, 1);
                
                ctx.beginPath();
                ctx.arc(0, 0, c.golden ? 18 : 12, 0, Math.PI * 2);
                ctx.fillStyle = c.golden ? '#ffd700' : '#f1c40f';
                ctx.fill();
                ctx.strokeStyle = c.golden ? '#ff8c00' : '#d4a017';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.restore();
            });
            
            // –ß–∞—Å—Ç–∏—Ü—ã
            particles.forEach(p => {
                if (p.type === 'shockwave') {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(255, 100, 0, ${p.alpha})`;
                    ctx.lineWidth = 5;
                    ctx.stroke();
                } else if (p.isNote) {
                    // –ù–æ—Ç—ã –æ—Ç –ø–µ–Ω–∏—è –±–æ—Å—Å–∞
                    ctx.save();
                    ctx.globalAlpha = p.alpha;
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = p.color;
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 10;
                    ctx.fillText(p.noteIcon, p.x, p.y);
                    ctx.restore();
                } else if (p.isLetter) {
                    // –ë—É–∫–≤—ã –æ—Ç –≤–∑—Ä—ã–≤–∞ CENSORED - –ö–†–£–ü–ù–´–ï –ò –Ø–†–ö–ò–ï
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(Date.now() * 0.008);
                    
                    // –Ø—Ä–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                    if (!lowGraphics) {
                        ctx.shadowColor = '#ff0000';
                        ctx.shadowBlur = 25;
                    }
                    
                    ctx.font = 'bold 28px Arial'; // –ö—Ä—É–ø–Ω–µ–µ!
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
                    ctx.strokeStyle = `rgba(255, 255, 255, ${p.alpha * 0.8})`;
                    ctx.lineWidth = 3;
                    ctx.strokeText(p.letter, 0, 0);
                    
                    // –ö—Ä–∞—Å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞
                    ctx.fillStyle = `rgba(255, 0, 0, ${p.alpha})`;
                    ctx.fillText(p.letter, 0, 0);
                    
                    ctx.restore();
                } else if (p.isFragment) {
                    // –û—Å–∫–æ–ª–∫–∏ –æ—Ç CENSORED (–æ–ø–∞—Å–Ω—ã–µ!) - –ö–†–£–ü–ù–´–ï –ò –Ø–†–ö–ò–ï
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(Date.now() * 0.008);
                    
                    // –°–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –∑–∞–º–µ—Ç–Ω–æ—Å—Ç–∏
                    if (p.glow && !lowGraphics) {
                        ctx.shadowColor = p.color;
                        ctx.shadowBlur = 20;
                    }
                    
                    // –ù–µ—Ä–æ–≤–Ω—ã–π –æ—Å–∫–æ–ª–æ–∫ - –∫—Ä—É–ø–Ω—ã–π –∏ —è—Ä–∫–∏–π
                    ctx.beginPath();
                    ctx.moveTo(-p.radius, -p.radius * 0.5);
                    ctx.lineTo(p.radius * 0.5, -p.radius);
                    ctx.lineTo(p.radius, p.radius * 0.5);
                    ctx.lineTo(-p.radius * 0.3, p.radius * 0.8);
                    ctx.closePath();
                    
                    // –Ø—Ä–∫–∏–π —Ü–≤–µ—Ç (–∫—Ä–∞—Å–Ω—ã–π –∏–ª–∏ –æ—Ä–∞–Ω–∂–µ–≤—ã–π)
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                    
                    // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
                    ctx.strokeStyle = `rgba(255, 255, 255, ${p.alpha * 0.8})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                    ctx.restore();
                } else {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color.replace(')', `, ${p.alpha})`).replace('rgb', 'rgba');
                    ctx.fill();
                }
            });
            
            // Mellstroy
            mellstroys.forEach(m => {
                ctx.save();
                ctx.translate(m.x, m.y);
                
                ctx.beginPath();
                ctx.arc(0, 0, m.radius, 0, Math.PI * 2);
                ctx.clip();
                
                if (mellstroyImg.complete) {
                    const size = m.radius * 2;
                    ctx.drawImage(mellstroyImg, -size/2, -size/2, size, size);
                } else {
                    ctx.fillStyle = '#ff6600';
                    ctx.fill();
                }
                
                ctx.restore();
                
                // –û–±–≤–æ–¥–∫–∞
                ctx.beginPath();
                ctx.arc(m.x, m.y, m.radius, 0, Math.PI * 2);
                ctx.strokeStyle = '#ff6600';
                ctx.lineWidth = 3;
                ctx.stroke();
            });
            
            // –¢–æ—Ö–∞ - —Ä–∏—Å—É–µ–º –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –ò–õ–ò –ø–∞–¥–∞–µ—Ç –ò–õ–ò –∏–¥—ë—Ç –∏–≤–µ–Ω—Ç –∂–∏—Ä–∞–≥–µ–¥–æ–Ω —Ñ–∞–∑–∞ 2-3
            if (toha.active || toha.falling || (eventSystem.active && eventSystem.type === 'zhiragedon' && eventSystem.phase >= 2)) {
                ctx.save();
                ctx.translate(toha.x, toha.y);
                ctx.rotate(toha.rotation);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                if (!lowGraphics) {
                    const glowColor = toha.attackType === 'blackhole' ? '#9b59b6' : '#ff6600';
                    ctx.shadowColor = glowColor;
                    ctx.shadowBlur = 30;
                }
                
                ctx.beginPath();
                ctx.arc(0, 0, toha.radius, 0, Math.PI * 2);
                ctx.clip();
                
                if (tohaImg.complete) {
                    const size = toha.radius * 2;
                    ctx.drawImage(tohaImg, -size/2, -size/2, size, size);
                } else {
                    ctx.fillStyle = '#ff6600';
                    ctx.fill();
                }
                
                ctx.restore();
                
                // –û–±–≤–æ–¥–∫–∞
                ctx.beginPath();
                ctx.arc(toha.x, toha.y, toha.radius, 0, Math.PI * 2);
                ctx.strokeStyle = toha.attackType === 'charge' && toha.chargeTimer > 0 ? '#ff0000' : '#ff6600';
                ctx.lineWidth = 5;
                ctx.stroke();
            }
            
            // –ü–∞–¥–∞—é—â–∏–µ –∫–∞–º–Ω–∏
            fallingRocks.forEach(rock => {
                ctx.save();
                ctx.translate(rock.x, rock.y);
                ctx.rotate(rock.rotation);
                
                ctx.beginPath();
                ctx.moveTo(-rock.radius * 0.8, -rock.radius * 0.5);
                ctx.lineTo(rock.radius * 0.5, -rock.radius * 0.8);
                ctx.lineTo(rock.radius * 0.9, rock.radius * 0.3);
                ctx.lineTo(0, rock.radius * 0.9);
                ctx.lineTo(-rock.radius * 0.7, rock.radius * 0.4);
                ctx.closePath();
                
                ctx.fillStyle = rock.color;
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.restore();
            });
            
            // –ë–∏–≥ –º–∞–∫ (–ª–µ—Ç—è—â–∏–π –∏–ª–∏ –ª–µ–∂–∞—â–∏–π)
            if (bigMac) {
                ctx.save();
                ctx.translate(bigMac.x, bigMac.y);
                
                // –ï—Å–ª–∏ –ª–µ–∂–∏—Ç - –ø—É–ª—å—Å–∏—Ä—É–µ—Ç –∏ –Ω–µ –≤—Ä–∞—â–∞–µ—Ç—Å—è
                if (bigMac.landed && !bigMac.tohaSpawned) {
                    const pulseScale = 1 + Math.sin(bigMac.pulse || 0) * 0.15;
                    ctx.scale(pulseScale, pulseScale);
                } else {
                    ctx.rotate(bigMac.rotation);
                    // –ú–∞—Å—à—Ç–∞–± –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
                    const scale = bigMac.scale || 1;
                    ctx.scale(scale, scale);
                }
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = '#ff6600';
                ctx.shadowBlur = 30;
                
                // –§–æ–Ω-–∫—Ä—É–≥ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
                ctx.beginPath();
                ctx.arc(0, 0, 35, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 100, 0, 0.3)';
                ctx.fill();
                
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üçî', 0, 0);
                
                // –°–ª–µ–¥ –∑–∞ –±–∏–≥ –º–∞–∫–æ–º
                ctx.restore();
                
                // –ß–∞—Å—Ç–∏—Ü—ã —Å–ª–µ–¥–∞
                if (Math.random() < 0.5) {
                    particles.push({
                        x: bigMac.x - bigMac.vx * 2,
                        y: bigMac.y - bigMac.vy * 2,
                        vx: (Math.random() - 0.5) * 3,
                        vy: (Math.random() - 0.5) * 3,
                        radius: Math.random() * 8 + 4,
                        color: '#ff6600',
                        alpha: 0.8,
                        life: 0.5
                    });
                }
            }
            
            // –ó–¥–æ—Ä–æ–≤–∞—è –µ–¥–∞ –Ω–∞ –∑–µ–º–ª–µ
            healthyFood.forEach(food => {
                ctx.save();
                ctx.translate(food.x, food.y);
                
                // –ü—É–ª—å—Å–∞—Ü–∏—è
                const pulse = 1 + Math.sin(food.pulse) * 0.1;
                ctx.scale(pulse, pulse);
                ctx.rotate(food.rotation);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                if (!lowGraphics) {
                    ctx.shadowColor = '#00ff00';
                    ctx.shadowBlur = 15;
                }
                
                renderIcon(ctx, food.icon, 0, 0, 35);
                ctx.shadowBlur = 0;
                ctx.restore();
            });
            
            // –ë—Ä–æ—à–µ–Ω–Ω–∞—è –µ–¥–∞
            thrownFood.forEach(food => {
                ctx.save();
                ctx.translate(food.x, food.y);
                ctx.rotate(food.rotation);
                
                if (!lowGraphics) {
                    ctx.shadowColor = '#00ff00';
                    ctx.shadowBlur = 20;
                }
                
                renderIcon(ctx, food.icon, 0, 0, 30);
                ctx.shadowBlur = 0;
                ctx.restore();
            });
            
            // –ö—Ä—ã–ª—ã—à–∫–∏ KFC
            kfcWings.forEach(wing => {
                ctx.save();
                ctx.translate(wing.x, wing.y);
                ctx.rotate(wing.rotation);
                
                if (!lowGraphics) {
                    ctx.shadowColor = '#ff6600';
                    ctx.shadowBlur = 15;
                }
                
                renderIcon(ctx, 'üçó', 0, 0, 28);
                ctx.shadowBlur = 0;
                ctx.restore();
            });
            
            // –ö–∞–∫–∞—à–∫–∏ –Ω–∞ –∑–µ–º–ª–µ (–¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Å—Å–∞)
            poops.forEach(poop => {
                ctx.save();
                ctx.translate(poop.x, poop.y);
                
                // –ü—É–ª—å—Å–∞—Ü–∏—è
                const pulse = 1 + Math.sin(poop.pulse) * 0.15;
                ctx.scale(pulse, pulse);
                ctx.rotate(poop.rotation);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                if (!lowGraphics) {
                    ctx.shadowColor = '#8B4513';
                    ctx.shadowBlur = 20;
                }
                
                renderIcon(ctx, 'üí©', 0, 0, 40);
                ctx.shadowBlur = 0;
                ctx.restore();
            });
            
            // –ë—Ä–æ—à–µ–Ω–Ω—ã–µ –∫–∞–∫–∞—à–∫–∏
            thrownPoops.forEach(poop => {
                ctx.save();
                ctx.translate(poop.x, poop.y);
                ctx.rotate(poop.rotation);
                
                if (!lowGraphics) {
                    ctx.shadowColor = '#8B4513';
                    ctx.shadowBlur = 25;
                }
                
                renderIcon(ctx, 'üí©', 0, 0, 35);
                ctx.shadowBlur = 0;
                ctx.restore();
            });
            
            // –í—Ä–∞–≥ - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω (–∏–Ω–∞—á–µ –¥–≤–æ–∏—Ç—Å—è)
            const showEnemy = !eventSystem.active || 
                             (eventSystem.type === 'mellstroy') || 
                             (eventSystem.type === 'zhiragedon' && eventSystem.phase <= 1);
            // –ü—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –±–æ—Å—Å–µ –≤—Ä–∞–≥ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è - –≤–º–µ—Å—Ç–æ –Ω–µ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è finalBoss
            
            if (showEnemy) {
                ctx.save();
                ctx.translate(enemy.x, enemy.y);
                
                // –í—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–∏ —É–ª—ë—Ç–µ
                if (enemy.flyRotation) {
                    ctx.rotate(enemy.flyRotation);
                }
                // –ò–Ω–∞—á–µ –ø–æ–≤–æ—Ä–æ—Ç –≥–æ–ª–æ–≤–æ–π –∫ –∏–≥—Ä–æ–∫—É (–µ—Å–ª–∏ –Ω–µ –∏–≤–µ–Ω—Ç)
                else if (!eventSystem.active && !enemy.useEmote) {
                    // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –∫ –∏–≥—Ä–æ–∫—É
                    const angleToPlayer = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                    // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã "–≤–µ—Ä—Ö" –≥–æ–ª–æ–≤—ã —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ –∏–≥—Ä–æ–∫–∞
                    // –î–æ–±–∞–≤–ª—è–µ–º PI/2 —á—Ç–æ–±—ã –≤–µ—Ä—Ö –∫—Ä—É–≥–∞ (–≥–¥–µ –æ–±—ã—á–Ω–æ –ª–∏—Ü–æ) —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ –∏–≥—Ä–æ–∫–∞
                    ctx.rotate(angleToPlayer + Math.PI / 2);
                }
                // –í–æ –≤—Ä–µ–º—è –∏–≤–µ–Ω—Ç–∞ —Å–º–æ—Ç—Ä–∏—Ç —Ä–æ–≤–Ω–æ (–≥–æ–ª–æ–≤–∞ –≤–≤–µ—Ä—Ö)
                // –ù–µ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º - –æ—Å—Ç–∞–≤–ª—è–µ–º rotation = 0
                
                // –ë–∏–≥ –º–∞–∫ –≤ —Ä—É–∫–∞—Ö –≤–æ –≤—Ä–µ–º—è —Ñ–∞–∑—ã 0 –∂–∏—Ä–∞–≥–µ–¥–æ–Ω–∞
                if (enemy.holdingBigMac) {
                    ctx.save();
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç –¥–ª—è –±–∏–≥ –º–∞–∫–∞
                    ctx.rotate(-(enemy.flyRotation || 0));
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–¥–Ω—è—Ç–∏—è –±–∏–≥ –º–∞–∫–∞
                    const bobY = Math.sin(Date.now() * 0.005) * 5;
                    if (!lowGraphics) {
                        ctx.shadowColor = '#ff6600';
                        ctx.shadowBlur = 20;
                    }
                    renderIcon(ctx, 'üçî', 50, -25 + bobY, 45);
                    ctx.shadowBlur = 0;
                    ctx.restore();
                }
                
                const radius = enemy.radius * (player.effects.shrink ? 0.6 : 1);
                
                // –í–Ω–µ—à–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                if (!lowGraphics) {
                    const glowColor = player.effects.slow ? '#3498db' : 
                                      enemy.confused ? '#9b59b6' : 
                                      enemy.aiMode === 'rush' ? '#ff0000' : '#ff0066';
                    ctx.shadowColor = glowColor;
                    ctx.shadowBlur = 30;
                    
                    // –ü—É–ª—å—Å–∏—Ä—É—é—â–µ–µ –∫–æ–ª—å—Ü–æ
                    const pulseRadius = radius + 8 + Math.sin(Date.now() * 0.005) * 4;
                    ctx.beginPath();
                    ctx.arc(0, 0, pulseRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = `${glowColor}66`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
                
                // –ê–≤–∞—Ç–∞—Ä–∫–∞
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, Math.PI * 2);
                ctx.clip();
                
                // –í—ã–±–æ—Ä —Å–∫–∏–Ω–∞: GIF –∏–ª–∏ –æ–±—ã—á–Ω—ã–π
                let img;
                let useHtmlGif = false;
                if (enemy.useEmote) {
                    img = zoloEmoteImg;
                } else if (useGifSkin) {
                    // –î–ª—è GIF –∏—Å–ø–æ–ª—å–∑—É–µ–º HTML —ç–ª–µ–º–µ–Ω—Ç (canvas –Ω–µ –∞–Ω–∏–º–∏—Ä—É–µ—Ç GIF)
                    useHtmlGif = true;
                } else {
                    img = zoloImg;
                }
                
                if (useHtmlGif) {
                    // –†–∏—Å—É–µ–º –∑–∞–≥–ª—É—à–∫—É –Ω–∞ canvas, —Ä–µ–∞–ª—å–Ω—ã–π GIF –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ HTML
                    ctx.fillStyle = '#ff0066';
                    ctx.fill();
                } else if (img && img.complete) {
                    const size = radius * 2;
                    ctx.drawImage(img, -size/2, -size/2, size, size);
                } else {
                    ctx.fillStyle = '#ff0066';
                    ctx.fill();
                }
                
                ctx.restore();
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º HTML GIF —ç–ª–µ–º–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö canvas
                if (zoloGifElement) {
                    if (useGifSkin && !enemy.useEmote && gameState === 'playing' && showEnemy) {
                        zoloGifElement.style.display = 'block';
                        // –£—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                        const screenX = (enemy.x - camera.x) * camera.zoom + canvas.width/2 * (1 - camera.zoom);
                        const screenY = (enemy.y - camera.y) * camera.zoom + canvas.height/2 * (1 - camera.zoom);
                        const size = radius * 2 * camera.zoom;
                        zoloGifElement.style.width = size + 'px';
                        zoloGifElement.style.height = size + 'px';
                        zoloGifElement.style.left = (screenX - size/2) + 'px';
                        zoloGifElement.style.top = (screenY - size/2) + 'px';
                        // –í—Ä–∞—â–µ–Ω–∏–µ
                        const angleToPlayer = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                        const rotation = (angleToPlayer + Math.PI / 2) * 180 / Math.PI;
                        zoloGifElement.style.transform = `rotate(${rotation}deg)`;
                    } else {
                        zoloGifElement.style.display = 'none';
                    }
                }
                
                // –û–±–≤–æ–¥–∫–∞
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, radius, 0, Math.PI * 2);
                ctx.strokeStyle = player.effects.slow ? '#3498db' : '#ff0066';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                if (player.effects.freeze) {
                    // –õ–µ–¥—è–Ω—ã–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã
                    for (let i = 0; i < 8; i++) {
                        const angle = (i / 8) * Math.PI * 2;
                        const r = radius + 15;
                        ctx.beginPath();
                        ctx.moveTo(enemy.x + Math.cos(angle) * (radius + 5), enemy.y + Math.sin(angle) * (radius + 5));
                        ctx.lineTo(enemy.x + Math.cos(angle) * r, enemy.y + Math.sin(angle) * r);
                        ctx.strokeStyle = 'rgba(150, 200, 255, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                    }
                    
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, radius + 5, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(100, 150, 255, 0.6)';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ AI –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ low mode
                // –≠—Ç–∏ —ç–º–æ–¥–∑–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –≥–µ–π–º–ø–ª–µ—è, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫–ª—é—á–∞–µ–º –∏—Ö
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Å–ª–µ–¥–∞ –ø—Ä–∏ —Ä—ã–≤–∫–µ (–º–µ–Ω—å—à–µ –≤ low mode)
                if ((enemy.aiMode === 'rush' || enemy.aiMode === 'doubleRush') && !lowGraphics) {
                    for (let i = 0; i < (lowGraphics ? 1 : 4); i++) {
                        particles.push({
                            x: enemy.x + (Math.random() - 0.5) * 25,
                            y: enemy.y + (Math.random() - 0.5) * 25,
                            vx: (Math.random() - 0.5) * 4,
                            vy: (Math.random() - 0.5) * 4,
                            radius: Math.random() * 6 + 3,
                            color: '#ff0066',
                            alpha: 0.9,
                            life: 0.35
                        });
                    }
                }
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Å–ª–µ–¥–∞ –ø—Ä–∏ –æ–±–º–∞–Ω–∫–µ (bait) - –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ low mode
                if (enemy.aiMode === 'bait' && !lowGraphics) {
                    const baitColor = enemy.baitPhase === 0 ? '#ffff00' : '#ff0000';
                    for (let i = 0; i < 2; i++) {
                        particles.push({
                            x: enemy.x + (Math.random() - 0.5) * 20,
                            y: enemy.y + (Math.random() - 0.5) * 20,
                            vx: (Math.random() - 0.5) * 3,
                            vy: (Math.random() - 0.5) * 3,
                            radius: Math.random() * 4 + 2,
                            color: baitColor,
                            alpha: 0.8,
                            life: 0.3
                        });
                    }
                }
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Å–ª–µ–¥–∞ –ø—Ä–∏ —Å–∏–Ω—É—Å–æ–∏–¥–µ - –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ low mode
                if (enemy.aiMode === 'sinusoidal' && !lowGraphics) {
                    if (Math.random() < 0.3) {
                        particles.push({
                            x: enemy.x,
                            y: enemy.y,
                            vx: (Math.random() - 0.5) * 2,
                            vy: (Math.random() - 0.5) * 2,
                            radius: Math.random() * 3 + 1,
                            color: '#00ffff',
                            alpha: 0.6,
                            life: 0.4
                        });
                    }
                }
                
                // –≠—Ñ—Ñ–µ–∫—Ç –æ—Ä–±–∏—Ç—ã
                if (enemy.aiMode === 'orbit' && !lowGraphics) {
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, 150, enemy.orbitAngle - 0.5, enemy.orbitAngle + 0.5);
                    ctx.strokeStyle = 'rgba(255, 0, 102, 0.3)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            // –ò–≥—Ä–æ–∫
            ctx.save();
            ctx.translate(player.x, player.y);
            
            // –í–Ω–µ—à–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ
            if (!lowGraphics) {
                const glowColor = player.effects.invisible ? 'rgba(155, 89, 182, 0.5)' : 
                                  player.effects.speed ? '#f39c12' : '#00d4ff';
                ctx.shadowColor = glowColor;
                ctx.shadowBlur = 25;
                
                // –í–Ω–µ—à–Ω–µ–µ –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–µ –∫–æ–ª—å—Ü–æ
                const outerRadius = player.radius + 5 + Math.sin(Date.now() * 0.008) * 3;
                ctx.beginPath();
                ctx.arc(0, 0, outerRadius, 0, Math.PI * 2);
                ctx.strokeStyle = `${glowColor}44`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            // –û—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ–ª–æ –∏–≥—Ä–æ–∫–∞
            ctx.beginPath();
            ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
            
            // –ö—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
            const playerGrad = ctx.createRadialGradient(-5, -5, 0, 0, 0, player.radius);
            if (player.effects.invisible) {
                playerGrad.addColorStop(0, 'rgba(180, 120, 220, 0.6)');
                playerGrad.addColorStop(0.5, 'rgba(155, 89, 182, 0.4)');
                playerGrad.addColorStop(1, 'rgba(130, 60, 160, 0.3)');
            } else if (player.effects.speed) {
                playerGrad.addColorStop(0, '#ffff00');
                playerGrad.addColorStop(0.5, '#f39c12');
                playerGrad.addColorStop(1, '#e67e22');
            } else {
                playerGrad.addColorStop(0, '#66ffff');
                playerGrad.addColorStop(0.3, '#00d4ff');
                playerGrad.addColorStop(0.7, '#0088ff');
                playerGrad.addColorStop(1, '#0044aa');
            }
            ctx.fillStyle = playerGrad;
            ctx.fill();
            
            // –ë–ª–∏–∫
            ctx.beginPath();
            ctx.arc(-5, -5, player.radius * 0.4, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.fill();
            
            // –û–±–≤–æ–¥–∫–∞
            ctx.beginPath();
            ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
            ctx.strokeStyle = player.effects.invisible ? 'rgba(155, 89, 182, 0.5)' : '#00aaff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // –©–∏—Ç - –î—Ö–∞—Ä–º–∞—á–∞–∫—Ä–∞ (–∫–æ–ª–µ—Å–æ –∑–∞–∫–æ–Ω–∞) —Å —Ç–æ—á–∫–∞–º–∏
            if (player.shield > 0) {
                const wheelRotation = Date.now() * 0.0008; // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–ª–µ—Å–∞
                const wheelRadius = player.radius + 18;
                
                ctx.save();
                ctx.rotate(wheelRotation);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = '#ffd700';
                ctx.shadowBlur = lowGraphics ? 5 : 20;
                
                // –í–Ω–µ—à–Ω–µ–µ –∫–æ–ª—å—Ü–æ –∫–æ–ª–µ—Å–∞
                ctx.beginPath();
                ctx.arc(0, 0, wheelRadius, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 215, 0, 0.9)';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∫–æ–ª—å—Ü–æ (—Å—Ç—É–ø–∏—Ü–∞)
                ctx.beginPath();
                ctx.arc(0, 0, player.radius + 6, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 180, 0, 0.6)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // –¶–µ–Ω—Ç—Ä –∫–æ–ª–µ—Å–∞
                ctx.beginPath();
                ctx.arc(0, 0, 4, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                ctx.fill();
                
                // 8 —Å–ø–∏—Ü –∫–æ–ª–µ—Å–∞ (–∫–∞–∫ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–π –¥—Ö–∞—Ä–º–∞—á–∞–∫—Ä–µ)
                const spokeCount = 8;
                for (let i = 0; i < spokeCount; i++) {
                    const angle = (i / spokeCount) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.moveTo(Math.cos(angle) * (player.radius + 6), Math.sin(angle) * (player.radius + 6));
                    ctx.lineTo(Math.cos(angle) * wheelRadius, Math.sin(angle) * wheelRadius);
                    ctx.strokeStyle = 'rgba(255, 200, 50, 0.7)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                ctx.restore();
                
                // –¢–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ –∫–æ–ª–µ—Å–∞ - 2 —Ç–æ—á–∫–∏ –Ω–∞ 1 —â–∏—Ç, 4 –Ω–∞ 2, 8 –Ω–∞ 3
                const dotRadius = wheelRadius + 15;
                const dotRotation = Date.now() * 0.002; // –ë—ã—Å—Ç—Ä–µ–µ –≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ–º –∫–æ–ª–µ—Å–æ
                const dotCount = player.shield === 1 ? 2 : (player.shield === 2 ? 4 : 8);
                const dotSize = player.shield === 3 ? 5 : 6;
                
                for (let i = 0; i < dotCount; i++) {
                    const angle = dotRotation + (i / dotCount) * Math.PI * 2;
                    const x = Math.cos(angle) * dotRadius;
                    const y = Math.sin(angle) * dotRadius;
                    
                    // –û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞
                    ctx.beginPath();
                    ctx.arc(x, y, dotSize, 0, Math.PI * 2);
                    
                    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ç–æ—á–∫–∏
                    const dotGrad = ctx.createRadialGradient(x, y, 0, x, y, dotSize);
                    dotGrad.addColorStop(0, '#ffffff');
                    dotGrad.addColorStop(0.5, '#ffd700');
                    dotGrad.addColorStop(1, '#ff8c00');
                    ctx.fillStyle = dotGrad;
                    ctx.shadowColor = '#ffd700';
                    ctx.shadowBlur = lowGraphics ? 5 : 15;
                    ctx.fill();
                    
                    // –°–ª–µ–¥ –∑–∞ —Ç–æ—á–∫–æ–π (—Ö–≤–æ—Å—Ç)
                    if (!lowGraphics) {
                        const tailLength = 3;
                        for (let t = 1; t <= tailLength; t++) {
                            const tailAngle = angle - (t * 0.15);
                            const tailX = Math.cos(tailAngle) * dotRadius;
                            const tailY = Math.sin(tailAngle) * dotRadius;
                            const tailSize = dotSize * (1 - t * 0.25);
                            const tailAlpha = 0.6 - t * 0.15;
                            
                            ctx.beginPath();
                            ctx.arc(tailX, tailY, tailSize, 0, Math.PI * 2);
                            ctx.fillStyle = `rgba(255, 215, 0, ${tailAlpha})`;
                            ctx.fill();
                        }
                    }
                }
                
                // –ò—Å–∫—Ä—ã –æ—Ç —Ç–æ—á–µ–∫ - —Ä–µ–∂–µ –≤ low mode
                if (Math.random() < (lowGraphics ? 0.02 : 0.1)) {
                    const sparkIdx = Math.floor(Math.random() * dotCount);
                    const sparkAngle = dotRotation + (sparkIdx / dotCount) * Math.PI * 2;
                    particles.push({
                        x: player.x + Math.cos(sparkAngle) * dotRadius,
                        y: player.y + Math.sin(sparkAngle) * dotRadius,
                        vx: Math.cos(sparkAngle + Math.PI/2) * 3,
                        vy: Math.sin(sparkAngle + Math.PI/2) * 3,
                        radius: 2 + Math.random() * 2,
                        color: '#ffd700',
                        alpha: 1,
                        life: 0.4
                    });
                }
                
                ctx.shadowBlur = 0;
            }
            
            // –ï–¥–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–µ—Å—ë—Ç –∏–≥—Ä–æ–∫
            if (playerFood) {
                if (!lowGraphics) {
                    ctx.shadowColor = '#00ff00';
                    ctx.shadowBlur = 15;
                }
                renderIcon(ctx, playerFood.icon, 0, -player.radius - 25, 25);
                ctx.shadowBlur = 0;
            }
            
            // –ö–∞–∫–∞—à–∫–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–µ—Å—ë—Ç –∏–≥—Ä–æ–∫
            if (playerPoop) {
                if (!lowGraphics) {
                    ctx.shadowColor = '#8B4513';
                    ctx.shadowBlur = 20;
                }
                renderIcon(ctx, 'üí©', 0, -player.radius - 30, 30);
                ctx.shadowBlur = 0;
            }
            
            ctx.restore();
            
            // –≠—Ñ—Ñ–µ–∫—Ç—ã –∫–∞—Ç—Å—Ü–µ–Ω—ã
            if (cutscene.active) {
                renderCutsceneEffects();
            }
            
            // –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å
            if (finalBoss.active && eventSystem.type === 'finalBoss') {
                // –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—Ç–∞–¥–∏–∏ 2 (–æ–≥–æ–Ω—å, –∫—Ä—ã–ª—å—è)
                if (finalBoss.stage2Cutscene || finalBoss.hasWings) {
                    renderStage2Effects();
                }
                renderFinalBoss();
                
                // –†—É–∫–∏ —Å CENSORED —Ç–∞–±–ª–∏—á–∫–∞–º–∏
                if (finalBoss.handsVisible) {
                    renderBossHands();
                }
                
                // CENSORED —Ä–∞–∫–µ—Ç—ã
                if (finalBoss.censoredMissiles) {
                    renderCensoredMissiles();
                }
                
                // –ë–∞—Ç–∏ –∏ –ª–∞–∑–µ—Ä—ã
                renderBatyas();
                renderBatyaLasers();
                
                // –î–∏–Ω–∞–º–∏–∫–∏ –∏ –Ω–æ—Ç—ã
                renderSpeakers();
                renderMusicNotes();
                
                // –û–≥–Ω–µ–Ω–Ω—ã–µ –∫—Ä—É–≥–∏ (—Å—Ç–∞–¥–∏—è 2)
                if (fireCircleAttack.active || fireCircles.length > 0) {
                    renderFireCircles();
                }
                if (fireShards.length > 0) {
                    renderFireShards();
                }
                
                // –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤ —Ä—É–∫–∞—Ö –±–æ—Å—Å–∞
                if (finalBoss.hasMicrophone) {
                    renderMicrophone();
                }
                
                // –§–∞–µ—Ä–±–æ–ª –≤ —Ä—É–∫–µ –ø—Ä–∏ –∞—Ç–∞–∫–µ –æ–≥–Ω–µ–Ω–Ω—ã—Ö —Å—Ñ–µ—Ä
                if (finalBoss.hasFireball) {
                    renderFireball();
                }
                
                // –ú–∞—à–∏–Ω–∞
                if (carAttack.active) {
                    renderCarAttack();
                }
                
                // –õ–∞–±–∏—Ä–∏–Ω—Ç
                if (labyrinthAttack.active) {
                    renderLabyrinth();
                }
                
                // –û–≥–Ω–µ–Ω–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
                if (firePlatformAttack.active) {
                    renderFirePlatform();
                    renderFireSnakes();
                }
                
                // (–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–∞—É–∑—ã —É–¥–∞–ª—ë–Ω - –∫–∞–∫–∞—à–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –æ—Ç –±–∞—Ç–∏)
                
                // –≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞ –∫—É–ª–∞–∫–æ–º
                if (finalBoss.punchEffect > 0) {
                    finalBoss.punchEffect -= 0.05;
                    
                    // –ö—É–ª–∞–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ä—è–¥–æ–º —Å –±–æ—Å—Å–æ–º
                    ctx.save();
                    ctx.translate(finalBoss.x + 70, finalBoss.y);
                    ctx.scale(1 + finalBoss.punchEffect * 0.5, 1 + finalBoss.punchEffect * 0.5);
                    ctx.font = '60px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('üëä', 0, 0);
                    ctx.restore();
                }
            }
            
            ctx.restore();
            
            // –ë–µ–ª–∞—è –≤—Å–ø—ã—à–∫–∞ (—Ä–∏—Å—É–µ–º –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ)
            if (finalBoss.flashWhite > 0) {
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.fillStyle = `rgba(255, 255, 255, ${finalBoss.flashWhite})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
            }
            
            // –ì—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç—ã (–≤–Ω–µ –∫–∞–º–µ—Ä—ã)
            ctx.strokeStyle = '#ff0066';
            ctx.lineWidth = 4;
            ctx.shadowColor = '#ff0066';
            ctx.shadowBlur = lowGraphics ? 0 : 20;
            ctx.strokeRect(MAP_BOUNDS.minX, MAP_BOUNDS.minY, 
                MAP_BOUNDS.maxX() - MAP_BOUNDS.minX, 
                MAP_BOUNDS.maxY() - MAP_BOUNDS.minY);
            ctx.shadowBlur = 0;
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä—É–∫ –±–æ—Å—Å–∞ —Å —Ç–∞–±–ª–∏—á–∫–∞–º–∏ CENSORED
        function renderBossHands() {
            const scale = finalBoss.handsScale || 0;
            if (scale <= 0) return;
            
            ctx.save();
            ctx.translate(finalBoss.x, finalBoss.y);
            
            // –õ–µ–≤–∞—è —Ä—É–∫–∞
            ctx.save();
            ctx.translate(-80 * scale, -20);
            ctx.scale(scale, scale);
            ctx.rotate(-0.2 + Math.sin(Date.now() * 0.003) * 0.1);
            
            // –†—É–∫–∞
            if (!lowGraphics) {
                ctx.shadowColor = '#0066ff';
                ctx.shadowBlur = 20;
            }
            renderIcon(ctx, 'ü§ö', 0, 0, 60);
            ctx.shadowBlur = 0;
            
            // –¢–∞–±–ª–∏—á–∫–∞ CENSORED
            ctx.fillStyle = '#000000';
            ctx.fillRect(-55, -50, 110, 35);
            ctx.fillStyle = '#ff0000';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('CENSORED', 0, -33);
            
            ctx.restore();
            
            // –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞
            ctx.save();
            ctx.translate(80 * scale, -20);
            ctx.scale(scale, scale);
            ctx.rotate(0.2 - Math.sin(Date.now() * 0.003) * 0.1);
            
            // –†—É–∫–∞
            if (!lowGraphics) {
                ctx.shadowColor = '#0066ff';
                ctx.shadowBlur = 20;
            }
            renderIcon(ctx, '‚úã', 0, 0, 60);
            ctx.shadowBlur = 0;
            
            // –¢–∞–±–ª–∏—á–∫–∞ CENSORED
            ctx.fillStyle = '#000000';
            ctx.fillRect(-55, -50, 110, 35);
            ctx.fillStyle = '#ff0000';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('CENSORED', 0, -33);
            
            ctx.restore();
            
            ctx.restore();
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –±–∞—Ç–µ–π
        function renderBatyas() {
            batyas.forEach(batya => {
                ctx.save();
                ctx.translate(batya.x, batya.y);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = batya.phase === 0 ? '#00ff00' : '#ff0000';
                ctx.shadowBlur = 30;
                
                // –ê–≤–∞—Ç–∞—Ä–∫–∞ –±–∞—Ç–∏
                ctx.beginPath();
                ctx.arc(0, 0, batya.radius, 0, Math.PI * 2);
                ctx.clip();
                
                if (batyaImg.complete) {
                    const size = batya.radius * 2;
                    ctx.drawImage(batyaImg, -size/2, -size/2, size, size);
                } else {
                    ctx.fillStyle = '#888';
                    ctx.fill();
                }
                
                ctx.restore();
                
                // –û–±–≤–æ–¥–∫–∞
                ctx.beginPath();
                ctx.arc(batya.x, batya.y, batya.radius, 0, Math.PI * 2);
                ctx.strokeStyle = batya.phase === 0 ? '#00ff00' : '#ff0000';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                // –õ–∏–Ω–∏—è –ø—Ä–∏—Ü–µ–ª–∞
                if (batya.phase === 0) {
                    // –§–∞–∑–∞ —Å–ª–µ–∂–µ–Ω–∏—è - –ª–∏–Ω–∏—è –°–õ–ï–î–ò–¢ –∑–∞ –∏–≥—Ä–æ–∫–æ–º (–∑–µ–ª—ë–Ω–∞—è)
                    const aimLen = 250 + Math.sin(Date.now() * 0.01) * 50;
                    ctx.beginPath();
                    ctx.moveTo(batya.x, batya.y);
                    ctx.lineTo(
                        batya.x + Math.cos(batya.aimAngle) * aimLen,
                        batya.y + Math.sin(batya.aimAngle) * aimLen
                    );
                    ctx.strokeStyle = `rgba(0, 255, 0, ${0.4 + Math.sin(Date.now() * 0.02) * 0.3})`;
                    ctx.lineWidth = 3;
                    ctx.setLineDash([10, 10]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // –ú–∏–≥–∞—é—â–∏–π –ø—Ä–∏—Ü–µ–ª –Ω–∞ –∏–≥—Ä–æ–∫–µ (–∑–µ–ª—ë–Ω—ã–π - —Å–ª–µ–∂–µ–Ω–∏–µ)
                    if (Math.sin(Date.now() * 0.02) > 0) {
                        ctx.beginPath();
                        ctx.arc(player.x, player.y, 40, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                } else if (batya.phase === 1) {
                    // –§–∞–∑–∞ –∑–∞–º–∏—Ä–∞–Ω–∏—è - –ª–∏–Ω–∏—è –ó–ê–§–ò–ö–°–ò–†–û–í–ê–ù–ê (–∫—Ä–∞—Å–Ω–∞—è, –º–∏–≥–∞–µ—Ç - –û–ü–ê–°–ù–û–°–¢–¨!)
                    // –≠—Ç–æ –æ–∫–Ω–æ –¥–ª—è —É–∫–ª–æ–Ω–µ–Ω–∏—è!
                    const aimLen = 400; // –î–ª–∏–Ω–Ω–µ–µ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const flashSpeed = Math.sin(Date.now() * 0.03);
                    
                    ctx.beginPath();
                    ctx.moveTo(batya.x, batya.y);
                    ctx.lineTo(
                        batya.x + Math.cos(batya.lockedAngle) * aimLen,
                        batya.y + Math.sin(batya.lockedAngle) * aimLen
                    );
                    // –ö—Ä–∞—Å–Ω—ã–π –º–∏–≥–∞—é—â–∏–π - —Å–∏–≥–Ω–∞–ª —á—Ç–æ —Å–∫–æ—Ä–æ –≤—ã—Å—Ç—Ä–µ–ª!
                    ctx.strokeStyle = `rgba(255, ${50 + flashSpeed * 50}, 0, ${0.6 + flashSpeed * 0.4})`;
                    ctx.lineWidth = 5;
                    ctx.setLineDash([15, 5]); // –ë–æ–ª–µ–µ —á–∞—Å—Ç—ã–π –ø—É–Ω–∫—Ç–∏—Ä
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–π —Ç–µ–∫—Å—Ç
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = `rgba(255, 100, 0, ${0.7 + flashSpeed * 0.3})`;
                    ctx.fillText('‚ö†Ô∏è –£–ö–õ–û–ù–ò–°–¨!', batya.x, batya.y - batya.radius - 20);
                    
                    // –ú–∏–≥–∞—é—â–∏–π –ø—Ä–∏—Ü–µ–ª –≤ —Ç–æ—á–∫–µ –ø–æ–ø–∞–¥–∞–Ω–∏—è (–∫—Ä–∞—Å–Ω—ã–π)
                    const targetX = batya.x + Math.cos(batya.lockedAngle) * 150;
                    const targetY = batya.y + Math.sin(batya.lockedAngle) * 150;
                    
                    ctx.beginPath();
                    ctx.arc(targetX, targetY, 30 + flashSpeed * 10, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(255, 0, 0, ${0.8})`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // –ü–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ
                    ctx.beginPath();
                    ctx.moveTo(targetX - 25, targetY);
                    ctx.lineTo(targetX + 25, targetY);
                    ctx.moveTo(targetX, targetY - 25);
                    ctx.lineTo(targetX, targetY + 25);
                    ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–∞–∑–µ—Ä–æ–≤ –±–∞—Ç–∏
        function renderBatyaLasers() {
            batyaLasers.forEach(laser => {
                if (laser.length <= 0) return;
                
                const alpha = laser.timer > laser.duration ? Math.max(0, 1 - (laser.timer - laser.duration) / 0.3) : 1;
                
                ctx.save();
                ctx.translate(laser.startX, laser.startY);
                ctx.rotate(laser.angle);
                
                // –í–Ω–µ—à–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ –ª–∞–∑–µ—Ä–∞
                const laserGrad = ctx.createLinearGradient(0, 0, laser.length, 0);
                laserGrad.addColorStop(0, `rgba(0, 255, 0, ${alpha})`);
                laserGrad.addColorStop(0.5, `rgba(100, 255, 100, ${alpha})`);
                laserGrad.addColorStop(1, `rgba(0, 200, 0, ${alpha * 0.5})`);
                
                // –®–∏—Ä–æ–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 40;
                
                // –û—Å–Ω–æ–≤–Ω–æ–π –ª—É—á
                ctx.beginPath();
                ctx.moveTo(0, -laser.width / 2);
                ctx.lineTo(laser.length, -laser.width / 2 * 0.3);
                ctx.lineTo(laser.length, laser.width / 2 * 0.3);
                ctx.lineTo(0, laser.width / 2);
                ctx.closePath();
                ctx.fillStyle = laserGrad;
                ctx.fill();
                
                // –Ø—Ä–∫–∏–π —Ü–µ–Ω—Ç—Ä
                ctx.beginPath();
                ctx.moveTo(0, -laser.width / 4);
                ctx.lineTo(laser.length, -laser.width / 4 * 0.2);
                ctx.lineTo(laser.length, laser.width / 4 * 0.2);
                ctx.lineTo(0, laser.width / 4);
                ctx.closePath();
                ctx.fillStyle = `rgba(200, 255, 200, ${alpha})`;
                ctx.fill();
                
                // –ü—É–∑—ã—Ä—å–∫–∏ –≤ –ª–∞–∑–µ—Ä–µ (–¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ä—ã–≥–∞–Ω–∏—è)
                for (let i = 0; i < 10; i++) {
                    const bubbleX = Math.random() * laser.length;
                    const bubbleY = (Math.random() - 0.5) * laser.width * 0.6;
                    const bubbleSize = 3 + Math.random() * 5;
                    
                    ctx.beginPath();
                    ctx.arc(bubbleX, bubbleY, bubbleSize, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(150, 255, 150, ${alpha * 0.7})`;
                    ctx.fill();
                }
                
                ctx.restore();
            });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ CENSORED —Ä–∞–∫–µ—Ç
        function renderCensoredMissiles() {
            if (!finalBoss.censoredMissiles) return;
            
            finalBoss.censoredMissiles.forEach(missile => {
                // –°–ª–µ–¥
                missile.trail.forEach(t => {
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, 5, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 100, 0, ${t.alpha * 0.5})`;
                    ctx.fill();
                });
                
                ctx.save();
                ctx.translate(missile.x, missile.y);
                ctx.rotate(missile.rotation);
                
                // –ß–µ—Ä–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ CENSORED
                ctx.fillStyle = '#000000';
                ctx.shadowColor = missile.homingTimer > 0 ? '#ff0000' : '#666666';
                ctx.shadowBlur = missile.homingTimer > 0 ? 20 : 5;
                ctx.fillRect(-missile.width/2, -missile.height/2, missile.width, missile.height);
                
                // –ö—Ä–∞—Å–Ω–∞—è –Ω–∞–¥–ø–∏—Å—å CENSORED
                ctx.fillStyle = '#ff0000';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('CENSORED', 0, 0);
                
                // –û–≥–Ω–µ–Ω–Ω—ã–π —Ö–≤–æ—Å—Ç
                if (missile.homingTimer > 0) {
                    ctx.beginPath();
                    ctx.moveTo(-missile.width/2 - 5, 0);
                    ctx.lineTo(-missile.width/2 - 25, -15);
                    ctx.lineTo(-missile.width/2 - 20, 0);
                    ctx.lineTo(-missile.width/2 - 25, 15);
                    ctx.closePath();
                    ctx.fillStyle = '#ff6600';
                    ctx.fill();
                    
                    // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ–≥–æ–Ω—å
                    ctx.beginPath();
                    ctx.moveTo(-missile.width/2 - 5, 0);
                    ctx.lineTo(-missile.width/2 - 15, -8);
                    ctx.lineTo(-missile.width/2 - 12, 0);
                    ctx.lineTo(-missile.width/2 - 15, 8);
                    ctx.closePath();
                    ctx.fillStyle = '#ffff00';
                    ctx.fill();
                }
                
                ctx.restore();
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–≤–µ–¥–µ–Ω–∏—è (–º–∏–≥–∞—é—â–∏–π)
                if (missile.homingTimer > 0 && Math.sin(Date.now() * 0.02) > 0) {
                    ctx.beginPath();
                    ctx.arc(missile.x, missile.y, 50, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∏–Ω–∞–º–∏–∫–æ–≤
        function renderSpeakers() {
            speakers.forEach(sp => {
                if (lowGraphics) {
                    // LOW MODE: –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ - –ø—Ä–æ—Å—Ç–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(sp.x - sp.width/2, sp.y - sp.height/2, sp.width, sp.height);
                    ctx.strokeStyle = '#ff00ff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(sp.x - sp.width/2, sp.y - sp.height/2, sp.width, sp.height);
                    
                    // –û–¥–∏–Ω –∫—Ä—É–≥ –≤ —Ü–µ–Ω—Ç—Ä–µ
                    ctx.beginPath();
                    ctx.arc(sp.x, sp.y, 20, 0, Math.PI * 2);
                    ctx.fillStyle = '#ff00ff';
                    ctx.fill();
                } else {
                    // –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                    ctx.save();
                    ctx.translate(sp.x, sp.y);
                    
                    const scale = 1 + (sp.pulse || 0);
                    ctx.scale(scale, scale);
                    
                    ctx.shadowColor = '#ff00ff';
                    ctx.shadowBlur = 20 + Math.abs(sp.pulse || 0) * 50;
                    
                    // –ö–æ—Ä–ø—É—Å –¥–∏–Ω–∞–º–∏–∫–∞
                    ctx.fillStyle = '#1a1a1a';
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.roundRect(-sp.width/2, -sp.height/2, sp.width, sp.height, 8);
                    ctx.fill();
                    ctx.stroke();
                    
                    // –ë–æ–ª—å—à–æ–π –¥–∏–Ω–∞–º–∏–∫ (–≤—É—Ñ–µ—Ä)
                    ctx.beginPath();
                    ctx.arc(0, -15, 30 + (sp.pulse || 0) * 10, 0, Math.PI * 2);
                    const wooferGrad = ctx.createRadialGradient(0, -15, 0, 0, -15, 35);
                    wooferGrad.addColorStop(0, '#222');
                    wooferGrad.addColorStop(0.5, '#111');
                    wooferGrad.addColorStop(0.8, '#333');
                    wooferGrad.addColorStop(1, '#000');
                    ctx.fillStyle = wooferGrad;
                    ctx.fill();
                    ctx.strokeStyle = '#444';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // –¶–µ–Ω—Ç—Ä –¥–∏–Ω–∞–º–∏–∫–∞
                    ctx.beginPath();
                    ctx.arc(0, -15, 12, 0, Math.PI * 2);
                    ctx.fillStyle = '#0a0a0a';
                    ctx.fill();
                    
                    // –ú–∞–ª–µ–Ω—å–∫–∏–π –¥–∏–Ω–∞–º–∏–∫ (—Ç–≤–∏—Ç–µ—Ä)
                    ctx.beginPath();
                    ctx.arc(0, 30, 15 + (sp.pulse || 0) * 5, 0, Math.PI * 2);
                    ctx.fillStyle = '#222';
                    ctx.fill();
                    ctx.strokeStyle = '#555';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // –¶–µ–Ω—Ç—Ä —Ç–≤–∏—Ç–µ—Ä–∞
                    ctx.beginPath();
                    ctx.arc(0, 30, 6, 0, Math.PI * 2);
                    ctx.fillStyle = '#ff00ff';
                    ctx.shadowColor = '#ff00ff';
                    ctx.shadowBlur = 10;
                    ctx.fill();
                    
                    ctx.restore();
                    
                    // –í–æ–ª–Ω—ã –æ—Ç –¥–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–∏ –ø—É–ª—å—Å–∞—Ü–∏–∏
                    if (Math.abs(sp.pulse || 0) > 0.1) {
                        const waveRadius = 50 + Math.sin(Date.now() * 0.01) * 10;
                        ctx.beginPath();
                        ctx.arc(sp.x, sp.y, waveRadius, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(255, 0, 255, 0.3)';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }
            });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –Ω–æ—Ç
        function renderMusicNotes() {
            if (lowGraphics) {
                // LOW MODE: –ü—Ä–æ—Å—Ç—ã–µ –∫—Ä—É–≥–∏ –≤–º–µ—Å—Ç–æ —ç–º–æ–¥–∑–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                ctx.fillStyle = '#ff00ff';
                musicNotes.forEach(note => {
                    ctx.beginPath();
                    ctx.arc(note.x, note.y, note.size * 0.3, 0, Math.PI * 2);
                    ctx.fill();
                });
            } else {
                // –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —Å —ç–º–æ–¥–∑–∏
                musicNotes.forEach(note => {
                    ctx.save();
                    ctx.translate(note.x, note.y);
                    ctx.rotate(note.rotation);
                    ctx.shadowColor = note.color;
                    ctx.shadowBlur = 15;
                    ctx.font = `${note.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = note.color;
                    ctx.fillText(note.icon, 0, 0);
                    ctx.restore();
                });
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function renderMicrophone() {
            ctx.save();
            ctx.translate(finalBoss.x + 60, finalBoss.y);
            
            // –ú–∞—Å—à—Ç–∞–± –ø–æ—è–≤–ª–µ–Ω–∏—è
            const scale = finalBoss.microphoneScale || 1;
            ctx.scale(scale, scale);
            
            // –í—Ä–∞—â–µ–Ω–∏–µ
            ctx.rotate(finalBoss.microphoneRotation || 0);
            
            // –°–≤–µ—á–µ–Ω–∏–µ
            if (!lowGraphics) {
                ctx.shadowColor = '#00ffff';
                ctx.shadowBlur = 20;
            }
            
            // –†–∏—Å—É–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
            renderIcon(ctx, 'üé§', 0, 0, 50);
            
            ctx.shadowBlur = 0;
            ctx.restore();
            
            // –ï—Å–ª–∏ –ø–æ—ë—Ç - –Ω–æ—Ç—ã –≤—ã–ª–µ—Ç–∞—é—Ç –æ—Ç —Ä—Ç–∞ (–ü–û–õ–ù–û–°–¢–¨–Æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ low mode)
            if (finalBoss.singing && !lowGraphics && Math.random() < 0.3) {
                const notes = ['üéµ', 'üé∂', '‚ô™', '‚ô´'];
                particles.push({
                    x: finalBoss.x + 30,
                    y: finalBoss.y - 20,
                    vx: 2 + Math.random() * 3,
                    vy: -2 - Math.random() * 2,
                    radius: 10,
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                    alpha: 1,
                    life: 1,
                    isNote: true,
                    noteIcon: notes[Math.floor(Math.random() * notes.length)]
                });
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ñ–∞–µ—Ä–±–æ–ª–∞ –≤ —Ä—É–∫–µ
        function renderFireball() {
            ctx.save();
            ctx.translate(finalBoss.x + 70, finalBoss.y);
            
            if (lowGraphics) {
                // LOW MODE: –ü—Ä–æ—Å—Ç–æ–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π –∫—Ä—É–≥
                ctx.beginPath();
                ctx.arc(0, 0, 25, 0, Math.PI * 2);
                ctx.fillStyle = '#ff6600';
                ctx.fill();
            } else {
                // –ü—É–ª—å—Å–∞—Ü–∏—è
                const pulse = 1 + Math.sin(Date.now() * 0.01) * 0.2;
                ctx.scale(pulse, pulse);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = '#ff6600';
                ctx.shadowBlur = 40;
                
                // –í–Ω–µ—à–Ω–∏–π –æ–≥–æ–Ω—å
                const fireGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, 35);
                fireGrad.addColorStop(0, 'rgba(255, 255, 200, 1)');
                fireGrad.addColorStop(0.3, 'rgba(255, 200, 50, 0.9)');
                fireGrad.addColorStop(0.6, 'rgba(255, 100, 0, 0.7)');
                fireGrad.addColorStop(1, 'rgba(200, 50, 0, 0)');
                
                ctx.beginPath();
                ctx.arc(0, 0, 35, 0, Math.PI * 2);
                ctx.fillStyle = fireGrad;
                ctx.fill();
                
                // –Ø–¥—Ä–æ
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fillStyle = '#ffffff';
                ctx.fill();
            }
            
            // –ò—Å–∫—Ä—ã –æ—Ç —Ñ–∞–µ—Ä–±–æ–ª–∞
            if (!lowGraphics && Math.random() < 0.4) {
                const angle = Math.random() * Math.PI * 2;
                particles.push({
                    x: finalBoss.x + 70 + Math.cos(angle) * 25,
                    y: finalBoss.y + Math.sin(angle) * 25,
                    vx: Math.cos(angle) * 4 + (Math.random() - 0.5) * 2,
                    vy: Math.sin(angle) * 4 - 2,
                    radius: 3 + Math.random() * 4,
                    color: Math.random() > 0.5 ? '#ff6600' : '#ffff00',
                    alpha: 1,
                    life: 0.5
                });
            }
            
            ctx.restore();
        }
        
        function renderFinalBoss() {
            ctx.save();
            ctx.translate(finalBoss.x, finalBoss.y);
            
            // –ú–∞—Å—à—Ç–∞–± –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ä–µ—á–∏
            if (finalBoss.speaking) {
                // –†–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –∫–∞–∫ –≤ –º—É–ª—å—Ç–∏–∫–∞—Ö
                const scaleX = finalBoss.speakScale;
                const scaleY = 2 - finalBoss.speakScale; // –û–±—Ä–∞—Ç–Ω–æ–µ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ –ø–æ Y
                ctx.scale(scaleX, scaleY);
            }
            
            // –°–≤–µ—á–µ–Ω–∏–µ
            if (!lowGraphics) {
                ctx.shadowColor = finalBoss.isEvil ? '#0066ff' : '#ff0066';
                ctx.shadowBlur = 40;
            }
            
            // –ê—É—Ä–∞ –¥–ª—è –∑–ª–æ–≥–æ –ó–æ–ª–æ (—Å–∏–Ω—è—è –Ω–∞ —Å—Ç–∞–¥–∏–∏ 1, –æ—Ä–∞–Ω–∂–µ–≤–∞—è –Ω–∞ —Å—Ç–∞–¥–∏–∏ 2+)
            if (finalBoss.isEvil) {
                const auraRadius = finalBoss.radius + 30 + Math.sin(Date.now() * 0.003) * 10;
                const auraGrad = ctx.createRadialGradient(0, 0, finalBoss.radius, 0, 0, auraRadius);
                
                if (finalBoss.stage >= 2 || finalBoss.hasWings) {
                    // –û—Ä–∞–Ω–∂–µ–≤–∞—è –∞—É—Ä–∞ –¥–ª—è —Å—Ç–∞–¥–∏–∏ 2
                    auraGrad.addColorStop(0, 'rgba(255, 150, 0, 0.6)');
                    auraGrad.addColorStop(0.5, 'rgba(255, 100, 0, 0.4)');
                    auraGrad.addColorStop(1, 'rgba(200, 50, 0, 0)');
                } else {
                    // –°–∏–Ω—è—è –∞—É—Ä–∞ –¥–ª—è —Å—Ç–∞–¥–∏–∏ 1
                    auraGrad.addColorStop(0, 'rgba(0, 100, 255, 0.5)');
                    auraGrad.addColorStop(0.5, 'rgba(0, 50, 200, 0.3)');
                    auraGrad.addColorStop(1, 'rgba(0, 0, 150, 0)');
                }
                ctx.beginPath();
                ctx.arc(0, 0, auraRadius, 0, Math.PI * 2);
                ctx.fillStyle = auraGrad;
                ctx.fill();
                
                // –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑—Ä—è–¥—ã - –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ low mode
                if (Math.random() < 0.3 && !lowGraphics) {
                    for (let i = 0; i < 3; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const len = finalBoss.radius + 20 + Math.random() * 30;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        let x = 0, y = 0;
                        for (let j = 0; j < 5; j++) {
                            x += Math.cos(angle) * (len / 5) + (Math.random() - 0.5) * 15;
                            y += Math.sin(angle) * (len / 5) + (Math.random() - 0.5) * 15;
                            ctx.lineTo(x, y);
                        }
                        ctx.strokeStyle = `rgba(100, 150, 255, ${0.5 + Math.random() * 0.5})`;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }
            }
            
            // –ê–≤–∞—Ç–∞—Ä–∫–∞
            ctx.beginPath();
            ctx.arc(0, 0, finalBoss.radius, 0, Math.PI * 2);
            ctx.clip();
            
            // –í—ã–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            let img;
            if (finalBoss.stage >= 2 || finalBoss.hasWings) {
                // –°—Ç–∞–¥–∏—è 2+ - –Ω–æ–≤—ã–π —Å–∫–∏–Ω —Å –∫—Ä—ã–ª—å—è–º–∏
                img = zoloStage2Img;
            } else if (finalBoss.isEvil) {
                img = evilZoloImg;
            } else if (finalBoss.speaking) {
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫–∏–Ω –∫–æ–≥–¥–∞ –ò–≤–∞–Ω –≥–æ–≤–æ—Ä–∏—Ç
                img = zoloSpeakingImg;
            } else {
                img = zoloImg;
            }
            
            if (img && img.complete) {
                const size = finalBoss.radius * 2;
                ctx.drawImage(img, -size/2, -size/2, size, size);
            } else {
                ctx.fillStyle = finalBoss.isEvil ? '#0066ff' : '#ff0066';
                ctx.fill();
            }
            
            ctx.restore();
            
            // –û–±–≤–æ–¥–∫–∞ - –æ—Ä–∞–Ω–∂–µ–≤–∞—è –Ω–∞ —Å—Ç–∞–¥–∏–∏ 2+
            ctx.beginPath();
            ctx.arc(finalBoss.x, finalBoss.y, finalBoss.radius, 0, Math.PI * 2);
            ctx.strokeStyle = (finalBoss.stage >= 2 || finalBoss.hasWings) ? '#ff6600' : (finalBoss.isEvil ? '#0066ff' : '#ff0066');
            ctx.lineWidth = 4;
            if (!lowGraphics) {
                ctx.shadowColor = finalBoss.isEvil ? '#0066ff' : '#ff0066';
                ctx.shadowBlur = 20;
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        
        function renderCutsceneEffects() {
            if (cutscene.type === 'teleport' && (cutscene.phase === 1 || cutscene.phase === 2)) {
                const handSize = 90;
                const spread = cutscene.data.handSpread || 0;
                const angle = cutscene.data.handAngle || 0;
                
                // –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏
                if (cutscene.phase === 2 && spread > 20) {
                    ctx.save();
                    ctx.translate(player.x, player.y);
                    
                    // –ú–æ–ª–Ω–∏–∏ –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.moveTo(-spread - 30, 0);
                        let x = -spread - 30;
                        while (x < spread + 30) {
                            x += 20;
                            const y = (Math.random() - 0.5) * 30;
                            ctx.lineTo(x, y);
                        }
                        ctx.strokeStyle = `rgba(180, 100, 255, ${0.5 + Math.random() * 0.5})`;
                        ctx.lineWidth = 2 + Math.random() * 2;
                        ctx.shadowColor = '#bf55ec';
                        ctx.shadowBlur = 15;
                        ctx.stroke();
                    }
                    
                    // –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏—Ü—ã
                    if (cutscene.data.energyParticles) {
                        cutscene.data.energyParticles.forEach(p => {
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            ctx.fillStyle = p.color;
                            ctx.shadowColor = p.color;
                            ctx.shadowBlur = 10;
                            ctx.fill();
                        });
                    }
                    
                    ctx.restore();
                }
                
                // –õ–µ–≤–∞—è —Ä—É–∫–∞
                if (cutscene.data.hand1) {
                    const scale = cutscene.data.hand1Scale || 0;
                    const wobble = Math.sin(Date.now() * 0.01) * 3;
                    
                    ctx.save();
                    ctx.translate(player.x - 60 - spread, player.y + wobble);
                    ctx.scale(scale, scale);
                    ctx.rotate(-0.2 + Math.sin(angle) * 0.1);
                    
                    if (!lowGraphics) {
                        ctx.shadowColor = '#9b59b6';
                        ctx.shadowBlur = 20;
                    }
                    renderIcon(ctx, 'ü§ö', 0, 0, handSize);
                    ctx.shadowBlur = 0;
                    ctx.restore();
                }
                
                // –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞
                if (cutscene.data.hand2) {
                    const scale = cutscene.data.hand2Scale || 0;
                    const wobble = Math.sin(Date.now() * 0.01 + 1) * 3;
                    
                    ctx.save();
                    ctx.translate(player.x + 60 + spread, player.y + wobble);
                    ctx.scale(scale, scale);
                    ctx.rotate(0.2 - Math.sin(angle) * 0.1);
                    
                    if (!lowGraphics) {
                        ctx.shadowColor = '#9b59b6';
                        ctx.shadowBlur = 20;
                    }
                    renderIcon(ctx, '‚úã', 0, 0, handSize);
                    ctx.shadowBlur = 0;
                    ctx.restore();
                }
                
                // –ê—É—Ä–∞ –≤–æ–∫—Ä—É–≥ –∏–≥—Ä–æ–∫–∞
                if (cutscene.phase === 2) {
                    const auraRadius = 50 + Math.sin(Date.now() * 0.01) * 10;
                    const gradient = ctx.createRadialGradient(player.x, player.y, 0, player.x, player.y, auraRadius);
                    gradient.addColorStop(0, 'rgba(155, 89, 182, 0.5)');
                    gradient.addColorStop(1, 'rgba(155, 89, 182, 0)');
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, auraRadius, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
            } else if (cutscene.type === 'teleport' && cutscene.phase === 4) {
                // –≠—Ñ—Ñ–µ–∫—Ç –ø—É–∑—ã—Ä—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏
                if (cutscene.data.bubbleRadius && cutscene.data.bubbleAlpha > 0) {
                    ctx.beginPath();
                    ctx.arc(player.x, player.y, cutscene.data.bubbleRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(52, 152, 219, ${cutscene.data.bubbleAlpha})`;
                    ctx.lineWidth = 4;
                    ctx.shadowColor = '#3498db';
                    ctx.shadowBlur = 20;
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }
            } else if (cutscene.type === 'timestop' && cutscene.phase === 1) {
                // –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤—Å–ø—ã—à–∫–∞ –≤ –Ω–∞—á–∞–ª–µ
                const flashAlpha = Math.max(0, 1 - cutscene.timer * 2);
                if (flashAlpha > 0) {
                    ctx.save();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    ctx.fillStyle = `rgba(138, 43, 226, ${flashAlpha * 0.7})`;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // –Ø—Ä–∫–∏–π —Ü–µ–Ω—Ç—Ä –≤—Å–ø—ã—à–∫–∏
                    const flashGrad = ctx.createRadialGradient(
                        canvas.width/2, canvas.height/2, 0,
                        canvas.width/2, canvas.height/2, 400
                    );
                    flashGrad.addColorStop(0, `rgba(255, 255, 255, ${flashAlpha})`);
                    flashGrad.addColorStop(0.3, `rgba(200, 150, 255, ${flashAlpha * 0.7})`);
                    flashGrad.addColorStop(1, 'rgba(138, 43, 226, 0)');
                    ctx.fillStyle = flashGrad;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.restore();
                }
                
                // –í–æ–ª–Ω—ã ZA WARUDO
                if (cutscene.data.waves) {
                    cutscene.data.waves.forEach(wave => {
                        if (wave.radius > 0) {
                            const alpha = 1 - wave.radius / wave.maxRadius;
                            
                            // –§–∏–æ–ª–µ—Ç–æ–≤—ã–µ –ª—É—á–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
                            for (let i = 0; i < 12; i++) {
                                const angle = (i / 12) * Math.PI * 2 + Date.now() * 0.001;
                                const len = wave.radius;
                                const wobble = Math.sin(Date.now() * 0.005 + i) * 5;
                                
                                // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –ª—É—á
                                const rayGrad = ctx.createLinearGradient(
                                    player.x, player.y,
                                    player.x + Math.cos(angle) * len,
                                    player.y + Math.sin(angle) * len
                                );
                                rayGrad.addColorStop(0, `rgba(255, 200, 255, ${alpha})`);
                                rayGrad.addColorStop(0.3, `rgba(180, 100, 255, ${alpha * 0.8})`);
                                rayGrad.addColorStop(1, `rgba(138, 43, 226, 0)`);
                                
                                ctx.beginPath();
                                ctx.moveTo(player.x, player.y);
                                ctx.lineTo(
                                    player.x + Math.cos(angle) * len + wobble,
                                    player.y + Math.sin(angle) * len + wobble
                                );
                                ctx.strokeStyle = rayGrad;
                                ctx.lineWidth = 10 - (wave.radius / wave.maxRadius) * 6;
                                ctx.lineCap = 'round';
                                ctx.shadowColor = '#bf55ec';
                                ctx.shadowBlur = 20;
                                ctx.stroke();
                            }
                            
                            // –û—Å–Ω–æ–≤–Ω–∞—è –≤–æ–ª–Ω–∞ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
                            ctx.beginPath();
                            ctx.arc(player.x, player.y, wave.radius, 0, Math.PI * 2);
                            const waveGrad = ctx.createRadialGradient(
                                player.x, player.y, wave.radius - 10,
                                player.x, player.y, wave.radius + 10
                            );
                            waveGrad.addColorStop(0, 'rgba(138, 43, 226, 0)');
                            waveGrad.addColorStop(0.5, `rgba(180, 100, 255, ${alpha})`);
                            waveGrad.addColorStop(1, 'rgba(138, 43, 226, 0)');
                            ctx.strokeStyle = waveGrad;
                            ctx.lineWidth = 8;
                            ctx.stroke();
                            
                            // –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ –≤–æ–ª–Ω—ã
                            ctx.beginPath();
                            ctx.arc(player.x, player.y, wave.radius * 0.95, 0, Math.PI * 2);
                            ctx.strokeStyle = `rgba(255, 200, 255, ${alpha * 0.5})`;
                            ctx.lineWidth = 3;
                            ctx.stroke();
                        }
                    });
                }
                
                ctx.shadowBlur = 0;
                
                // –¢–µ–∫—Å—Ç
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#fff';
                ctx.shadowColor = '#8a2be2';
                ctx.shadowBlur = 20;
                ctx.fillText('‚è±Ô∏è –í–†–ï–ú–Ø –û–°–¢–ê–ù–û–í–õ–ï–ù–û', player.x, player.y - 100);
                ctx.shadowBlur = 0;
            }
        }
        
        // ==================== DEV MENU ====================
        let devMenuOpen = false;
        
        function toggleDevMenu() {
            devMenuOpen = !devMenuOpen;
            document.getElementById('devMenu').classList.toggle('show', devMenuOpen);
            document.body.classList.toggle('in-dev', devMenuOpen);
            
            if (devMenuOpen && pointerLocked) {
                document.exitPointerLock();
            }
        }
        
        function devLog(msg) {
            const log = document.getElementById('devLog');
            const time = new Date().toLocaleTimeString();
            log.innerHTML = `[${time}] ${msg}<br>` + log.innerHTML;
            if (log.children.length > 50) {
                log.innerHTML = log.innerHTML.split('<br>').slice(0, 50).join('<br>');
            }
        }
        
        // Dev menu buttons
        document.getElementById('devClose').addEventListener('click', toggleDevMenu);
        document.getElementById('devDash').addEventListener('click', () => { if (gameState === 'playing') useDash(); });
        document.getElementById('devSmoke').addEventListener('click', () => { if (gameState === 'playing') useSmoke(); });
        document.getElementById('devTeleport').addEventListener('click', () => { if (gameState === 'playing') useTeleport(); });
        document.getElementById('devTimestop').addEventListener('click', () => { if (gameState === 'playing') useTimestop(); });
        document.getElementById('devMellstroy').addEventListener('click', () => { if (gameState === 'playing') startEvent('mellstroy'); });
        document.getElementById('devZhiragedon').addEventListener('click', () => { if (gameState === 'playing') startEvent('zhiragedon'); });
        document.getElementById('devFinalBoss').addEventListener('click', () => { if (gameState === 'playing') startFinalBoss(); });
        document.getElementById('devShield').addEventListener('click', () => { player.shield = Math.min(3, player.shield + 1); devLog('+–©–∏—Ç'); });
        document.getElementById('devSpeed').addEventListener('click', () => { player.effects.speed = 10; devLog('+–°–∫–æ—Ä–æ—Å—Ç—å'); });
        document.getElementById('devInvis').addEventListener('click', () => { player.effects.invisible = 10; devLog('+–ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å'); });
        document.getElementById('devFreeze').addEventListener('click', () => { player.effects.freeze = 10; devLog('+–ó–∞–º–æ—Ä–æ–∑–∫–∞'); });
        document.getElementById('devCoins').addEventListener('click', () => { score += 100; devLog('+100 –º–æ–Ω–µ—Ç'); });
        document.getElementById('devGodMode').addEventListener('click', function() {
            godMode = !godMode;
            this.textContent = `üî± God Mode: ${godMode ? 'ON' : 'OFF'}`;
            devLog(`God Mode: ${godMode}`);
        });
        document.getElementById('devLowMode').addEventListener('click', function() {
            lowGraphics = !lowGraphics;
            this.textContent = `üñ•Ô∏è Low Graphics: ${lowGraphics ? 'ON' : 'OFF'}`;
            initBgParticles();
            devLog(`Low Graphics: ${lowGraphics}`);
        });
        
        // –ê—Ä–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∏
        let testArenaActive = false;
        let testArenaEnemy = { x: 400, y: 300, radius: 40, angle: 0 };
        let testArenaPlayer = { x: 600, y: 400 };
        
        document.getElementById('devTestArena').addEventListener('click', function() {
            document.getElementById('testArena').style.display = 'block';
            testArenaActive = true;
            toggleDevMenu();
            initTestArena();
        });
        
        document.getElementById('closeTestArena').addEventListener('click', function() {
            document.getElementById('testArena').style.display = 'none';
            testArenaActive = false;
        });
        
        document.getElementById('devTestGif').addEventListener('click', function() {
            useGifSkin = !useGifSkin;
            devLog(`GIF —Å–∫–∏–Ω: ${useGifSkin ? '–í–ö–õ' : '–í–´–ö–õ'}`);
        });
        
        document.getElementById('devGifOn').addEventListener('click', function() {
            useGifSkin = true;
            devLog('GIF —Å–∫–∏–Ω: –í–ö–õ');
        });
        
        document.getElementById('devGifOff').addEventListener('click', function() {
            useGifSkin = false;
            devLog('GIF —Å–∫–∏–Ω: –í–´–ö–õ');
        });
        
        document.getElementById('devSpawnFood').addEventListener('click', function() {
            if (gameState === 'playing') {
                spawnHealthyFood();
                devLog('–°–ø–∞–≤–Ω –µ–¥—ã');
            }
        });
        
        document.getElementById('devSpawnWings').addEventListener('click', function() {
            if (gameState === 'playing' && toha.active) {
                tohaThrowKfc();
                devLog('–°–ø–∞–≤–Ω KFC –∫—Ä—ã–ª—ã—à–µ–∫');
            } else {
                devLog('–ù—É–∂–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –±–æ—Å—Å –¢–æ—Ö–∞');
            }
        });
        
        // –§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å - –¥–µ–±–∞–≥ –∫–Ω–æ–ø–∫–∏
        document.getElementById('devSkipCutscene').addEventListener('click', function() {
            if (eventSystem.type === 'finalBoss' && eventSystem.phase < 4) {
                // –°–∫–∏–ø–∞–µ–º –∫–∞—Ç—Å—Ü–µ–Ω—É - —Å—Ä–∞–∑—É –∫ –±–æ—é
                eventSystem.phase = 4;
                eventSystem.timer = 0;
                finalBoss.fightStarted = true;
                finalBoss.isEvil = true;
                finalBoss.speaking = false;
                finalBoss.flashWhite = 0;
                finalBoss.grayscale = 0;
                finalBoss.lettersShown = 4;
                finalBoss.bossBarShown = true;
                player.canMove = true;
                
                // –ü–æ–∑–∏—Ü–∏–∏
                finalBoss.x = canvas.width / 2;
                finalBoss.y = 150;
                player.x = canvas.width / 2;
                player.y = canvas.height - 150;
                player.targetX = player.x;
                player.targetY = player.y;
                
                // UI
                document.getElementById('finalBossOverlay').style.filter = 'none';
                document.getElementById('finalBossLetters').classList.add('show');
                document.querySelectorAll('.boss-letter').forEach(l => {
                    l.style.opacity = '1';
                    l.style.transform = 'scale(1)';
                });
                document.getElementById('finalBossBar').style.display = 'block';
                document.getElementById('blueAura').classList.add('active');
                
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                playMusic('stage1Music', 0.5);
                finalBoss.attackTimer = 2;
                
                devLog('–ö–∞—Ç—Å—Ü–µ–Ω–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ - –ë–û–ô!');
            } else if (finalBoss.stage2Cutscene) {
                // –°–∫–∏–ø–∞–µ–º –∫–∞—Ç—Å—Ü–µ–Ω—É —Å—Ç–∞–¥–∏–∏ 2
                finalBoss.stage2Cutscene = false;
                finalBoss.stage = 2;
                finalBoss.hasWings = true;
                finalBoss.onFire = false;
                finalBoss.screaming = false;
                finalBoss.orangeFlash = 0;
                stage2Wings = { left: 1, right: 1, angle: 0, flapAngle: 0 };
                fireParticles = [];
                
                finalBoss.x = canvas.width / 2;
                finalBoss.y = 120;
                player.x = canvas.width / 2;
                player.y = canvas.height - 120;
                player.targetX = player.x;
                player.targetY = player.y;
                
                camera.targetZoom = 1;
                camera.targetX = 0;
                camera.targetY = 0;
                
                devLog('–ö–∞—Ç—Å—Ü–µ–Ω–∞ —Å—Ç–∞–¥–∏–∏ 2 –ø—Ä–æ–ø—É—â–µ–Ω–∞!');
            } else {
                devLog('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ç—Å—Ü–µ–Ω—ã –¥–ª—è —Å–∫–∏–ø–∞');
            }
        });
        
        document.getElementById('devBossStage1').addEventListener('click', function() {
            if (eventSystem.type === 'finalBoss') {
                finalBoss.stage = 1;
                finalBoss.hasWings = false;
                finalBoss.stageTransition = false;
                finalBoss.health = finalBoss.maxHealth;
                document.querySelector('#finalBossBar .fill').style.width = '100%';
                devLog('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞–¥–∏—è 1');
            } else {
                devLog('–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
            }
        });
        
        document.getElementById('devBossStage2').addEventListener('click', function() {
            if (eventSystem.type === 'finalBoss') {
                finalBoss.stage = 2;
                finalBoss.hasWings = true;
                finalBoss.stageTransition = false;
                stage2Wings = { left: 1, right: 1, angle: 0, flapAngle: 0 };
                devLog('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞–¥–∏—è 2 (–∫—Ä—ã–ª—å—è)');
            } else {
                devLog('–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
            }
        });
        
        document.getElementById('devBossHP50').addEventListener('click', function() {
            if (eventSystem.type === 'finalBoss') {
                finalBoss.health = finalBoss.maxHealth * 0.5;
                const hpPercent = (finalBoss.health / finalBoss.maxHealth) * 100;
                document.querySelector('#finalBossBar .fill').style.width = hpPercent + '%';
                devLog(`HP –±–æ—Å—Å–∞ = ${finalBoss.health}/${finalBoss.maxHealth} (50%)`);
            } else {
                devLog('–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
            }
        });
        
        document.getElementById('devBossHP25').addEventListener('click', function() {
            if (eventSystem.type === 'finalBoss') {
                finalBoss.health = finalBoss.maxHealth * 0.25;
                const hpPercent = (finalBoss.health / finalBoss.maxHealth) * 100;
                document.querySelector('#finalBossBar .fill').style.width = hpPercent + '%';
                devLog(`HP –±–æ—Å—Å–∞ = ${finalBoss.health}/${finalBoss.maxHealth} (25%)`);
            } else {
                devLog('–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
            }
        });

        const triggerBossAttack = (attackFn) => {
            if (eventSystem.type === 'finalBoss' && finalBoss.fightStarted) {
                // –°–±—Ä–æ—Å —Ç–µ–∫—É—â–∏—Ö –∞—Ç–∞–∫
                finalBoss.currentAttack = null;
                finalBoss.handsVisible = false;
                finalBoss.hasMicrophone = false;
                speakerAttack.active = false;
                fireCircleAttack.active = false;
                batyas = [];
                batyaLasers = [];
                speakers = [];
                musicNotes = [];
                fireCircles = [];
                
                attackFn();
            } else {
                devLog('–ë–æ—Å—Å –Ω–µ –≤ —Ñ–∞–∑–µ –±–æ—è');
            }
        };

        document.getElementById('devBossAttack1').addEventListener('click', () => triggerBossAttack(startCensoredMissileAttack));
        document.getElementById('devBossAttack2').addEventListener('click', () => triggerBossAttack(startBatyaAttack));
        document.getElementById('devBossAttack3').addEventListener('click', () => triggerBossAttack(startSpeakerAttack));
        document.getElementById('devBossAttack4').addEventListener('click', () => triggerBossAttack(startFireCircleAttack));
        document.getElementById('devBossAttackCar').addEventListener('click', () => triggerBossAttack(startCarAttack));
        document.getElementById('devBossAttackLabyrinth').addEventListener('click', () => triggerBossAttack(startLabyrinthAttack));
        document.getElementById('devBossAttackFirePlatform').addEventListener('click', () => triggerBossAttack(startFirePlatformAttack));
        
        // –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–ø–∞ –∏–≤–µ–Ω—Ç–∞
        document.getElementById('devSkipEvent').addEventListener('click', function() {
            if (eventSystem.active) {
                if (eventSystem.type === 'mellstroy' || eventSystem.type === 'zhiragedon') {
                    endEvent();
                    devLog(`–ò–≤–µ–Ω—Ç ${eventSystem.type} –ø—Ä–æ–ø—É—â–µ–Ω!`);
                } else if (eventSystem.type === 'finalBoss') {
                    devLog('–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Å—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ —ç—Ç—É –∫–Ω–æ–ø–∫—É');
                }
            } else {
                devLog('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–≤–µ–Ω—Ç–∞');
            }
        });
        
        // –¢–µ—Å—Ç–æ–≤–∞—è –∞—Ä–µ–Ω–∞
        function initTestArena() {
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // –°–ª–µ–¥–∏–º –∑–∞ –º—ã—à—å—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            document.getElementById('testArena').addEventListener('mousemove', (e) => {
                testArenaPlayer.x = e.clientX;
                testArenaPlayer.y = e.clientY;
            });
            
            function renderTestArena() {
                if (!testArenaActive) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // –§–æ–Ω
                const grad = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, 500);
                grad.addColorStop(0, '#1a1a2e');
                grad.addColorStop(1, '#0a0a15');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // –°–µ—Ç–∫–∞
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                for (let x = 0; x < canvas.width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y < canvas.height; y += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –∏–≥—Ä–æ–∫
                ctx.beginPath();
                ctx.arc(testArenaPlayer.x, testArenaPlayer.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = '#00d4ff';
                ctx.shadowColor = '#00d4ff';
                ctx.shadowBlur = 20;
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –≤—Ä–∞–≥ —Å GIF –∏ –ø–æ–≤–æ—Ä–æ—Ç–æ–º
                ctx.save();
                ctx.translate(testArenaEnemy.x, testArenaEnemy.y);
                
                // –ü–æ–≤–æ—Ä–æ—Ç –≥–æ–ª–æ–≤–æ–π –∫ –∏–≥—Ä–æ–∫—É
                const angleToPlayer = Math.atan2(testArenaPlayer.y - testArenaEnemy.y, testArenaPlayer.x - testArenaEnemy.x);
                ctx.rotate(angleToPlayer + Math.PI / 2);
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = '#ff0066';
                ctx.shadowBlur = 30;
                
                // –ê–≤–∞—Ç–∞—Ä–∫–∞
                ctx.beginPath();
                ctx.arc(0, 0, testArenaEnemy.radius, 0, Math.PI * 2);
                ctx.clip();
                
                const img = useGifSkin && zoloGifImg.complete ? zoloGifImg : zoloImg;
                if (img.complete) {
                    const size = testArenaEnemy.radius * 2;
                    ctx.drawImage(img, -size/2, -size/2, size, size);
                } else {
                    ctx.fillStyle = '#ff0066';
                    ctx.fill();
                }
                
                ctx.restore();
                
                // –û–±–≤–æ–¥–∫–∞
                ctx.beginPath();
                ctx.arc(testArenaEnemy.x, testArenaEnemy.y, testArenaEnemy.radius, 0, Math.PI * 2);
                ctx.strokeStyle = '#ff0066';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                ctx.fillStyle = '#fff';
                ctx.font = '16px Arial';
                ctx.fillText(`GIF —Å–∫–∏–Ω: ${useGifSkin ? '–í–ö–õ' : '–í–´–ö–õ'}`, 20, canvas.height - 60);
                ctx.fillText(`–£–≥–æ–ª –∫ –∏–≥—Ä–æ–∫—É: ${(angleToPlayer * 180 / Math.PI).toFixed(1)}¬∞`, 20, canvas.height - 40);
                ctx.fillText('–î–≤–∏–≥–∞–π –º—ã—à—å—é - –≤—Ä–∞–≥ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∫ —Ç–µ–±–µ', 20, canvas.height - 20);
                
                requestAnimationFrame(renderTestArena);
            }
            
            renderTestArena();
        }
        
        // ESC –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –∞—Ä–µ–Ω—É
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && testArenaActive) {
                document.getElementById('testArena').style.display = 'none';
                testArenaActive = false;
            }
        });
        
        // ==================== –°–û–ë–´–¢–ò–Ø ====================
        // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                startGame(btn.dataset.diff);
            });
        });
        
        document.getElementById('ctrlCursor').addEventListener('click', function() {
            controlType = 'cursor';
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
        
        document.getElementById('ctrlWASD').addEventListener('click', function() {
            controlType = 'wasd';
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
        
        document.getElementById('soundBtn').addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? 'üîä –ó–≤—É–∫: –í–ö–õ' : 'üîá –ó–≤—É–∫: –í–´–ö–õ';
            if (!soundEnabled) stopMusic();
        });
        
        document.getElementById('retryBtn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('gameOver').classList.remove('show');
            startGame(difficulty);
        });
        
        document.getElementById('menuBtn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showMenu();
        });
        
        // –ö–Ω–æ–ø–∫–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π (—Ö–æ—Ç–±–∞—Ä)
        document.querySelectorAll('.hotbar-slot').forEach(slot => {
            slot.addEventListener('click', () => {
                if (gameState === 'playing') {
                    useSkill(slot.dataset.skill);
                }
            });
        });
        
        // ==================== GAME LOOP ====================
        let lastTime = 0;
        
        function gameLoop(timestamp) {
            const dt = Math.min((timestamp - lastTime) / 1000, 0.1);
            lastTime = timestamp;
            
            update(dt);
            render();
            
            requestAnimationFrame(gameLoop);
        }
        
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
